<link rel="import" href="../bower_components/polymer-fx/fx-http-behavior.html">
<script src="websocket-request-service.js"></script>
<script>

  (_ => {
    let { HttpRequestService, WebsocketRequestService, ServiceManager } = window.ServiceTree;

    const WEBSOCKET_DELAY_BEFORE_RETRYING = 30 * 1000;
    let lastWebsocketFailureTimestamp = 0;

    if (!window.TorqueHttpBehavior) {
      /* @polymerMixin */
      window.TorqueHttpBehavior = (SuperClass) => class extends FxHttpBehavior(SuperClass) {

        constructor(...args) {
          super(...args);
          this.websocketHost = 'ws://localhost:8000';
          this.websocketApiPathPrefix = '/api/';
        }

        // internals ===================================

        callJsonWebsocketApi(path, data, cbfn) {
          let url = `${this.websocketApiPathPrefix}${path}`
          let service = new WebsocketRequestService(this.websocketHost, url, { responseType: 'json' });
          service.on('end', (event) => {
            if (event.detail.resolution === 'success') {
              cbfn(null, event.detail.body);
            } else {
              cbfn(event.detail);
            }
          });
          service.on('error', (event) => {
            // suppress the event so that it does not bubble to service manager
            event.bubbles = false;
          });
          baselib.setImmediate(_ => service.request('json', data));
          this.serviceManager.manage(service);
          return service;
        }

        callCombinedJsonApi(path, data, cbfn) {
          let now = (new Date).getTime();
          console.log()
          if (!this.settings.shouldUseWebsockets || (now - lastWebsocketFailureTimestamp < WEBSOCKET_DELAY_BEFORE_RETRYING)) {
            this.callJsonPostApi(path, data, cbfn);
          } else {
            this.callJsonWebsocketApi(path, data, (err, message) => {
              if (err) {
                lastWebsocketFailureTimestamp = (new Date).getTime();
                this.callJsonPostApi(path, data, cbfn);
              } else {
                cbfn(null, message);
              }
            })
          }
        }

        // api call utls ===================================

        _applyApiKey(data) {
          if ('user' in this && 'apiKey' in this.user) {
            data.apiKey = this.user.apiKey;
            return true;
          } else {
            this.showAlertMessage("No Api Key");
            return false;
          }
        }

        // api calls ===================================

        callUserRegisterApi(data, cbfn) {
          this.callCombinedJsonApi('user-register', data, cbfn);
        }

        callUserLoginApi(data, cbfn) {
          this.callCombinedJsonApi('user-login', data, cbfn);
        }

        callUserLogoutApi(data, cbfn) {
          if (!this._applyApiKey(data)) return;
          this.callCombinedJsonApi('user-logout', data, cbfn);
        }

        callGetOrganizationListApi(data, cbfn) {
          if (!this._applyApiKey(data)) return;
          this.callCombinedJsonApi('get-organization-list', data, cbfn);
        }

        callAddOrganizationApi(data, cbfn) {
          if (!this._applyApiKey(data)) return;
          this.callCombinedJsonApi('add-organization', data, cbfn);
        }

        callGetDashboardSummaryApi(data, cbfn) {
          if (!this._applyApiKey(data)) return;
          this.callCombinedJsonApi('get-dashboard-summary', data, cbfn);
        }

      }
    }
  })();

</script>