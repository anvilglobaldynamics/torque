<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">

<link rel="import" href="../bower_components/baselib/baselib.html">

<link rel="import" href="../bower_components/polymer-fx/fx-page.html">
<link rel="import" href="../bower_components/polymer-fx/fx-common-behavior.html">

<link rel="import" href="view-user.html">

<link rel="import" href="my-swipe-behavior.html">

<link rel="import" href="shared-styles.html">

<dom-module id="page-settings">
  <template>
    <style include="shared-styles">
      @media (min-width: 960px) {
         :host {
          display: block;
          padding-top: 24px;
        }
      }

      paper-tabs.view-selector {
        --paper-tabs: {
          background-color: var(--app-primary-color);
          color: white;
        }
      }

      .wrapper {
        max-width: 960px;
        margin: 0 auto;
      }

      .export-area {
        padding: 40px;
        text-align: center;
      }

      paper-button.primary {
        background: var(--app-primary-color);
        color: white;
      }

      .exported-data {
        padding: 10px;
        font-family: monospace;
        max-height: 620px;
        overflow: scroll;
      }

      #wrapper {
        min-height: 100vh;
      }

      .card {
        margin: 8px;
      }

      .option {
        margin-top: 12px;
        margin-bottom: 12px;
      }

      .note {
        margin-top: 8px;
        font-size: smaller;
        color: #616161;
      }

      .button-row {
        margin-top: 12px;
      }
    </style>

    <div class="wrapper layout vertical" id="wrapper">

      <paper-tabs id="main-view-selector" class="view-selector" selected="{{paperTabSelectedViewIndex}}" fit-container>
        <paper-tab>General</paper-tab>
        <paper-tab>Sync/Account</paper-tab>
        <paper-tab>Backup/Recovery</paper-tab>
      </paper-tabs>

      <template is="dom-if" if="[[$equals(paperTabSelectedViewIndex, 0)]]">
        <div class="card vertical layout">
          <div class="option">
            <paper-checkbox on-change="showHiddenChanged" checked="{{shouldShowHidden}}">Should Show hidden</paper-checkbox>
            <div class="note">
              If checked, all hidden history, tasks and pleasures will become visible.
            </div>
          </div>

          <div class="option">
            <paper-checkbox on-change="allowDeletionhanged" checked="{{shouldAllowDeletion}}">Allow deletion</paper-checkbox>
            <div class="note">
              If checked, deleting history will be allowed.
            </div>
          </div>

        </div>
      </template>

      <view-user is-active="[[$equals(paperTabSelectedViewIndex, 1)]]"></view-user>

      <template is="dom-if" if="[[$equals(paperTabSelectedViewIndex, 2)]]">

        <template is="dom-if" if="[[!_exportedData]]">
          <div class="export-area">
            <paper-button raised class="primary" on-tap="exportDataTapped">Export Data</paper-button>
            <br><br><br>
            <paper-button raised class="primary" on-tap="resetDataTapped">Export and Reset Data</paper-button>
          </div>
        </template>

        <template is="dom-if" if="[[_exportedData]]">
          <div class="exported-data">
            [[_exportedData]]
          </div>
        </template>
      </template>

  </template>

  <script>
    class PageSettings extends FxPage.mixin(MySwipeBehavior, FxCommonBehavior) {
      static get is() {
        return 'page-settings';
      }

      static get properties() {
        return {
          _exportedData: { type: String, value: null },
          shouldShowHidden: { type: Boolean, value: false },
          shouldAllowDeletion: { type: Boolean, value: false },
          paperTabSelectedViewIndex: { type: Number, value: 0, observer: '_paperTabSelectedViewIndexChanged' },
        };
      }

      // region: ui consistency ===========================

      _loadLastPaperTabSelectedViewIndex() {
        let paperTabSelectedViewIndex = sessionStorage.getItem('page-setting:paperTabSelectedViewIndex');
        if (paperTabSelectedViewIndex !== null) {
          paperTabSelectedViewIndex = JSON.parse(paperTabSelectedViewIndex);
          if (typeof (paperTabSelectedViewIndex) === 'number') {
            this.paperTabSelectedViewIndex = paperTabSelectedViewIndex;
          }
        }
      }

      _paperTabSelectedViewIndexChanged() {
        if (typeof (this.paperTabSelectedViewIndex) !== 'number') {
          return;
        }
        sessionStorage.setItem('page-setting:paperTabSelectedViewIndex', JSON.stringify(this.paperTabSelectedViewIndex));
      }
      // region: core =================================

      constructor() {
        super();
        this.confirmPageReady()
      }

      onFirstNavigation() {
        super.onFirstNavigation();
        baselib.delay(50, _ => {
          this.detectPageSwipe(this.$['wrapper'], (this.wrapperSwiped.bind(this)))
        });
      }

      onNextNavigation() {
        super.onNextNavigation();
      }

      onNavigateIn() {
        this.app.shouldShowSaveButton = false;
        this.app.currentPageIsModal = false;
        this.paperTabSelectedViewIndex = 0;
        let settings = this.app.db.find('settings', (({ which }) => which === 'only'))[0];
        this.shouldShowHidden = settings.shouldShowHidden
        this.shouldAllowDeletion = settings.shouldAllowDeletion
        this._loadLastPaperTabSelectedViewIndex()
      }

      onNavigateOut() {
        super.onNavigateOut();
        this._exportedData = null;
      }

      // region: general settinggs =================================

      showHiddenChanged(e) {
        this.app.db.update('settings', ({ which }) => which === 'only', (doc) => {
          doc.shouldShowHidden = this.shouldShowHidden;
          return doc
        });
      }

      allowDeletionhanged(e) {
        this.app.db.update('settings', ({ which }) => which === 'only', (doc) => {
          doc.shouldAllowDeletion = this.shouldAllowDeletion;
          return doc
        });
      }

      // region: export/import =================================

      _collectDataFromDatabase() {
        let data = {};
        let collectionNameList = ['task', 'pleasure', 'transaction', 'status']
        for (let collectionName of collectionNameList) {
          data[collectionName] = this.app.db.find(collectionName);
        }
        return data;
      }

      exportDataTapped(e) {
        let data = this._collectDataFromDatabase();
        data = JSON.stringify(data, null, 2);
        this._exportedData = data;
        this._createDownloadableFile(data);
      }

      _createDownloadableFile(content) {
        var blob = new Blob([content]);
        var objectURL = window.URL.createObjectURL(blob, { type: 'text/json' });
        var identifier = 'rewardables-data.json';
        var a = window.document.createElement('a');
        a.href = objectURL;
        a.target = "_blank";
        a.download = identifier;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }

      resetDataTapped(e) {
        this.app.showModalConfirmation("Are you sure?", "Are you sure to erase everything? This is irreverible unless you have a backup.", (answer) => {
          if (answer) {
            this.exportDataTapped(null);
            this._clearLocalStorage();
            baselib.delay(1000, _ => {
              this.app.navigateTo('home');
              window.location.reload();
            });
          }
        })
      }

      _clearLocalStorage() {
        localStorage.clear();
      }

      // region: misc =================================

      wrapperSwiped(direction) {
        if (direction === 'left') {
          if (this.paperTabSelectedViewIndex < 2) {
            this.paperTabSelectedViewIndex += 1;
          }
        } else if (direction === 'right') {
          if (this.paperTabSelectedViewIndex > 0) {
            this.paperTabSelectedViewIndex -= 1;
          }
        }
      }

    }

    window.customElements.define(PageSettings.is, PageSettings);
  </script>
</dom-module>