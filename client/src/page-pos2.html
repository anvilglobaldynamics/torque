<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">

<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">

<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bower_components/iron-input/iron-input.html">

<link rel="import" href="../bower_components/baselib/baselib.html">

<link rel="import" href="../bower_components/polymer-fx/fx-page.html">
<link rel="import" href="../bower_components/polymer-fx/fx-common-behavior.html">

<link rel="import" href="torque-db-behavior.html">
<link rel="import" href="torque-common-behavior.html">
<link rel="import" href="torque-page-behavior.html">
<link rel="import" href="torque-language-behavior.html">

<link rel="import" href="shared-styles.html">

<link rel="import" href="elem-customer-selector.html">

<dom-module id="page-pos2">
  <template>
    <style include="shared-styles">
      :host {
        font-size: 14px;
      }

      select-product-button-container paper-button {
        width: 100%;
        margin: 5px;
      }

      .individual-calculation-field-container {
        border: 1px solid #eee;
        background-color: #f7f7f7;
        padding: 6px;
        margin: 8px 0px;
      }

      .individual-calculation-field-container.light {
        background-color: white;
      }

      .full-width-paper-dropdown {
        width: 100%;
      }

      .height-adjusted {
        margin-top: -14px;
      }

      .product-title {
        font-weight: bold;
      }

      .product-discount-vat-detail {
        font-size: 11px;
      }

      .service-info {
        flex: 1;
        /* border: 1px solid blue; */
      }

      .service-title {
        font-weight: bold;
      }

      .service-vat-detail {
        font-size: 11px;
        margin-left: 6px;
      }

      .service-customer-required {
        font-size: 11px;
        font-weight: bold;
      }

      .employee-icon-container {
        padding: 10px;
      }

      .employee-icon-container-active {
        padding: 10px;
        color: var(--app-button-primary);
      }

      .assign-icon {
        margin-right: 4px;
      }

      .m-top-16 {
        margin-top: 16px;
      }

      .m-bottom-18 {
        margin-bottom: 18px;
      }

      .card.warning {
        background: var(--app-button-alternative);
      }

      .bold-customer-card-title {
        font-weight: bold;
      }

      .column {
        min-width: 320px;
        min-height: 70vh;
        background: #e1f5fe;
        position: relative;
        margin-left: 2px;
        margin-right: 2px;
      }

      .placeholder {
        background: #afafaf;
        padding: 12px;
        text-align: center;
      }

      paper-tabs.view-selector {
        --paper-tabs: {
          background-color: var(--app-primary-color);
          color: white;
        }
      }

      .multi-column-header-row {}

      .multi-column-header {
        cursor: pointer;
        text-align: center;
        margin: 16px 0;
        text-decoration: underline;
      }

      .single-column-tabs-row {}

      .single-column-tab {
        cursor: pointer;
        text-align: center;
        margin: 16px 0;
      }

      .single-column-tab.selected {
        text-decoration: underline;
      }

      .product-count-input {
        --paper-input-container-color: var(--app-primary-color);
      }
    </style>

    <elem-not-ready is-ready="[[isReady]]"></elem-not-ready>

    <div class$="page-fullwidth layout vertical [[$if(isReady, '', 'hidden')]]" id="wrapper">

      <!-- header - start -->

      <!-- header - Multi Column - Start -->
      <template is="dom-if" if="[[isMultiColumn]]">
        <div class="horizontal layout multi-column-header-row">
          <template is="dom-if" if="[[$equals('undecided', salesType)]]">
            <div class="flex multi-column-header">Selection</div>
          </template>
          <template is="dom-if" if="[[$equals('services', salesType)]]">
            <div class="flex multi-column-header">Services</div>
          </template>
          <template is="dom-if" if="[[$equals('products', salesType)]]">
            <div class="flex multi-column-header">Products</div>
          </template>
          <div class="flex multi-column-header">Customer</div>
          <div class="flex multi-column-header">Payment</div>
        </div>
      </template>
      <!-- header - Multi Column - End -->

      <!-- header - Single Column - Start -->
      <template is="dom-if" if="[[!isMultiColumn]]">
        <div class="horizontal layout single-column-tabs-row">

          <template is="dom-if" if="[[$equals('undecided', salesType)]]">
            <div class$="flex single-column-tab [[$getTabSelectedClass('selection', selectedTabName)]]" data-key="selection" on-tap="singleColumnTabTapped">Selection</div>
          </template>

          <template is="dom-if" if="[[$equals('products', salesType)]]">
            <div class$="flex single-column-tab [[$getTabSelectedClass('products', selectedTabName)]]" data-key="products" on-tap="singleColumnTabTapped">Products</div>
          </template>

          <template is="dom-if" if="[[$equals('services', salesType)]]">
            <div class$="flex single-column-tab [[$getTabSelectedClass('services', selectedTabName)]]" data-key="services" on-tap="singleColumnTabTapped">Services</div>
          </template>

          <div class$="flex single-column-tab [[$getTabSelectedClass('customer', selectedTabName)]]" data-key="customer" on-tap="singleColumnTabTapped">Customer</div>
          <div class$="flex single-column-tab [[$getTabSelectedClass('payment', selectedTabName)]]" data-key="payment" on-tap="singleColumnTabTapped">Payment</div>
        </div>
      </template>
      <!-- header - Single Column - End -->

      <!-- header - end -->

      <!-- columns - Start -->
      <div class="horizontal layout">

        <!-- selection column - start -->
        <div class$="column flex [[$getColumnClasses('selection', 'real', isMultiColumn, selectedTabName, productList.length, serviceList.length, customer, isAnonymousSale, isInOfflineMode)]]">

          <div class="card vertical layout">
            <paper-button raised class="primary" on-tap="salesTypeIsProductsTapped" style="margin-bottom: 8px;">
              Product Sales
            </paper-button>
            <paper-button raised class="primary" on-tap="salesTypeIsServicesTapped" style="margin-bottom: 8px;">
              Service Sales
            </paper-button>

          </div>
        </div>
        <!-- selection column - end -->

        <!-- services column - start -->
        <div class$="column flex [[$getColumnClasses('services', 'real', isMultiColumn, selectedTabName, productList.length, serviceList.length, customer, isAnonymousSale, isInOfflineMode)]]">

          <!-- service searchbar - start -->
          <div class="card vertical layout">
            <div class="horizontal layout center">
              <paper-input id="service-search-field" class="flex" value="{{serviceSearchString}}" always-float-label label="[[verses.posSelectService.searchForServiceInput]]" on-keydown="productSearchFieldKeypressed"></paper-input>
              <template is="dom-if" if="[[!matchingServiceList.length]]">
                <paper-icon-button icon="search" on-tap="serviceSearchTapped"></paper-icon-button>
              </template>
              <template is="dom-if" if="[[matchingServiceList.length]]">
                <paper-icon-button icon="clear" on-tap="serviceSearchClearTapped"></paper-icon-button>
              </template>
            </div>
          </div>
          <!-- service searchbar - end -->

          <!-- service search results - start -->
          <template is="dom-if" if="{{matchingServiceList.length}}">
            <div class="card vertical layout">

              <template is="dom-if" if="[[$hasPreviousPagination(paginate.offset)]]">
                <paper-button raised class="neutral pagination-show-previous" on-tap="showPreviousTapped">[[verses.general.showPrevious]]</paper-button>
              </template>

              <div class="list">
                <template is="dom-repeat" items="[[matchingServiceList]]" as="service">

                  <div class="horizontal layout item center">
                    <div class="flex" style="min-width: 128px;">
                      <div class="inventory-product-important-detail-container">[[service.name]]</div>
                      <div class="inventory-product-price-container">[[verses.posSelectService.sale]]: [[service.salePrice]][[app.settings.monetaryUnit]]</div>
                    </div>

                    <div class="horizontal layout wrap center">
                      <paper-button raised class="primary" on-tap="selectTapped">[[verses.general.select]]</paper-button>
                    </div>
                  </div>

                </template>
              </div>

              <div class="pagination">
                [[verses.general.loaded]]
                <span class="limit">[[pagination.limit]]</span>
                [[verses.general.itemsOutOf]]
                <span class="total-count">[[pagination.totalCount]]</span> [[verses.general.startingFrom]]
                <span class="offset">#[[$inc(pagination.offset)]]</span>.
              </div>
              <template is="dom-if" if="[[$hasMorePagination(pagination.totalCount, paginate.offset, paginate.limit)]]">
                <paper-button raised class="neutral pagination-show-more" on-tap="showMoreTapped">[[verses.general.showMore]]</paper-button>
              </template>

            </div>
          </template>
          <!-- service search results - end -->

          <!-- selected service list - start -->
          <div class="card vertical layout">
            <div class="list">

              <template is="dom-repeat" items="[[serviceList]]" as="service">
                <div class="horizontal layout item center">
                  <div class="vertical layout flex">

                    <div class="horizontal layout center">
                      <div class="service-info">
                        <span class="service-title">[[service.name]]</span>
                      </div>

                      <template is="dom-if" if="{{service.isEmployeeAssignable}}">

                        <template is="dom-if" if="{{service.assignedEmploymentId}}">
                          <div class="employee-icon-container-active" on-tap="assignEmployeeTapped">
                            <iron-icon icon="icons:account-circle" class="assign-icon"></iron-icon>[[verses.pos.assignedEmployee]]
                          </div>
                        </template>

                        <template is="dom-if" if="{{!service.assignedEmploymentId}}">
                          <div class="employee-icon-container" on-tap="assignEmployeeTapped">
                            <iron-icon icon="icons:account-circle" class="assign-icon"></iron-icon>[[verses.pos.assignEmployee]]
                          </div>
                        </template>

                      </template>
                    </div>

                    <template is="dom-if" if="{{service.isCustomerRequired}}">
                      <span class="service-customer-required">*[[verses.pos.serviceRequiresCustomerSelection]]</span>
                    </template>

                    <div class="horizontal layout center mt8">
                      <!-- <paper-input class=" flex height-adjusted" value="{{service.salePrice}}" min="[[service.minSalePrice]]" on-change="genericPaymentInputChanged" type="number" auto-validate>
                        </paper-input> -->
                      <div>[[service.salePrice]]</div>
                      <div class="description">[[app.settings.monetaryUnit]]</div>
                      <span class="service-vat-detail">(+ [[verses.pos.vat]]: {{service.vatValue}}%)</span>
                    </div>

                  </div>
                </div>
              </template>

            </div>
          </div>
          <!-- selected service list - end -->

        </div>
        <!-- services column - end -->

        <!-- products column - start -->
        <div class$="column flex [[$getColumnClasses('products', 'real', isMultiColumn, selectedTabName, productList.length, serviceList.length, customer, isAnonymousSale, isInOfflineMode)]]">

          <!-- warehouse selection - start -->
          <template is="dom-if" if="[[hasModule('MOD_SELL_WAREHOUSE_PRODUCTS')]]">
            <template is="dom-if" if="[[$shouldShowWarehouseSelector(warehouseList.length, productList.length)]]">
              <div class="card">
                <paper-dropdown-menu class="full-width-paper-dropdown" label="[[verses.pos.selectProductsFromInventoryContainer]]" class="mr-4">
                  <paper-listbox slot="dropdown-content" selected="{{selectedWarehouse}}" attr-for-selected="name">
                    <paper-item name="--current-outlet">[[verses.pos.currentOutlet]]</paper-item>
                    <template is="dom-repeat" items="[[warehouseList]]" as="warehouse">
                      <paper-item name="[[warehouse.id]]">
                        <div class="name">[[warehouse.name]]</div>
                      </paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>
              </div>
            </template>
          </template>
          <!-- warehouse selection - end -->

          <!-- product searchbar - start -->
          <div class="card vertical layout">
            <div class="horizontal layout center">
              <paper-input id="product-search-field" class="flex" value="{{productSearchString}}" always-float-label label="Name/Identifirer Code of product" on-keydown="productSearchFieldKeypressed"></paper-input>
              <template is="dom-if" if="[[!matchingProductList.length]]">
                <paper-icon-button icon="search" on-tap="productSearchTapped"></paper-icon-button>
              </template>
              <template is="dom-if" if="[[matchingProductList.length]]">
                <paper-icon-button icon="clear" on-tap="productSearchClearTapped"></paper-icon-button>
              </template>
            </div>
          </div>
          <!-- product searchbar - end -->

          <!-- product search results - start -->
          <template is="dom-if" if="{{matchingProductList.length}}">

            <div class="card vertical layout">

              <div class="list">
                <template is="dom-repeat" items="[[matchingProductList]]" as="product">
                  <div class="horizontal layout item center">
                    <div class="flex" style="min-width: 128px;">
                      <div class="inventory-product-important-detail-container">[[product.name]]</div>
                      <div class="inventory-product-price-container">[[verses.posSelectProduct.sale]]: [[product.salePrice]][[app.settings.monetaryUnit]]</div>
                    </div>

                    <template is="dom-if" if="[[product.count]]">
                      <paper-icon-button class=" primary " icon="add-circle" on-tap="selectMatchingProductTapped"></paper-icon-button>
                    </template>
                  </div>
                </template>
              </div>

              <div class="pagination">
                [[verses.general.loaded]]
                <span class="limit">[[productPagination.limit]]</span>
                [[verses.general.itemsOutOf]]
                <span class="total-count">[[productPagination.totalCount]]</span> [[verses.general.startingFrom]]
                <span class="offset">#[[$inc(productPagination.offset)]]</span>.
              </div>

              <div class="horizontal layout center">
                <template is="dom-if" if="[[$hasPreviousPagination(productPaginate.offset)]]">
                  <paper-button raised class="flex neutral " on-tap="showPreviousProductsTapped">[[verses.general.showPrevious]]</paper-button>
                </template>

                <template is="dom-if" if="[[$hasMorePagination(productPagination.totalCount, productPaginate.offset, productPaginate.limit)]]">
                  <paper-button raised class="flex neutral " on-tap="showMoreProductsTapped">[[verses.general.showMore]]</paper-button>
                </template>
              </div>

            </div>
          </template>
          <!-- product search results - end -->

          <!-- selected product list - start -->
          <template is="dom-if" if="[[productList.length]]">

            <div class="card vertical layout">
              <div class="horizontal layout center">

                <div class="flex" style="font-weight: bold; text-decoration: underline;">Selected Products:</div>
                <template is="dom-if" if="[[!isMultiColumn]]">
                  <!-- <paper-icon-button on-tap="productSelectionDoneTapped" icon="done-all"></paper-icon-button> Continue -->
                  <paper-button raised class="primary" on-tap="productSelectionDoneTapped" style="margin-bottom: 8px;">
                    <iron-icon icon="done-all"></iron-icon>&nbsp;Continue
                  </paper-button>
                </template>

              </div>
              <div class="list">

                <template is="dom-repeat" items="[[productList]]" as="product" index-as="productIndex">
                  <div class="horizontal layout item center">
                    <div class="vertical layout flex">
                      <div>
                        <span class="product-title">[[product.name]]</span>
                      </div>
                      <div class="horizontal layout center">

                        <paper-input no-label-float class="small-input m-horizontal-4 product-count-input" value="{{product.selectedCount}}" on-change="productSelectedCountInputChanged" type="number" min="1" max="99999999999" label="[[verses.posSelectProduct.count]]">
                          <div slot="suffix">&nbsp;[[product.unit]]</div>
                        </paper-input>

                        <div>&nbsp;@&nbsp;[[product.salePrice]]</div>
                        <div class="description">[[app.settings.monetaryUnit]]</div>
                        <paper-icon-button on-tap="editProductSalePriceTapped" icon="create" style="padding: 0; height: 16px; max-width: 16px; min-width: 16px;"></paper-icon-button>
                        <span class="product-discount-vat-detail"> (+ [[verses.pos.vat]]: {{product.vatValue}}%)</span>
                      </div>
                    </div>
                    <template is="dom-if" if="[[hasPrivilege('PRIV_ALLOW_FLEXIBLE_PRICE', organization)]]">
                      <paper-icon-button on-tap="discardProductTapped" icon="remove-circle"></paper-icon-button>
                    </template>
                  </div>
                </template>

              </div>
            </div>

          </template>
          <!-- selected product list - end -->

        </div>
        <!-- products column - end -->

        <!-- customer column - start -->
        <div class$="customer-column column flex [[$getColumnClasses('customer', 'real', isMultiColumn, selectedTabName, productList.length, serviceList.length, customer, isAnonymousSale, isInOfflineMode)]]" on-tap="customerColumnTapped">

          <template is="dom-if" if="[[!isInOfflineMode]]">

            <!-- customer selection - start -->
            <template is="dom-if" if="[[$shouldShowCustomerSelectionOptions(customer, isAnonymousSale)]]">
              <elem-customer-selector page="{{self}}"></elem-customer-selector>
            </template>
            <!-- customer selector - end -->

            <!-- customer creation - start -->
            <template is="dom-if" if="[[$shouldShowCustomerSelectionOptions(customer, isAnonymousSale)]]">
              <iron-form id="editCustomerForm" on-keypress="genericFormSubmitionKeypress">
                <form>
                  <div class="card vertical layout">

                    <paper-input class="editCustomerForm--fullName" value="{{editCustomerForm.fullName}}" required minlength="3" error-message=[[verses.customer.customerNameInputError]] label=[[verses.customer.customerNameInput]]></paper-input>
                    <paper-input class="editCustomerForm--phone" value="{{editCustomerForm.phone}}" required minlength="11" maxlength="15" error-message=[[verses.customer.customerNumberInputError]] label=[[verses.customer.customerNumberInput]]></paper-input>

                    <paper-input class="editCustomerForm--email" value="{{editCustomerForm.email}}" pattern="^.+@.+\..+$" minlength="3" error-message=[[verses.customer.emailAddressInputError]] label=[[verses.customer.emailAddressInput]]></paper-input>
                    <paper-textarea class="editCustomerForm--address" value="{{editCustomerForm.address}}" label=[[verses.customer.addressInput]] rows="3"></paper-textarea>

                    <div class="horizontal layout button-row end">
                      <paper-button raised class="danger" on-tap="skipCustomerSelectionTapped">Skip</paper-button>
                      <div class="flex"></div>
                      <paper-button raised class="primary editCustomerForm--submit" on-tap="createCustomerTapped">[[verses.customer.createCustomer]]</paper-button>
                    </div>

                  </div>
                </form>
              </iron-form>
            </template>
            <!-- customer creation - end -->

            <!-- customer preview - start -->
            <template is="dom-if" if="[[!$shouldShowCustomerSelectionOptions(customer, isAnonymousSale)]]">
              <div class="card vertical layout">
                <div class="bold-customer-card-title">[[verses.pos.customerSelectionCardHeader]]</div>

                <template is="dom-if" if="[[customer]]">
                  <div>
                    <div class="type title capitalize">[[customer.fullName]]</div>
                    <div class="horizontal layout wrap">

                      <div class="horizontal layout center m-right-8">
                        <iron-icon icon="hardware:smartphone" class="icon secondary small m-right-8"></iron-icon>
                        <div class="type body secondary">[[customer.phone]]</div>
                      </div>

                      <template is="dom-if" if="[[hasModule('MOD_CUSTOMER_ACCOUNT_BALANCE')]]">
                        <div class="horizontal layout center">
                          <iron-icon icon="icons:account-balance-wallet" class="icon secondary small m-right-8"></iron-icon>
                          <div class="type body secondary">[[customer.changeWalletBalance]] [[page.app.settings.monetaryUnit]]</div>
                        </div>
                      </template>

                    </div>
                  </div>
                </template>

                <template is="dom-if" if="[[isAnonymousSale]]">
                  <div>No customer selected</div>
                </template>

                <div class="horizontal layout end-justified m-top-16">
                  <template is="dom-if" if="[[customer]]">
                    <paper-button raised class="danger btn btn-default" on-tap="removeCustomerTapped">
                      Select a different customer
                    </paper-button>
                  </template>
                  <template is="dom-if" if="[[isAnonymousSale]]">
                    <paper-button raised class="primary btn btn-default" on-tap="removeCustomerTapped">
                      Select a customer
                    </paper-button>
                  </template>
                </div>
              </div>

              <template is="dom-if" if="[[!isMultiColumn]]">
                <paper-button raised class="primary" on-tap="customerSelectionDoneTapped" style="width: calc(100% - 16px); margin: 8px;">
                  <iron-icon icon="done-all"></iron-icon>&nbsp;Continue
                </paper-button>
              </template>

            </template>
            <!-- customer preview - end -->

          </template>

        </div>
        <!-- customer column - end -->

        <!-- customer column placeholder - start -->
        <div class$="column flex placeholder  vertical layout center-center [[$getColumnClasses('customer', 'placeholder', isMultiColumn, selectedTabName, productList.length, serviceList.length, customer, isAnonymousSale, isInOfflineMode)]]">
          <div style="max-width: 300px;">
            Please complete product/service selection to access customer features.
          </div>
        </div>
        <!-- customer column placeholder - end -->

        <!-- payment column - start -->
        <div class$="column flex [[$getColumnClasses('payment', 'real', isMultiColumn, selectedTabName, productList.length, serviceList.length, customer, isAnonymousSale, isInOfflineMode)]]" on-tap="paymentColumnTapped">

          <!-- calculations - start -->
          <template is="dom-if" if="[[productListOrServiceListHasElement(productList.length, serviceList.length)]]">
            <div class="card vertical layout">
              <div class="individual-calculation-field-container">
                <span>[[verses.pos.totalSalePrice]]: <b>{{$round(payment.totalAmount)}} [[app.settings.monetaryUnit]]</b></span>
              </div>
            </div>
          </template>

          <template is="dom-if" if="[[productListOrServiceListHasElement(productList.length, serviceList.length)]]">
            <div class="card vertical layout">
              <div class="list">

                <div class="individual-calculation-field-container">
                  [[verses.pos.vatAmount]]:
                  <b>{{$round(payment.vatAmount)}} [[app.settings.monetaryUnit]]</b>
                </div>

                <div class="individual-calculation-field-container">

                  <div class="vertical layout m-bottom-18">

                    <paper-dropdown-menu class="full-width-paper-dropdown" label="[[verses.pos.discount]]" class="mr-4">
                      <paper-listbox slot="dropdown-content" selected="{{selectedDiscountPreset}}" attr-for-selected="name">
                        <paper-item name="--no-discount">[[verses.pos.noDiscountApplicable]]</paper-item>
                        <template is="dom-repeat" items="[[discountPresetList]]" as="discountPreset">
                          <paper-item name="[[discountPreset.id]]">
                            [[getDiscountPresetLabel(discountPreset)]]
                          </paper-item>
                        </template>
                      </paper-listbox>
                    </paper-dropdown-menu>

                  </div>

                  [[verses.pos.discountedAmount]]:
                  <b>{{$round(payment.discountedAmount)}} [[app.settings.monetaryUnit]]</b>

                </div>

                <div class="individual-calculation-field-container horizontal layout center">

                  <paper-input class="payment--serviceChargeAmount flex" value="{{payment.serviceChargeAmount}}" on-change="genericPaymentInputChanged" type="number" required min="0" error-message="[[verses.pos.serviceChargeInputError]]" label="[[verses.pos.serviceChargeInput]]">
                    <div slot="suffix">[[app.settings.monetaryUnit]]</div>
                  </paper-input>

                  <template is="dom-if" if="{{!isInOfflineMode}}">

                    <template is="dom-if" if="{{assignedAssistedByEmployee}}">
                      <div class="employee-icon-container-active" on-tap="assignAssistedByEmployeeTapped">
                        <iron-icon icon="icons:account-circle" class="assign-icon"></iron-icon>[[verses.pos.assistedEmployee]]
                      </div>
                    </template>

                    <template is="dom-if" if="{{!assignedAssistedByEmployee}}">
                      <div class="employee-icon-container" on-tap="assignAssistedByEmployeeTapped">
                        <iron-icon icon="icons:account-circle" class="assign-icon"></iron-icon>[[verses.pos.assistedEmployee]]
                      </div>
                    </template>

                  </template>

                </div>

              </div>
            </div>
          </template>
          <!-- calculations - end -->

          <!-- payment area card - start -->
          <template is="dom-if" if="[[productListOrServiceListHasElement(productList.length, serviceList.length)]]">
            <div class="card vertical layout" style="background: var(--app-primary-color-light);">
              <div class="list">

                <template is="dom-if" if="[[payment.roundedByAmount]]">
                  <div class="individual-calculation-field-container light">
                    <div class="horizontal layout center m-top-16">
                      <div class="flex">
                        [[verses.sales.totalBillBeforeRounding]]:
                        <b>{{$round(payment.totalBillBeforeRounding)}} [[app.settings.monetaryUnit]]</b>
                      </div>
                    </div>
                    <div class="horizontal layout center">
                      <div class="flex">
                        [[verses.sales.roundedByAmount]]:
                        <b>{{$round(payment.roundedByAmount)}} [[app.settings.monetaryUnit]]</b>
                      </div>
                      <paper-icon-button on-tap="clearRounderByAmountTapped" icon="clear"></paper-icon-button>
                    </div>
                  </div>
                </template>
                <div class="horizontal layout center individual-calculation-field-container light">
                  <div class="flex">
                    [[verses.pos.totalBilled]]:
                    <b>{{$round(payment.totalBilled)}} [[app.settings.monetaryUnit]]</b>
                  </div>
                  <template is="dom-if" if="[[hasPrivilege('PRIV_ALLOW_FLEXIBLE_PRICE', organization)]]">
                    <paper-icon-button on-tap="editTotalBilledTapped" icon="create"></paper-icon-button>
                  </template>
                </div>

                <div class="individual-calculation-field-container light">

                  <paper-dropdown-menu class="full-width-paper-dropdown" label="[[verses.pos.paymentMethod]]" class="mr-4" on-iron-select="paymentMethodSelected">
                    <paper-listbox slot="dropdown-content" selected="{{payment.paymentMethod}}" attr-for-selected="name">
                      <paper-item name="cash">[[verses.general.cash]]</paper-item>
                      <paper-item name="card">[[verses.general.card]]</paper-item>
                      <paper-item name="digital">[[verses.general.digital]]</paper-item>
                      <template is="dom-if" if="[[customer]]">
                        <paper-item name="change-wallet">[[verses.general.balance]]</paper-item>
                      </template>
                    </paper-listbox>
                  </paper-dropdown-menu>

                  <template is="dom-if" if="[[!isPaymentMethodChangeWallet(payment.paymentMethod)]]">
                    <paper-input class="payment--paidAmount flex" value="{{payment.paidAmount}}" on-change="genericPaymentInputChanged" on-input="genericPaymentInputChanged" type="number" required min="0" error-message="[[verses.pos.paidAmountInputError]]" label="[[verses.pos.paidAmountInput]]">
                      <div slot="suffix">[[app.settings.monetaryUnit]]</div>
                    </paper-input>
                  </template>

                  <template is="dom-if" if="[[payment.changeAmount]]">
                    <br> [[verses.pos.changeAmount]]:
                    <b>{{$round(payment.changeAmount)}} [[app.settings.monetaryUnit]]</b>

                    <br>
                    <template is="dom-if" if="[[hasModule('MOD_CUSTOMER_ACCOUNT_BALANCE')]]">
                      <template is="dom-if" if="[[customer]]">
                        <template is="dom-if" if="[[payment.changeAmount]]">
                          <paper-checkbox checked="{{payment.shouldSaveChangeInAccount}}">
                            [[verses.pos.shouldSaveChangeInAccount]]
                          </paper-checkbox>
                        </template>
                      </template>
                    </template>

                  </template>

                  <template is="dom-if" if="[[isValidCreditSale(customer, payment.totalBilled, payment.paidAmount)]]">
                    [[verses.pos.thisWillBeACreditSale]]
                  </template>

                </div>

                <div class="horizontal layout m-top-16">
                  <paper-button raised class="primary flex" on-tap="saveSaleTapped">[[verses.pos.confirmSales]]</paper-button>
                </div>

                <div class="horizontal layout m-top-16">
                  <paper-button id="sale-and-print-button" raised class="primary flex" on-tap="saveSaleAndPrintTapped">[[verses.pos.confirmSalesAndPrint]]</paper-button>
                </div>

              </div>
            </div>
          </template>
          <!-- payment area card - end -->

        </div>
        <!-- payment column - end -->

        <!-- payment column placeholder - start -->
        <div class$="column flex placeholder vertical layout center-center  [[$getColumnClasses('payment', 'placeholder', isMultiColumn, selectedTabName, productList.length, serviceList.length, customer, isAnonymousSale, isInOfflineMode)]]">
          <div style="max-width: 300px;">
            Please complete product/service and customer selection to access payment features.
          </div>
        </div>
        <!-- payment column placeholder - end -->

      </div>
      <!-- columns - End -->

    </div>

  </template>

  <script>
    class PagePos2 extends FxPage.mixin(TorqueCommonBehavior, TorquePageBehavior, TorqueDbBehavior, FxCommonBehavior, TorqueLanguageBehavior) {

      static get is() {
        return 'page-pos2';
      }

      static get properties() {
        return {
          // Tabination =============
          isMultiColumn: {
            type: Boolean,
            value: false
          },
          selectedTabName: {
            type: String,
            value: 'selection'
          },
          salesType: {
            type: String,
            value: 'undecided' // can be - 'undecided', 'products', 'services'
          },
          // Products =============
          warehouseList: {
            type: Array,
            value: () => []
          },
          selectedWarehouse: {
            type: String,
            value: '--current-outlet',
            observer: 'selectedWarehouseChanged'
          },
          productsSelectedFromWarehouseId: {
            type: Number,
            value: null,
          },
          productList: {
            type: Array,
            value: () => [],
            observer: 'productListChanged'
          },
          matchingProductList: {
            type: Array,
            value: () => []
          },
          productPaginate: {
            type: Object,
            value: () => {
              return {
                offset: 0,
                limit: 3
              }
            }
          },
          productPagination: {
            type: Object,
            value: () => {
              return {}
            }
          },
          // Services =============
          serviceList: {
            type: Array,
            value: () => []
          },
          matchingServiceList: {
            type: Array,
            value: () => []
          },
          servicePaginate: {
            type: Object,
            value: () => {
              return {
                offset: 0,
                limit: 3
              }
            }
          },
          servicePagination: {
            type: Object,
            value: () => {
              return {}
            }
          },
          // Customer =============
          isAnonymousSale: {
            type: Boolean,
            value: false
          },
          customer: {
            type: Object,
            value: null,
            observer: 'customerChanged'
          },
          editCustomerForm: {
            type: Object,
            value: _ => {
              if (mode === 'development') {
                return {
                  fullName: 'Rahim Karim',
                  phone: '01700000011',
                  email: 'rahim@gmail.com',
                  address: 'house road block code 1213 city country'
                };
              } else {
                return {
                  fullName: '',
                  phone: '',
                  email: null,
                  address: ''
                };
              }
            }
          },
          // Payment =============
          selectedDiscountPreset: {
            type: String,
            value: '--no-discount',
            observer: 'selectedDiscountPresetChanged'
          },
          payment: {
            type: Object,
            value: () => {
              return {
                totalAmount: null,
                vatAmount: 0,
                discountType: 'percent',
                discountValue: 0,
                discountedAmount: 0,
                serviceChargeAmount: 0,
                totalBillBeforeRounding: 0,
                roundedByAmount: 0,
                totalBilled: null,
                shouldSaveChangeInAccount: false,
                paymentMethod: 'cash',
                paidAmount: 0,
                changeAmount: 0
              }
            }
          },
          // Offline Mode =============
          isInOfflineMode: {
            type: Boolean,
            value: false
          },
          shouldExpandOfflineSalesList: {
            type: Boolean,
            value: false
          },
        };
      }

      // region: core =================================

      constructor() {
        super();
        this.confirmPageReady();
      }

      _ensureAccess() {
        return this.accessControl({
          authLevel: 'organization-selected',
          privilegeList: ['PRIV_ACCESS_POS']
        });
      }

      onNavigateIn() {
        this.app.shouldShowSaveButton = false;
        this.app.currentPageIsModal = true;
        this.useLanguageServices();
        this.onOfflineDataChange();
        this.onOrganizationChange(this.app.organization);
        this.app.pushPageTitle(this.app.verses.pos.posPageTitle);
        if (!'outlet' in this.params) {
          return this.app.showModalDialog(this.app.verses.general.errorMessageTitle, this.app.verses.general.somethingWentWrong, () => {
            return this.navigateTo('/home');
          });
        }
        if (!this._ensureAccess()) return;

        // tabination
        this._detectMultiColumnSupport();
        window.addEventListener('resize', () => this._detectMultiColumnSupport());

        let salesType = this.app.getFromSession('pos-sales-type') || 'undecided';
        if (salesType === 'undecided') {
          if (this.hasModule('MOD_PRODUCT') && this.hasModule('MOD_SERVICE')) {
            'pass'
          } else if (this.hasModule('MOD_PRODUCT')) {
            salesType = 'products';
          } else if (this.hasModule('MOD_SERVICE')) {
            salesType = 'services';
          }
        }
        this.salesType = salesType;

        if (salesType === 'undecided') {
          this.selectedTabName = 'selection';
        } else {
          this.selectedTabName = salesType;
        }
        console.log('selectedTabName', this.selectedTabName);

        // products
        if (!this.isInOfflineMode) {
          this._fetchWarehouseList((warehouseList) => {
            warehouseList.reverse();
            this.warehouseList = warehouseList;
          });
        }
        this.selectedWarehouse = this.app.getFromSession('pos-selected-warehouse') || '--current-outlet';
        this.productsSelectedFromWarehouseId = this.app.getFromSession('product-selected-from-warehouse-id') || null;
        this.productList = this.app.getFromSession('pos-selected-product-list') || [];
        this.matchingProductList = [];

        // services
        this.serviceList = this.app.getFromSession('pos-selected-service-list') || [];

        // customer
        this.delay(0, () => {
          this.self = this;
          this.customer = this.app.getFromSession('last-selected-customer') || null;
          this.isAnonymousSale = this.app.getFromSession('last-selected-customer-is-anonymous') || false;
          // console.log(this.isAnonymousSale);
        });

        // payment
        this.assignedAssistedByEmployee = this.app.getFromSession('pos-assigned-assisted-by-employee');
        this.selectedDiscountPreset = '--no-discount';
        this._processDiscountPresetList(() => { });
        this.delay(0, () => {
          this._calculatePayment();
        });

        this.isReady = true;
      }

      onNavigateOut() {
        super.onNavigateOut();
        this.app.currentPageAllowsBackButton = true;
        this.app.popPageTitle();
      }

      onOrganizationChange(organization) {
        this.organization = organization;
      }

      backButtonOnTopBarPressed(e = null) {
        this._resetSales();
        this.app.navigateToPreviousUrl('/home');
      }

      // region: tabination =================================

      singleColumnTabTapped(e) {
        e.stopPropagation();
        let attr = e.target.getAttribute('data-key');
        // console.log({ selectedTabName: attr });
        this.selectedTabName = attr;
      }

      $getTabSelectedClass(tabName, selectedTabName) {
        console.log('getTabSelectedClass', { tabName, selectedTabName })
        let classNames = '';
        if (tabName === selectedTabName) {
          classNames += 'selected ';
        }
        return classNames;
      }

      _detectMultiColumnSupport() {
        const minimumPageWidth = 960;
        const leftSidebarWidth = 280;
        const margins = 2 + 2 + 2 + 2;
        const scrollbars = 25;
        if (window.innerWidth < (minimumPageWidth + leftSidebarWidth + margins + scrollbars)) {
          this.isMultiColumn = false;
        } else {
          this.isMultiColumn = true;
        }
      }

      $getColumnClasses(tabName, type, isMultiColumn, selectedTabName, productListLength, serviceListLength, customer, isAnonymousSale, isInOfflineMode) {
        // console.log({ tabName, type, isMultiColumn, selectedTabName, productListLength, serviceListLength, customer, isAnonymousSale, isInOfflineMode });
        let classNames = '';

        let isProductOrServiceSelectionDone = productListLength > 0 || serviceListLength > 0;
        let isCustomerSelectionDone = (!!customer) || isAnonymousSale;

        if (tabName === 'customer') {
          if (isProductOrServiceSelectionDone && type === 'placeholder') {
            classNames += 'hidden ';
          } else if (!isProductOrServiceSelectionDone && type !== 'placeholder') {
            classNames += 'hidden ';
          }
        }

        if (tabName === 'payment') {
          if ((isProductOrServiceSelectionDone && isCustomerSelectionDone) && type === 'placeholder') {
            classNames += 'hidden ';
          } else if (!(isProductOrServiceSelectionDone && isCustomerSelectionDone) && type !== 'placeholder') {
            classNames += 'hidden ';
          }
        }

        if (isMultiColumn) {
          if (tabName !== 'payment' && tabName !== 'customer') {
            if (tabName === selectedTabName) {
              classNames += ''
            } else {
              classNames += 'hidden ';
            }
          }
        } else {
          if (tabName === selectedTabName) {
            classNames += ''
          } else {
            classNames += 'hidden ';
          }
        }
        return classNames;
      }

      salesTypeIsProductsTapped(e = null) {
        this.salesType = 'products';
        this.selectedTabName = 'products';
        this.app.storeInSession('pos-sales-type', this.salesType);
      }

      salesTypeIsServicesTapped(e = null) {
        this.salesType = 'services';
        this.selectedTabName = 'services';
        this.app.storeInSession('pos-sales-type', this.salesType);
      }

      // region: products =================================

      // sub-region: warehouse

      $shouldShowWarehouseSelector(warehouseListLength, productListLength) {
        return (warehouseListLength > 0 && productListLength === 0);
      }

      selectedWarehouseChanged() {
        this.app.storeInSession('pos-selected-warehouse', this.selectedWarehouse);
        this._resetProductSearch();
        this._updateDefaultInventoryId(() => { }); // Makes sure defaultInventoryId is set correctly
      }

      _setProductSelectedFromWarehouseId(id) {
        this.productsSelectedFromWarehouseId = id;
        this.app.storeInSession('product-selected-from-warehouse-id', this.productsSelectedFromWarehouseId);
      }

      _fetchWarehouseList(cbfn) {
        if (!this.hasModule('MOD_SELL_WAREHOUSE_PRODUCTS')) {
          return cbfn([]);
        }
        let data = { organizationId: this.app.organization.id };
        this.app.callGetWarehouseListApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response.warehouseList);
        });
      }

      // sub-region: getting default inventory

      _processGetOutletDefaultInventoryIdOnline(cbfn) {
        let data = { outletId: this.params.outlet };
        this.app.callGetOutletApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response.defaultInventory.id);
        });
      }

      _processGetOutletDefaultInventoryIdOffline(cbfn) {
        window.setTimeout(() => {
          cbfn(this.app.offlineData.cache.getOutlet.defaultInventory.id);
        }, 10);
      }

      _processGetWarehouse(cbfn) {
        let data = { warehouseId: this.selectedWarehouse };
        this.app.callGetWarehouseApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response);
        });
      }

      _processGetOutletDefaultInventoryId(cbfn) {
        if (this.selectedWarehouse === '--current-outlet') {
          this._setProductSelectedFromWarehouseId(null);
          if (this.isInOfflineMode) {
            this._processGetOutletDefaultInventoryIdOffline(cbfn);
          } else {
            this._processGetOutletDefaultInventoryIdOnline(cbfn);
          }
        } else {
          if (this.isInOfflineMode) {
            return this.app.showModalDialog(this.verses.pos.saleNotValid, this.verses.pos.offlineWarehouseSellNotAllowed);
          } else {
            this._processGetWarehouse(({ defaultInventory, warehouse }) => {
              this._setProductSelectedFromWarehouseId(warehouse.id);
              return cbfn(defaultInventory.id);
            });
          }
        }
      }

      _updateDefaultInventoryId(cbfn) {
        this.defaultInventoryId = null;
        this._processGetOutletDefaultInventoryId(defaultInventoryId => {
          this.defaultInventoryId = defaultInventoryId;
          cbfn();
        });
      }

      // sub-region: search

      _fetchAggregatedInventoryDetailsOnline(cbfn) {
        let data = {
          inventoryId: this.defaultInventoryId,
          searchString: String(this.productSearchString),
          paginate: this.productPaginate,
          includeZeroCountProducts: false,
          sortOrder: 'blueprint-created-date-descending'
        };
        this.app.callGetAggregatedInventoryDetailsApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          this.productPagination = response.pagination;
          return cbfn(response);
        });
      }

      _fetchAggregatedInventoryDetailsOffline(cbfn) {
        window.setTimeout(() => {
          let response = JSON.parse(JSON.stringify(this.app.offlineData.cache.getAggregatedInventoryDetails));

          let searchString = String(this.productSearchString);
          if (searchString.length > 0) {
            searchString = searchString.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            let regex = new RegExp(searchString, 'g');
            response.aggregatedProductList = response.aggregatedProductList.filter(product => {
              return (regex.test(product.product.productBlueprint.name) || searchString === product.product.productBlueprint.identifierCode);
            });
          }

          ([response.aggregatedProductList, response.pagination] = this._paginateOfflineData(response.aggregatedProductList));

          this.productPagination = response.pagination;
          cbfn(response);
        }, 100);
      }

      _fetchAggregatedInventoryDetails(cbfn) {
        if (this.isInOfflineMode) {
          this._fetchAggregatedInventoryDetailsOffline(cbfn);
        } else {
          this._fetchAggregatedInventoryDetailsOnline(cbfn);
        }
      }

      _searchProducts(cbfn) {
        this._fetchAggregatedInventoryDetails(({ aggregatedProductList, inventoryContainerDetails, inventoryDetails }) => {

          // Prepare Products
          let productList = aggregatedProductList.map(product => {
            let { purchasePrice, salePrice } = product.product;
            let { name, unit, defaultVat, identifierCode } = product.product.productBlueprint;
            let vatValue = defaultVat;
            Object.assign(product, { name, unit, purchasePrice, salePrice, vatValue, identifierCode });
            return product;
          });

          if (productList.length === 1 && this.productSearchString.length > 0 && productList[0].identifierCode === this.productSearchString) {
            // search by identifierCode was successful.
            productList[0].selectedCount = 1;
            this._selectProduct({ product: productList[0] });
            this.productSearchString = '';
          } else {
            this.matchingProductList = productList;
          }

          cbfn();
        });
      }

      _selectProduct({ product }) {
        // console.log("_selectProduct", { product });
        let { productId, name, selectedCount, count, salePrice, vatValue, unit } = product;
        let maxAllowedCount = count;
        selectedCount = parseFloat(String(selectedCount));
        let minSalePrice = salePrice;

        let existingProductIndex = this.productList.findIndex(existingProduct => existingProduct.productId === product.productId);
        if (existingProductIndex > -1) {
          let existingProduct = this.productList[existingProductIndex];
          this.set(`productList.${existingProductIndex}.selectedCount`, (parseFloat(existingProduct.selectedCount) + selectedCount));
        } else {
          this.unshift('productList', { productId, name, selectedCount, maxAllowedCount, salePrice, vatValue, minSalePrice, unit });
        }
        this.productListChanged();
      }

      _resetProductSearch() {
        this.productSearchString = '';
        this.matchingProductList = [];
      }

      productSearchFieldKeypressed(e) {
        if (e.which === 13) {
          this.productSearchTapped(null);
        } else if (e.which === 27) {
          this._resetProductSearch();
        }
      }

      productSearchClearTapped(e) {
        this._resetProductSearch();
        this.elem('#product-search-field').focus();
      }

      productSearchTapped(e = null) {
        if (!this.isReady) {
          // NOTE: Keep this console log
          console.warn("A search request is already underway.");
          return;
        }
        this.productPaginate.offset = 0;
        this.isReady = false;
        this._searchProducts(() => {
          this.isReady = true;
        });
      }

      showMoreProductsTapped(e = null) {
        this.set('productPaginate.offset', this.productPaginate.offset + this.productPaginate.limit);
        this.isReady = false;
        this._searchProducts(() => this.isReady = true);
      }

      showPreviousProductsTapped(e = null) {
        this.set('productPaginate.offset', Math.max(0, this.productPaginate.offset - this.productPaginate.limit));
        this.isReady = false;
        this._searchProducts(() => this.isReady = true);
      }

      selectMatchingProductTapped(e) {
        let { product } = e.model;
        product.selectedCount = 1;
        this._selectProduct({ product });
      }

      productListChanged() {
        this.app.storeInSession('pos-selected-product-list', this.productList);
        this._calculatePayment({ resetRounding: true });
      }

      // sub-region: post selection

      productSelectedCountInputChanged(e) {
        this.enforceMinMaxOnPaperInput(e);
        this._calculatePayment({ resetRounding: true });
      }

      editProductSalePriceTapped(e) {
        let { product } = e.model;
        this.app.showModalInput(this.verses.sales.editSalePrice, this.verses.sales.editSalePriceDetails, product.salePrice, (answer) => {
          let salePrice = parseFloat(answer);
          if (salePrice >= 0) {
            e.model.set('product.salePrice', salePrice);
            this._calculatePayment({ resetRounding: true });
          }
        });
      }

      discardProductTapped(e) {
        let { productIndex } = e.model;
        this.splice('productList', productIndex, 1);
        this.productListChanged();
        this._calculatePayment({ resetRounding: true });
      }

      productSelectionDoneTapped(e = null) {
        this._resetProductSearch();
        this.selectedTabName = 'customer';
        try {
          this.elem('.single-column-tabs-row').scrollIntoView();
        } catch (ex) { }
        this._calculatePayment({ resetRounding: true });
      }

      // region: services =================================


      _fetchOutletServiceListOnline(cbfn) {
        let data = { outletId: parseInt(this.params.outlet), searchString: this.searchString, paginate: this.paginate };

        this.app.callGetActiveServiceListApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          this.pagination = response.pagination;
          return cbfn(response);
        });
      }

      _fetchOutletServiceListOffline(cbfn) {
        window.setTimeout(() => {
          let response = JSON.parse(JSON.stringify(this.app.offlineData.cache.getActiveServiceList));

          let searchString = String(this.searchString);
          if (searchString.length > 0) {
            searchString = searchString.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            let regex = new RegExp(searchString, 'g');
            response.serviceList = response.serviceList.filter(product => {
              return regex.test(product.product.productBlueprint.name);
            });
          }

          ([response.serviceList, response.pagination] = this._paginateOfflineData(response.serviceList));

          this.pagination = response.pagination;
          cbfn(response);
        }, 100);
      }

      _fetchOutletServiceList(cbfn) {
        if (this.isInOfflineMode) {
          this._fetchOutletServiceListOffline(cbfn);
        } else {
          this._fetchOutletServiceListOnline(cbfn);
        }
      }

      _processOutletServices(cbfn) {
        this._fetchOutletServiceList(({ serviceList }) => {

          this.serviceList = serviceList.map(service => {
            let { salePrice } = service;
            let { name, defaultVat, isCustomerRequired, isEmployeeAssignable, isLongstanding, serviceDuration } = service.serviceBlueprint;
            service.isSelected = false;
            let vatValue = defaultVat;
            let assignedEmploymentId = null;
            Object.assign(service, { name, salePrice, vatValue, isCustomerRequired, isEmployeeAssignable, assignedEmploymentId, isLongstanding, serviceDuration });
            return service;
          });

          let previousSavedSelectedServiceList = this.app.getFromSession('pos-selected-service-list') || [];

          if (this.selectedServiceList.length > 0 || previousSavedSelectedServiceList.length > 0) {
            if (previousSavedSelectedServiceList.length > 0 && this.selectedServiceList.length === 0) {
              this.selectedServiceCount = previousSavedSelectedServiceList.length;
              this.selectedServiceList = previousSavedSelectedServiceList;
            }

            this.selectedServiceList.forEach(previousService => {
              let service = this.serviceList.find(service => service.id === previousService.id);
              if (service) {
                service.isSelected = true;
              }
            })
          }

          cbfn();
        });
      }

      _addServiceToSelectedServiceList({ service }) {
        let { id, name, salePrice, vatValue, isCustomerRequired, isEmployeeAssignable, assignedEmploymentId, isLongstanding, serviceDuration } = service;
        let minSalePrice = salePrice;
        this.push('selectedServiceList', { id, name, minSalePrice, salePrice, vatValue, isCustomerRequired, isEmployeeAssignable, assignedEmploymentId, isLongstanding, serviceDuration });
        this.selectedServiceCount = this.selectedServiceList.length;
      }

      _removeServiceFromSelectedServiceList({ service }) {
        this.selectedServiceList.forEach((selectedProduct, index) => {
          if (selectedProduct.id === service.id) {
            this.splice('selectedServiceList', index, 1);
          }
        });

        this.serviceList.forEach((serviceInList, index) => {
          if (serviceInList.id === service.id) {
            this.set(`serviceList.${index}.isSelected`, false);
          }
        });

        this.selectedServiceCount = this.selectedServiceList.length;
      }


      showMoreTapped(e = null) {
        this.set('paginate.offset', this.paginate.offset + this.paginate.limit);
        this.isReady = false;
        this._processOutletServices(() => this.isReady = true);
      }

      showPreviousTapped(e = null) {
        this.set('paginate.offset', Math.max(0, this.paginate.offset - this.paginate.limit));
        this.isReady = false;
        this._processOutletServices(() => this.isReady = true);
      }

      searchFieldKeypressed(e) {
        if (e.which === 13) this.searchTapped(null);
      }

      searchCancelTapped(e = null) {
        this.searchString = '';
      }

      searchTapped(e = null) {
        this.set('paginate.offset', 0);
        this._processOutletServices(() => this.isReady = true);
      }

      selectTapped(e) {
        e.model.set('service.isSelected', true);
        let { service } = e.model;
        this._addServiceToSelectedServiceList({ service });
      }

      deselectTapped(e) {
        let { service } = e.model;
        this._removeServiceFromSelectedServiceList({ service });
      }

      selectServicesTapped(e = null) {
        this.app.storeInSession('pos-selected-service-list', this.selectedServiceList);
        this.selectedServiceList = [];
        this.selectedServiceCount = 0;
        this.backButtonOnTopBarPressed();
      }

      deselectAllTapped(e) {
        this.serviceList.forEach((service, index) => this.set(`serviceList.${index}.isSelected`, false));
        this.selectedServiceList = [];
        this.selectedServiceCount = 0;
        this.app.storeInSession('pos-selected-service-list', this.selectedServiceList);
      }



      // region: customer =================================

      _customerVariablesChanged() {
        this.app.storeInSession('last-selected-customer', this.customer);
        this.app.storeInSession('last-selected-customer-is-anonymous', this.isAnonymousSale);
      }

      customerColumnTapped(e = null) {
        this._resetProductSearch();
      }

      removeCustomerTapped(e = null) {
        this.customer = null;
        this.isAnonymousSale = false;
        this._customerVariablesChanged();
      }

      customerChanged() {
        if (!this.customer) return;
        this._customerVariablesChanged();
      }

      _processGetCustomer({ customerId }, cbfn) {
        let data = {
          customerId
        };
        this.app.callGetCustomerApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          cbfn(response.customer);
        });
      }

      _customerSelected(customer) {
        this.customer = customer;
      }

      _processCreateCustomer({ fullName, phone, email, address }, cbfn) {
        let data = {
          fullName, phone, email, address,
          organizationId: this.app.organization.id
        };
        this.app.callAddCustomerApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error, 'editCustomerForm');
          let message = this.app.verses.customer.newCustomerCreated;
          this.app.showToast(message, _ => {
            let customerId = response.customerId;
            cbfn({ customerId });
          });
        });
      }

      createCustomerTapped(e = null) {
        this.elemAll('#editCustomerForm paper-input').forEach(el => el.autoValidate = true);
        if (!this.elem('#editCustomerForm').validate()) return;

        let { fullName, phone, email, address } = this.editCustomerForm;
        this._processCreateCustomer({ fullName, phone, email, address }, ({ customerId }) => {
          this._processGetCustomer({ customerId }, (customer) => {
            this.customer = customer;
            this.isAnonymousSale = false;
            this._customerVariablesChanged();
          });
        });
      }

      skipCustomerSelectionTapped(e = null) {
        this.app.showModalConfirmation(
          "Are you sure?",
          "Skipping customer selection will make it harder to identify this sale at a later time. Please\
          Only skip customer selection if you understand the risk.",
          (answer) => {
            if (!answer) return;
            this.isAnonymousSale = true;
            this._customerVariablesChanged();
          }
        );
      }

      $shouldShowCustomerSelectionOptions(customer, isAnonymousSale) {
        // console.log({ customer, isAnonymousSale });
        if (!customer && !isAnonymousSale) return true;
        return false;
      }

      customerSelectionDoneTapped(e) {
        this.selectedTabName = 'payment';
        this._customerVariablesChanged();
      }

      // region: payment =================================

      paymentColumnTapped(e = null) {
        this._resetProductSearch();
      }

      paymentMethodSelected(e) {
        // NOTE: The timeout should not be necessary. However, without it
        // the value of this.payment.paymentMethod is not being updated in time.
        window.setTimeout(() => {
          this._calculatePayment();
        }, 100);
      }

      genericPaymentInputChanged(e) {
        this.enforceMinMaxOnPaperInput(e);
        if (e.target.className.indexOf('payment--paidAmount') > -1) {
          this._calculatePayment({ resetRounding: false });
        } else {
          this._calculatePayment();
        }
      }

      selectedDiscountPresetChanged() {
        if (this.selectedDiscountPreset === '--no-discount') {
          this.payment.discountPresetId = null;
          this.payment.discountType = 'percent';
          this.payment.discountValue = '0';
        } else {
          let key = parseInt(String(this.selectedDiscountPreset));
          let discountPreset = this.discountPresetList.find(discountPreset => discountPreset.id === key);
          this.payment.discountPresetId = discountPreset.id;
          this.payment.discountType = discountPreset.discountType;
          this.payment.discountValue = discountPreset.discountValue;
        }
        this._calculatePayment();
      }

      _fetchDiscountPresetList(cbfn) {
        let data = { organizationId: this.app.organization.id };
        this.app.callGetDiscountPresetListApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response.discountPresetList);
        });
      }

      _processDiscountPresetList(cbfn) {
        if (this.isInOfflineMode) return cbfn(null);
        this._fetchDiscountPresetList(discountPresetList => {
          this.discountPresetList = discountPresetList;
          return cbfn();
        });
      }

      getDiscountPresetLabel(discountPreset) {
        let { name, discountType, discountValue } = discountPreset;
        if (discountType === 'percent') {
          return `${name} (${discountValue}%)`;
        } else {
          return `${name} (${discountValue} ${this.app.settings.monetaryUnit})`;
        }
      }

      // main payment calculation method
      _calculatePayment({ resetRounding = true } = {}) {
        let {
          totalAmount,
          vatAmount,
          discountType,
          discountValue,
          discountedAmount,
          serviceChargeAmount,
          totalBillBeforeRounding,
          roundedByAmount,
          totalBilled,
          shouldSaveChangeInAccount,
          paymentMethod,
          paidAmount,
          changeAmount,
          discountPresetId = null
        } = this.payment;

        // setting vatAmount to default value of 0 before calculating vatAmount on a loop
        vatAmount = 0;

        // reducing to find totalProductAmount
        let totalProductAmount = 0;
        totalProductAmount = this.productList.reduce((sum, product) => {
          let { salePrice, selectedCount, vatValue } = product;

          let salePriceForAllSelected = parseFloat(salePrice * selectedCount);

          // adding product vat value to to total vatAmount
          vatAmount += salePriceForAllSelected * (vatValue / 100);

          // the sum to be set as totalProductAmount
          return parseFloat(sum) + salePriceForAllSelected;
        }, 0);

        // reducing to find totalServiceAmount
        let totalServiceAmount = 0;
        totalServiceAmount = this.serviceList.reduce((sum, service) => {
          let { salePrice, vatValue } = service;

          // adding service vat value to to total vatAmount
          vatAmount += salePrice * (vatValue / 100);

          // the sum to be set as totalServiceAmount
          return parseFloat(sum) + parseFloat(salePrice);
        }, 0);

        // totalAmount of service and product sale price(s)
        totalAmount = parseFloat(totalProductAmount) + parseFloat(totalServiceAmount);

        // overall discount calculation
        if (discountValue) {
          if (discountType === 'percent') {
            discountedAmount = totalAmount * (discountValue / 100);
          } else if (discountType === 'fixed') {
            discountedAmount = discountValue;
          }
        }

        // updating totalBilled with calculated totalAmount, vatAmount and discountedAmount
        totalBilled = totalAmount + vatAmount - discountedAmount;
        this.totalBilledCopy = totalBilled;

        // service charge calculation
        if (serviceChargeAmount) {
          totalBilled += parseFloat(serviceChargeAmount);
        }

        // take rounding into account
        if (resetRounding) roundedByAmount = 0;
        totalBillBeforeRounding = totalBilled;
        totalBilled = totalBillBeforeRounding - roundedByAmount;

        // setting the default paid amount equal to total billed
        if (paymentMethod !== 'cash' && paidAmount < 1) {
          paidAmount = totalBilled;
        }

        // calculating change amount, paid amount depending on payment method
        if (paymentMethod === 'change-wallet') {
          changeAmount = 0;
          paidAmount = 0;
        } else {
          if (paidAmount > totalBilled) {
            changeAmount = paidAmount - totalBilled;
          } else {
            changeAmount = 0;
          }
        }

        // returning updated payment info
        this.payment = {
          totalAmount,
          vatAmount,
          discountType,
          discountValue,
          discountedAmount,
          serviceChargeAmount,
          totalBillBeforeRounding,
          roundedByAmount,
          totalBilled,
          paidAmount,
          changeAmount,
          shouldSaveChangeInAccount,
          paymentMethod,
          discountPresetId
        };
      }

      clearRounderByAmountTapped(e = null) {
        this.payment.roundedByAmount = 0;
        this._calculatePayment();
      }

      editTotalBilledTapped(e = null) {
        this.app.showModalInput(this.verses.sales.editBill, this.verses.sales.editBillDetails, this.payment.totalBilled, (answer) => {
          if (parseFloat(answer) > 0) {
            let roundedByAmount = (this.payment.totalBillBeforeRounding - parseFloat(answer));
            if (roundedByAmount < 0) {
              this.app.showModalDialog("Invalid amount", "You can not increase total billed amount. Please update individual prices or add service charge.");
              return;
            }
            this.payment.roundedByAmount = roundedByAmount;
            this._calculatePayment({ resetRounding: false });
          }
        });
      }

      _processAddSalesOnline(data, cbfn) {
        data.wasOfflineSale = false;
        this.app.callAddSalesApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          cbfn(response);
        });
      }

      _processAddSalesOffline(salesData, cbfn) {
        if (salesData.payment.totalBilled > salesData.payment.paidAmount) {
          this.app.showModalDialog(this.verses.general.errorMessageTitle, this.verses.pos.disallowCreditSale);
          return;
        }
        this.app.db.update('offline-data', (({ which }) => which === 'only'), offlineData => {
          if (!offlineData.data.unsyncedSalesIdSeed) offlineData.data.unsyncedSalesIdSeed = 0;
          offlineData.data.unsyncedSalesIdSeed += 1;
          salesData.id = 'OFFLINE-' + offlineData.data.unsyncedSalesIdSeed;
          salesData.createdDatetimeStamp = Date.now();
          offlineData.data.unsyncedSalesList.push(salesData);
          return offlineData;
        });
        cbfn({ salesId: salesData.id });
      }

      _processAddSales(cbfn) {
        let outletId = this.params.outlet;
        let payment = this.payment;

        let customerId = null;
        if (this.customer) {
          customerId = this.customer.id;
        }

        let productList = this.productList.map(product => {
          let { name, productId, selectedCount, salePrice, vatValue } = product;
          let vatPercentage = vatValue;
          let finalProduct = { productId, count: selectedCount, salePrice, vatPercentage };
          if (this.isInOfflineMode) {
            finalProduct.productBlueprintName = name;
            finalProduct.returnedProductCount = 0;
            finalProduct.count = parseInt(String(finalProduct.count));
          }
          return finalProduct;
        });

        let serviceList = this.serviceList.map(service => {
          let { id, salePrice, vatValue, assignedEmploymentId, name } = service;
          let serviceId = id;
          let vatPercentage = vatValue;
          let finalService = { serviceId, salePrice, vatPercentage, assignedEmploymentId };
          if (this.isInOfflineMode) {
            finalService.serviceBlueprintName = name;
          }
          return finalService;
        });

        let assistedByEmployeeId = (this.assignedAssistedByEmployee) ? this.assignedAssistedByEmployee.id : null;

        let productsSelectedFromWarehouseId = this.productsSelectedFromWarehouseId;

        if (this.isInOfflineMode && productsSelectedFromWarehouseId !== null) {
          return this.app.showModalDialog(this.verses.pos.saleNotValid, this.verses.pos.offlineWarehouseSellNotAllowed);
        }

        let data = {
          customerId, outletId, productList, serviceList, assistedByEmployeeId, payment,
          productsSelectedFromWarehouseId
        };

        if (this.isInOfflineMode) {
          this._processAddSalesOffline(data, cbfn);
        } else {
          this._processAddSalesOnline(data, cbfn);
        }
      }

      isDiscountTypePercent(discountType) {
        return (discountType === 'percent');
      }

      isPaymentMethodCash(paymentMethod) {
        return (paymentMethod === 'cash');
      }

      isPaymentMethodChangeWallet(paymentMethod) {
        return (paymentMethod === 'change-wallet');
      }

      isValidCreditSale(customer, totalBilled, paidAmount) {
        return (customer && totalBilled > paidAmount);
      }

      // region: finalize & offline mode =================================

      _resetSales({ refreshCurrentPage = true } = {}) {
        this.selectedDiscountPreset = '--no-discount';
        this.selectedWarehouse = '--current-outlet';
        this.productsSelectedFromWarehouseId = null;

        this.app.extractFromSession('pos-sales-type');

        this.app.extractFromSession('pos-selected-warehouse');
        this.app.extractFromSession('product-selected-from-warehouse-id');
        this.app.extractFromSession('last-selected-customer');

        this.app.extractFromSession('pos-selected-product-list');
        this.app.extractFromSession('pos-selected-service-list');

        this.app.extractFromSession('last-selected-customer');
        this.app.extractFromSession('last-selected-customer-is-anonymous');

        this.app.extractFromSession('pos-assigned-assisted-by-employee');

        this.productSearchString = '';
        this.serviceSearchString = '';
        this.resetProperties('payment', 'productList', 'serviceList', 'customer', 'isAnonymousSale', 'salesType', 'editCustomerForm');

        if (refreshCurrentPage) {
          this.app.refreshCurrentPage();
        }
      }

      saveSaleTapped(e = null) {
        this._processAddSales(({ salesId }) => {
          let message = this.app.verses.pos.newSalesAdded;
          this.app.showToast(message, _ => {
            this._resetSales();
          });
        });
      }

      saveSaleAndPrintTapped(e = null) {
        this._processAddSales(({ salesId }) => {
          this._resetSales();
          return this.app.navigateTo(`/print-sales-receipt/sales:${salesId}/from:pos`);
        });
      }

      toggleAllOfflineSalesTapped(e = null) {
        this.shouldExpandOfflineSalesList = !this.shouldExpandOfflineSalesList;
      }

      printOfflineSalesTapped(e) {
        return this.app.navigateTo(`/print-sales-receipt/sales:${e.model.unsyncedSales.id}/from:pos`);
      }

      discardOfflineSalesTapped(e) {
        let salesId = e.model.unsyncedSales.id;
        this.app.db.update('offline-data', (({ which }) => which === 'only'), offlineData => {
          let index = offlineData.data.unsyncedSalesList.findIndex(sales => sales.id === salesId);
          if (index > -1) {
            offlineData.data.unsyncedSalesList.splice(index, 1);
          }
          return offlineData;
        });
      }

      _submitAnOfflineSales(unsyncedSales, cbfn) {
        unsyncedSales = JSON.parse(JSON.stringify(unsyncedSales));

        // Remove temporarily added properties (that were required for offline preview)
        unsyncedSales.productList.forEach(product => {
          delete product.productBlueprintName;
          delete product.returnedProductCount;
        });
        unsyncedSales.serviceList.forEach(service => {
          delete service.serviceBlueprintName;
        });
        delete unsyncedSales.id;
        delete unsyncedSales.createdDatetimeStamp;

        unsyncedSales.wasOfflineSale = true;
        this.app.callAddSalesApi(unsyncedSales, (err, response) => {
          if (err) return cbfn(err, null, null);
          if (response.hasError) {
            return this.onApiError(response.error, null, () => {
              return cbfn(null, response.error, null);
            });
          }
          cbfn(null, null, response);
        });
      }

      goOnlineTapped() {
        if (this.isInOfflineMode) {
          this.app.callUserAssertApiKeyApi({}, (err, response) => {
            if (err) {
              this.app.showModalDialog(this.verses.root.networkErrorTitle, this.verses.root.networkErrorContent);
              return;
            }
            this.app.toggleOfflineMode();
          });
        }
      }

      submitAllOfflineSalesTapped(e) {
        let list = this.offlineData.data.unsyncedSalesList;
        let left = list.length;
        const submitNext = () => {
          if (!left) {
            if (this.isInOfflineMode) {
              this.app.toggleOfflineMode();
            }
            return;
          }

          left -= 1;
          let unsyncedSales = list[left];

          this._submitAnOfflineSales(unsyncedSales, (networkError, validationError, response) => {
            if (networkError) {
              return;
            }
            if (validationError) return submitNext();

            this.app.db.update('offline-data', (({ which }) => which === 'only'), offlineData => {
              let index = offlineData.data.unsyncedSalesList.findIndex(sales => sales.id === unsyncedSales.id);
              if (index > -1) {
                offlineData.data.unsyncedSalesList.splice(index, 1);
              }
              return offlineData;
            });

            submitNext();
          });

        }
        submitNext();
      }

      onOfflineDataChange() {
        this.isInOfflineMode = this.app.isInOfflineMode;
        this.offlineData = this.app.offlineData;

        // NOTE: Willingly written in an expressive manner
        if (this.isInOfflineMode) {
          this.app.currentPageAllowsBackButton = false;
        } else {
          this.app.currentPageAllowsBackButton = true;
        }
      }

      // region: misc =================================

      productListOrServiceListHasElement(productListLength, serviceListLength) {
        return (productListLength || serviceListLength);
      }

      assignEmployeeTapped(e) {
        let { id } = e.model.service;
        return this.app.navigateTo(`/pos-assign-employee-service/service:${id}`);
      }

      assignAssistedByEmployeeTapped() {
        return this.app.navigateTo(`/pos-assign-assisted-by-employee`);
      }

    }

    window.customElements.define(PagePos2.is, PagePos2);
  </script>
</dom-module>