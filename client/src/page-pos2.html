<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">

<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">

<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bower_components/baselib/baselib.html">

<link rel="import" href="../bower_components/polymer-fx/fx-page.html">
<link rel="import" href="../bower_components/polymer-fx/fx-common-behavior.html">

<link rel="import" href="torque-db-behavior.html">
<link rel="import" href="torque-common-behavior.html">
<link rel="import" href="torque-page-behavior.html">
<link rel="import" href="torque-language-behavior.html">

<link rel="import" href="shared-styles.html">

<link rel="import" href="elem-customer-selector.html">

<dom-module id="page-pos2">
  <template>
    <style include="shared-styles">

    </style>

    <elem-not-ready is-ready="[[isReady]]"></elem-not-ready>

    <div class$="page-fullwidth layout vertical [[$if(isReady, '', 'hidden')]]" id="wrapper">


    </div>

  </template>

  <script>
    class PagePos2 extends FxPage.mixin(TorqueCommonBehavior, TorquePageBehavior, TorqueDbBehavior, FxCommonBehavior, TorqueLanguageBehavior) {

      static get is() {
        return 'page-pos2';
      }

      static get properties() {
        return {
          isMobile: {
            type: Boolean,
            value: false
          },
          productList: {
            type: Array,
            value: () => []
          },
          serviceList: {
            type: Array,
            value: () => []
          },
          warehouseList: {
            type: Array,
            value: () => []
          },
          payment: {
            type: Object,
            value: () => {
              return {
                totalAmount: null,
                vatAmount: 0,
                discountType: 'percent',
                discountValue: 0,
                discountedAmount: 0,
                serviceChargeAmount: 0,
                totalBillBeforeRounding: 0,
                roundedByAmount: 0,
                totalBilled: null,
                shouldSaveChangeInAccount: false,
                paymentMethod: 'cash',
                paidAmount: 0,
                changeAmount: 0
              }
            }
          },
          isSearchingCustomer: {
            type: Boolean,
            value: false
          },
          customer: {
            type: Object,
            value: null,
            observer: 'customerChanged'
          },
          isInOfflineMode: {
            type: Boolean,
            value: false
          },
          shouldExpandOfflineSalesList: {
            type: Boolean,
            value: false
          },
          selectedDiscountPreset: {
            type: String,
            value: '--no-discount',
            observer: 'selectedDiscountPresetChanged'
          },
          selectedWarehouse: {
            type: String,
            value: '--current-outlet',
            observer: 'selectedWarehouseChanged'
          },
          productsSelectedFromWarehouseId: {
            type: Number,
            value: null,
          }
        };
      }

      // region: core =================================

      _detectIfMobile() {
        const minimumPageWidth = 960;
        const leftSidebarWidth = 280;
        if (window.innerWidth < (minimumPageWidth + leftSidebarWidth)) {
          this.isMobile = true;
        } else {
          this.isMobile = false;
        }
      }

      constructor() {
        super();
        this.confirmPageReady();
      }

      onNavigateIn() {
        this.app.shouldShowSaveButton = false;
        this.app.currentPageIsModal = true;
        this.useLanguageServices();
        this.onOfflineDataChange();
        this.onOrganizationChange(this.app.organization);
        this.app.pushPageTitle(this.app.verses.pos.posPageTitle);
        if (!'outlet' in this.params) {
          return this.app.showModalDialog(this.app.verses.general.errorMessageTitle, this.app.verses.general.somethingWentWrong, () => {
            return this.navigateTo('/home');
          });
        }
        if (!this._ensureAccess()) return;
        this.selectedDiscountPreset = '--no-discount';

        this.selectedWarehouse = this.app.getFromSession('pos-selected-warehouse') || '--current-outlet';
        this.productsSelectedFromWarehouseId = this.app.getFromSession('product-selected-from-warehouse-id') || null;

        this.assignedAssistedByEmployee = this.app.getFromSession('pos-assigned-assisted-by-employee');

        this._detectIfMobile();
        window.addEventListener('resize', () => this._detectIfMobile());

        this.delay(0, () => {
          this.self = this;
          let customerId = this.app.extractFromSession('last-created-customer');
          if (customerId) {
            this._processGetCustomer({ customerId }, (customer) => {
              this.customer = customer;
            });
          } else {
            let customer = this.app.getFromSession('last-selected-customer');
            if (customer) {
              this.customer = customer;
            }
          }

          let productList = this.app.getFromSession('pos-selected-product-list');
          if (productList) {
            if (this.productList.length > 0) {
              productList.forEach(newProduct => {
                let oldProduct = this.productList.find(oldProduct => oldProduct.productId === newProduct.productId);
                if (oldProduct) {
                  newProduct.salePrice = oldProduct.salePrice;
                }
              });
            }
            this.productList = productList;
          }

          let serviceList = this.app.getFromSession('pos-selected-service-list');
          if (serviceList) {
            this.serviceList = serviceList;
          }
          this._calculatePayment();
        });
        this._processDiscountPresetList(() => {

        });
        if (!this.isInOfflineMode) {
          this._fetchWarehouseList((warehouseList) => {
            warehouseList.reverse();
            this.warehouseList = warehouseList;
          });
        }
        this.delay(10, () => {
          if (!this._skipToProductOrServiceSelectionPage()) {
            this.isReady = true;
            this.jumpToPaymentIfPossible();
          }
        });
      }

      jumpToPaymentIfPossible() {
        this.delay(300, () => {
          try {
            this.elem('#sale-and-print-button').scrollIntoView({ block: "end", inline: "nearest" });
            this.delay(100, () => {
              try {
                let input = this.elem('.payment--paidAmount');
                input.click();
                this.delay(50, () => {
                  try {
                    input.focus();
                    this.delay(50, () => {
                      try {
                        input.inputElement.inputElement.select();
                      } catch (ex) { }
                    });
                  } catch (ex) { }
                });
              } catch (ex) { }
            });
          } catch (ex) { }
        });
      }

      selectedWarehouseChanged() {
        this.app.storeInSession('pos-selected-warehouse', this.selectedWarehouse);
      }

      _setProductSelectedFromWarehouseId(id) {
        this.productsSelectedFromWarehouseId = id;
        this.app.storeInSession('product-selected-from-warehouse-id', this.productsSelectedFromWarehouseId);
      }

      onNavigateOut() {
        super.onNavigateOut();
        this.app.currentPageAllowsBackButton = true;
        this.app.popPageTitle();
      }

      _ensureAccess() {
        return this.accessControl({
          authLevel: 'organization-selected',
          privilegeList: ['PRIV_ACCESS_POS']
        });
      }

      onOrganizationChange(organization) {
        this.organization = organization;
      }

      _skipToProductOrServiceSelectionPage() {
        if (this.app.pageName !== 'pos') return;
        if (this.hasModule('MOD_PRODUCT') && this.hasModule('MOD_SERVICE')) return;
        if (this.hasModule('MOD_SELL_WAREHOUSE_PRODUCTS')) return;
        if (window.isComingFromProductOrServiceSelection) {
          window.isComingFromProductOrServiceSelection = false;
          return;
        }
        if (this.productList.length > 0 || this.serviceList.length > 0) return;
        if (this.hasModule('MOD_PRODUCT')) {
          this.addProductTapped();
        }
        if (this.hasModule('MOD_SERVICE')) {
          this.addServiceTapped();
        }
        return true;
      }

      // region: pos =================================

      selectedDiscountPresetChanged() {
        if (this.selectedDiscountPreset === '--no-discount') {
          this.payment.discountPresetId = null;
          this.payment.discountType = 'percent';
          this.payment.discountValue = '0';
        } else {
          let key = parseInt(String(this.selectedDiscountPreset));
          let discountPreset = this.discountPresetList.find(discountPreset => discountPreset.id === key);
          this.payment.discountPresetId = discountPreset.id;
          this.payment.discountType = discountPreset.discountType;
          this.payment.discountValue = discountPreset.discountValue;
        }
        this._calculatePayment();
      }

      customerChanged() {
        if (!this.customer) return;
        this.app.storeInSession('last-selected-customer', this.customer);
      }

      _processGetCustomer({ customerId }, cbfn) {
        let data = {
          customerId
        };
        this.app.callGetCustomerApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          cbfn(response.customer);
        });
      }

      _processGetWarehouse(cbfn) {
        let data = { warehouseId: this.selectedWarehouse };
        this.app.callGetWarehouseApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response);
        });
      }

      _processGetOutletDefaultInventoryIdOnline(cbfn) {
        let data = { outletId: this.params.outlet };
        this.app.callGetOutletApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response.defaultInventory.id);
        });
      }

      _processGetOutletDefaultInventoryIdOffline(cbfn) {
        window.setTimeout(() => {
          cbfn(this.app.offlineData.cache.getOutlet.defaultInventory.id);
        }, 10);
      }

      _processGetOutletDefaultInventoryId(cbfn) {
        if (this.selectedWarehouse === '--current-outlet') {
          this._setProductSelectedFromWarehouseId(null);
          if (this.isInOfflineMode) {
            this._processGetOutletDefaultInventoryIdOffline(cbfn);
          } else {
            this._processGetOutletDefaultInventoryIdOnline(cbfn);
          }
        } else {
          if (this.isInOfflineMode) {
            return this.app.showModalDialog(this.verses.pos.saleNotValid, this.verses.pos.offlineWarehouseSellNotAllowed);
          } else {
            this._processGetWarehouse(({ defaultInventory, warehouse }) => {
              this._setProductSelectedFromWarehouseId(warehouse.id);
              return cbfn(defaultInventory.id);
            });
          }
        }
      }

      _fetchDiscountPresetList(cbfn) {
        let data = { organizationId: this.app.organization.id };
        this.app.callGetDiscountPresetListApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response.discountPresetList);
        });
      }

      _processDiscountPresetList(cbfn) {
        if (this.isInOfflineMode) return cbfn(null);
        this._fetchDiscountPresetList(discountPresetList => {
          this.discountPresetList = discountPresetList;
          return cbfn();
        });
      }

      // main payment calculation method
      _calculatePayment({ resetRounding = true } = {}) {
        let {
          totalAmount,
          vatAmount,
          discountType,
          discountValue,
          discountedAmount,
          serviceChargeAmount,
          totalBillBeforeRounding,
          roundedByAmount,
          totalBilled,
          shouldSaveChangeInAccount,
          paymentMethod,
          paidAmount,
          changeAmount,
          discountPresetId = null
        } = this.payment;

        // setting vatAmount to default value of 0 before calculating vatAmount on a loop
        vatAmount = 0;

        // reducing to find totalProductAmount
        let totalProductAmount = 0;
        totalProductAmount = this.productList.reduce((sum, product) => {
          let { salePrice, selectedCount, vatValue } = product;

          let salePriceForAllSelected = parseFloat(salePrice * selectedCount);

          // adding product vat value to to total vatAmount
          vatAmount += salePriceForAllSelected * (vatValue / 100);

          // the sum to be set as totalProductAmount
          return parseFloat(sum) + salePriceForAllSelected;
        }, 0);

        // reducing to find totalServiceAmount
        let totalServiceAmount = 0;
        totalServiceAmount = this.serviceList.reduce((sum, service) => {
          let { salePrice, vatValue } = service;

          // adding service vat value to to total vatAmount
          vatAmount += salePrice * (vatValue / 100);

          // the sum to be set as totalServiceAmount
          return parseFloat(sum) + parseFloat(salePrice);
        }, 0);

        // totalAmount of service and product sale price(s)
        totalAmount = parseFloat(totalProductAmount) + parseFloat(totalServiceAmount);

        // overall discount calculation
        if (discountValue) {
          if (discountType === 'percent') {
            discountedAmount = totalAmount * (discountValue / 100);
          } else if (discountType === 'fixed') {
            discountedAmount = discountValue;
          }
        }

        // updating totalBilled with calculated totalAmount, vatAmount and discountedAmount
        totalBilled = totalAmount + vatAmount - discountedAmount;
        this.totalBilledCopy = totalBilled;

        // service charge calculation
        if (serviceChargeAmount) {
          totalBilled += parseFloat(serviceChargeAmount);
        }

        // take rounding into account
        if (resetRounding) roundedByAmount = 0;
        totalBillBeforeRounding = totalBilled;
        totalBilled = totalBillBeforeRounding - roundedByAmount;

        // setting the default paid amount equal to total billed
        if (paymentMethod !== 'cash' && paidAmount < 1) {
          paidAmount = totalBilled;
        }

        // calculating change amount, paid amount depending on payment method
        if (paymentMethod === 'change-wallet') {
          changeAmount = 0;
          paidAmount = 0;
        } else {
          if (paidAmount > totalBilled) {
            changeAmount = paidAmount - totalBilled;
          } else {
            changeAmount = 0;
          }
        }

        // returning updated payment info
        this.payment = {
          totalAmount,
          vatAmount,
          discountType,
          discountValue,
          discountedAmount,
          serviceChargeAmount,
          totalBillBeforeRounding,
          roundedByAmount,
          totalBilled,
          paidAmount,
          changeAmount,
          shouldSaveChangeInAccount,
          paymentMethod,
          discountPresetId
        };
      }

      clearRounderByAmountTapped(e = null) {
        this.payment.roundedByAmount = 0;
        this._calculatePayment();
      }

      editProductSalePrice(e) {
        let { product } = e.model;
        this.app.showModalInput(this.verses.sales.editSalePrice, this.verses.sales.editSalePriceDetails, product.salePrice, (answer) => {
          let salePrice = parseFloat(answer);
          if (salePrice >= 0) {
            e.model.set('product.salePrice', salePrice);
            this._calculatePayment({ resetRounding: true });
          }
        });
      }

      editTotalBilledTapped(e = null) {
        this.app.showModalInput(this.verses.sales.editBill, this.verses.sales.editBillDetails, this.payment.totalBilled, (answer) => {
          if (parseFloat(answer) > 0) {
            this.payment.roundedByAmount = Math.max(0, (this.payment.totalBillBeforeRounding - parseFloat(answer)));
            this._calculatePayment({ resetRounding: false });
          }
        });
      }

      _processAddSalesOnline(data, cbfn) {
        data.wasOfflineSale = false;
        this.app.callAddSalesApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          cbfn(response);
        });
      }

      _processAddSalesOffline(salesData, cbfn) {
        if (salesData.payment.totalBilled > salesData.payment.paidAmount) {
          this.app.showModalDialog(this.verses.general.errorMessageTitle, this.verses.pos.disallowCreditSale);
          return;
        }
        this.app.db.update('offline-data', (({ which }) => which === 'only'), offlineData => {
          if (!offlineData.data.unsyncedSalesIdSeed) offlineData.data.unsyncedSalesIdSeed = 0;
          offlineData.data.unsyncedSalesIdSeed += 1;
          salesData.id = 'OFFLINE-' + offlineData.data.unsyncedSalesIdSeed;
          salesData.createdDatetimeStamp = Date.now();
          offlineData.data.unsyncedSalesList.push(salesData);
          return offlineData;
        });
        cbfn({ salesId: salesData.id });
      }

      _processAddSales(cbfn) {
        let outletId = this.params.outlet;
        let payment = this.payment;

        let customerId = null;
        if (this.customer) {
          customerId = this.customer.id;
        }

        let productList = this.productList.map(product => {
          let { name, productId, selectedCount, salePrice, vatValue } = product;
          let vatPercentage = vatValue;
          let finalProduct = { productId, count: selectedCount, salePrice, vatPercentage };
          if (this.isInOfflineMode) {
            finalProduct.productBlueprintName = name;
            finalProduct.returnedProductCount = 0;
            finalProduct.count = parseInt(String(finalProduct.count));
          }
          return finalProduct;
        });

        let serviceList = this.serviceList.map(service => {
          let { id, salePrice, vatValue, assignedEmploymentId, name } = service;
          let serviceId = id;
          let vatPercentage = vatValue;
          let finalService = { serviceId, salePrice, vatPercentage, assignedEmploymentId };
          if (this.isInOfflineMode) {
            finalService.serviceBlueprintName = name;
          }
          return finalService;
        });

        let assistedByEmployeeId = (this.assignedAssistedByEmployee) ? this.assignedAssistedByEmployee.id : null;

        let productsSelectedFromWarehouseId = this.productsSelectedFromWarehouseId;

        if (this.isInOfflineMode && productsSelectedFromWarehouseId !== null) {
          return this.app.showModalDialog(this.verses.pos.saleNotValid, this.verses.pos.offlineWarehouseSellNotAllowed);
        }

        let data = {
          customerId, outletId, productList, serviceList, assistedByEmployeeId, payment,
          productsSelectedFromWarehouseId
        };

        if (this.isInOfflineMode) {
          this._processAddSalesOffline(data, cbfn);
        } else {
          this._processAddSalesOnline(data, cbfn);
        }
      }

      _resetSales({ refreshCurrentPage = true } = {}) {
        this.selectedDiscountPreset = '--no-discount';
        this.selectedWarehouse = '--current-outlet';
        this.productsSelectedFromWarehouseId = null;

        this.app.extractFromSession('pos-selected-warehouse');
        this.app.extractFromSession('product-selected-from-warehouse-id');

        this.app.extractFromSession('pos-selected-product-list');
        this.app.extractFromSession('pos-selected-service-list');

        this.app.extractFromSession('last-selected-customer');

        this.app.extractFromSession('pos-assigned-assisted-by-employee');

        this.resetProperties('payment', 'productList', 'serviceList', 'customer', 'isSearchingCustomer');

        if (refreshCurrentPage) {
          this.app.refreshCurrentPage();
        }
      }

      _customerSelected(customer) {
        this.customer = customer;
        this.isSearchingCustomer = false;
      }

      _fetchWarehouseList(cbfn) {
        if (!this.hasModule('MOD_SELL_WAREHOUSE_PRODUCTS')) {
          return cbfn([]);
        }
        let data = { organizationId: this.app.organization.id };
        this.app.callGetWarehouseListApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response.warehouseList);
        });
      }

      // region: ui =================================

      changeCustomerTapped(e = null) {
        this.isSearchingCustomer = true;
      }

      createCustomerTapped(e = null) {
        this.app.navigateTo('/edit-customer');
      }

      removeCustomerTapped(e = null) {
        this.customer = null;
        this.app.storeInSession('last-selected-customer', null);
      }

      addProductTapped(e = null) {
        this._processGetOutletDefaultInventoryId(defaultInventoryId => {
          return this.app.navigateTo(`/pos-select-products/inventory:${defaultInventoryId}`);
        })
      }

      addServiceTapped(e = null) {
        return this.app.navigateTo(`/pos-select-services/outlet:${this.params.outlet}`);
      }

      paymentMethodSelected(e) {
        // NOTE: The timeout should not be necessary. However, without it
        // the value of this.payment.paymentMethod is not being updated in time.
        window.setTimeout(() => {
          this._calculatePayment();
        }, 100);
      }

      genericPaymentInputChanged(e) {
        this.enforceMinMaxOnPaperInput(e);
        if (e.target.className.indexOf('payment--paidAmount') > -1) {
          this._calculatePayment({ resetRounding: false });
        } else {
          this._calculatePayment();
        }
      }

      backButtonOnTopBarPressed(e = null) {
        this._resetSales();
        this.app.navigateToPreviousUrl('/home');
      }

      saveSaleTapped(e = null) {
        this._processAddSales(({ salesId }) => {
          let message = this.app.verses.pos.newSalesAdded;
          this.app.showToast(message, _ => {
            this._resetSales();
          });
        });
      }

      saveSaleAndPrintTapped(e = null) {
        this._processAddSales(({ salesId }) => {
          this._resetSales();
          return this.app.navigateTo(`/print-sales-receipt/sales:${salesId}/from:pos`);
        });
      }

      toggleAllOfflineSalesTapped(e = null) {
        this.shouldExpandOfflineSalesList = !this.shouldExpandOfflineSalesList;
      }

      printOfflineSalesTapped(e) {
        return this.app.navigateTo(`/print-sales-receipt/sales:${e.model.unsyncedSales.id}/from:pos`);
      }

      discardOfflineSalesTapped(e) {
        let salesId = e.model.unsyncedSales.id;
        this.app.db.update('offline-data', (({ which }) => which === 'only'), offlineData => {
          let index = offlineData.data.unsyncedSalesList.findIndex(sales => sales.id === salesId);
          if (index > -1) {
            offlineData.data.unsyncedSalesList.splice(index, 1);
          }
          return offlineData;
        });
      }

      _submitAnOfflineSales(unsyncedSales, cbfn) {
        unsyncedSales = JSON.parse(JSON.stringify(unsyncedSales));

        // Remove temporarily added properties (that were required for offline preview)
        unsyncedSales.productList.forEach(product => {
          delete product.productBlueprintName;
          delete product.returnedProductCount;
        });
        unsyncedSales.serviceList.forEach(service => {
          delete service.serviceBlueprintName;
        });
        delete unsyncedSales.id;
        delete unsyncedSales.createdDatetimeStamp;

        unsyncedSales.wasOfflineSale = true;
        this.app.callAddSalesApi(unsyncedSales, (err, response) => {
          if (err) return cbfn(err, null, null);
          if (response.hasError) {
            return this.onApiError(response.error, null, () => {
              return cbfn(null, response.error, null);
            });
          }
          cbfn(null, null, response);
        });
      }

      goOnlineTapped() {
        if (this.isInOfflineMode) {
          this.app.callUserAssertApiKeyApi({}, (err, response) => {
            if (err) {
              this.app.showModalDialog(this.verses.root.networkErrorTitle, this.verses.root.networkErrorContent);
              return;
            }
            this.app.toggleOfflineMode();
          });
        }
      }

      submitAllOfflineSalesTapped(e) {
        let list = this.offlineData.data.unsyncedSalesList;
        let left = list.length;
        const submitNext = () => {
          if (!left) {
            if (this.isInOfflineMode) {
              this.app.toggleOfflineMode();
            }
            return;
          }

          left -= 1;
          let unsyncedSales = list[left];

          this._submitAnOfflineSales(unsyncedSales, (networkError, validationError, response) => {
            if (networkError) {
              return;
            }
            if (validationError) return submitNext();

            this.app.db.update('offline-data', (({ which }) => which === 'only'), offlineData => {
              let index = offlineData.data.unsyncedSalesList.findIndex(sales => sales.id === unsyncedSales.id);
              if (index > -1) {
                offlineData.data.unsyncedSalesList.splice(index, 1);
              }
              return offlineData;
            });

            submitNext();
          });

        }
        submitNext();
      }

      isDiscountTypePercent(discountType) {
        return (discountType === 'percent');
      }

      isPaymentMethodCash(paymentMethod) {
        return (paymentMethod === 'cash');
      }

      isPaymentMethodChangeWallet(paymentMethod) {
        return (paymentMethod === 'change-wallet');
      }

      isValidCreditSale(customer, totalBilled, paidAmount) {
        return (customer && totalBilled > paidAmount);
      }

      assignEmployeeTapped(e) {
        let { id } = e.model.service;
        return this.app.navigateTo(`/pos-assign-employee-service/service:${id}`);
      }

      assignAssistedByEmployeeTapped() {
        return this.app.navigateTo(`/pos-assign-assisted-by-employee`);
      }

      $shouldShowWarehouseSelector(warehouseListLength, productListLength) {
        return (warehouseListLength > 0 && productListLength === 0);
      }

      // region: misc =================================

      productListOrServiceListHasElement(productListLength, serviceListLength) {
        return (productListLength || serviceListLength);
      }

      getDiscountPresetLabel(discountPreset) {
        let { name, discountType, discountValue } = discountPreset;
        if (discountType === 'percent') {
          return `${name} (${discountValue}%)`;
        } else {
          return `${name} (${discountValue} ${this.app.settings.monetaryUnit})`;
        }
      }

      // region: offline sales =================================

      onOfflineDataChange() {
        this.isInOfflineMode = this.app.isInOfflineMode;
        this.offlineData = this.app.offlineData;

        // NOTE: Willingly written in an expressive manner
        if (this.isInOfflineMode) {
          this.app.currentPageAllowsBackButton = false;
        } else {
          this.app.currentPageAllowsBackButton = true;
        }
      }

    }

    window.customElements.define(PagePos2.is, PagePos2);
  </script>
</dom-module>