<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">

<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">

<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bower_components/baselib/baselib.html">

<link rel="import" href="../bower_components/polymer-fx/fx-page.html">
<link rel="import" href="../bower_components/polymer-fx/fx-common-behavior.html">

<link rel="import" href="torque-db-behavior.html">
<link rel="import" href="torque-common-behavior.html">
<link rel="import" href="torque-page-behavior.html">
<link rel="import" href="torque-language-behavior.html">

<link rel="import" href="shared-styles.html">

<link rel="import" href="elem-customer-selector.html">

<dom-module id="page-pos">
  <template>
    <style include="shared-styles">
      .select-product-button-container paper-button {
        width: 100%;
        margin: 5px;
      }

      .individual-calculation-field-container {
        border: 1px solid #eee;
        background-color: #f7f7f7;
        padding: 6px;
        margin: 8px 0px;
      }

      .individual-calculation-field-container.light {
        background-color: white;
      }

      .full-width-paper-dropdown {
        width: 100%;
      }

      .height-adjusted {
        margin-top: -14px;
      }

      .product-title {
        font-weight: bold;
      }

      .product-discount-vat-detail {
        font-size: 11px;
      }

      .service-info {
        flex: 1;
        /* border: 1px solid blue; */
      }

      .service-title {
        font-weight: bold;
      }

      .service-vat-detail {
        font-size: 11px;
        margin-left: 6px;
      }

      .service-customer-required {
        font-size: 11px;
        font-weight: bold;
      }

      .employee-icon-container {
        padding: 10px;
      }

      .employee-icon-container-active {
        padding: 10px;
        color: var(--app-button-primary);
      }

      .assign-icon {
        margin-right: 4px;
      }

      .m-top-16 {
        margin-top: 16px;
      }

      .m-bottom-18 {
        margin-bottom: 18px;
      }

      .card.warning {
        background: var(--app-button-alternative);
      }

      .bold-customer-card-title {
        font-weight: bold;
      }
    </style>

    <elem-not-ready is-ready="[[isReady]]"></elem-not-ready>

    <div class$="page layout vertical [[$if(isReady, '', 'hidden')]]" id="wrapper">

      <template is="dom-if" if="[[isInOfflineMode]]">
        <div class="card warning vertical layout">
          <div class="flex">[[verses.pos.offlineModeWarning]]</div>
          <paper-button raised class="primary btn" on-tap="goOnlineTapped">
            [[verses.pos.goOnline]]
          </paper-button>
        </div>
      </template>

      <template is="dom-if" if="[[offlineData.data.unsyncedSalesList.length]]">
        <div class="card vertical layout">

          <div class="vertical layout">
            <div class="flex">[[offlineData.data.unsyncedSalesList.length]] [[verses.pos.offlineSaleCountMessage]]</div>
            <div class="horizontal layout">
              <paper-button raised class="secondary btn" style="width: 100%;" on-tap="toggleAllOfflineSalesTapped">
                [[verses.pos.showHideButton]]
              </paper-button>

              <paper-button raised class="primary btn" style="width: 100%;" on-tap="submitAllOfflineSalesTapped">
                [[verses.pos.submitOfflineSales]]
              </paper-button>
            </div>
          </div>

          <template is="dom-if" if="[[shouldExpandOfflineSalesList]]">
            <div class="list m-top-16">
              <template is="dom-repeat" items="[[offlineData.data.unsyncedSalesList]]" as="unsyncedSales">
                <div class="horizontal layout item center">
                  <div class="flex">
                    <b>[[unsyncedSales.id]]</b> <br>
                    [[verses.pos.createdOfflineSaleDatetime]]: [[$mkDate(unsyncedSales.createdDatetimeStamp, 'hh:mmtt dd-MM-yyyy')]]
                  </div>

                  <div class="vertical layout">
                    <paper-button raised class="secondary btn btn-default slim" on-tap="printOfflineSalesTapped">
                      [[verses.general.print]]
                    </paper-button>
                    <paper-button raised class="danger btn btn-default slim" style="margin-top: 6px;" on-tap="discardOfflineSalesTapped">
                      [[verses.general.discard]]
                    </paper-button>
                  </div>

                </div>
              </template>
            </div>
          </template>

        </div>
      </template>

      <!-- customer selector - start -->
      <template is="dom-if" if="[[!isInOfflineMode]]">
        <template is="dom-if" if="[[!isSearchingCustomer]]">
          <div class="card vertical layout">
            <div class="horizontal layout center">
              <div class="flex">
                <div class="bold-customer-card-title">[[verses.pos.customerSelectionCardHeader]]</div>

                <template is="dom-if" if="[[customer]]">
                  <div>
                    <div class="type title capitalize">[[customer.fullName]]</div>
                    <div class="horizontal layout wrap">
                      <div class="horizontal layout center m-right-8">
                        <iron-icon icon="hardware:smartphone" class="icon secondary small m-right-8"></iron-icon>
                        <div class="type body secondary">[[customer.phone]]</div>
                      </div>

                      <template is="dom-if" if="[[hasModule('MOD_CUSTOMER_ACCOUNT_BALANCE')]]">
                        <div class="horizontal layout center">
                          <iron-icon icon="icons:account-balance-wallet" class="icon secondary small m-right-8"></iron-icon>
                          <div class="type body secondary">[[customer.changeWalletBalance]] [[page.app.settings.monetaryUnit]]</div>
                        </div>
                      </template>

                    </div>
                  </div>
                </template>
              </div>
            </div>

            <div class="horizontal layout end-justified m-top-16">
              <template is="dom-if" if="[[customer]]">
                <paper-button raised class="danger btn btn-default" on-tap="removeCustomerTapped">
                  [[verses.pos.removeCustomer]]
                </paper-button>
              </template>
              <paper-button raised class="secondary btn btn-default" on-tap="changeCustomerTapped">
                [[verses.pos.changeCustomer]]
              </paper-button>
              <paper-button raised class="btn secondary" on-tap="createCustomerTapped">
                [[verses.pos.createCustomer]]
              </paper-button>
            </div>
          </div>
        </template>
        <elem-customer-selector page="{{self}}" class$="[[$if(isSearchingCustomer, '', 'hidden')]]"></elem-customer-selector>
      </template>
      <!-- customer selector - end -->

      <!-- selected product list - start -->
      <template is="dom-if" if="[[hasModule('MOD_PRODUCT')]]">
        <div class="card vertical layout">
          <div class="list">

            <template is="dom-repeat" items="[[productList]]" as="product">
              <div class="horizontal layout item center">
                <div class="vertical layout flex">
                  <div>
                    <span class="product-title">[[product.name]]</span>
                    <span class="product-discount-vat-detail">

                      <span>([[verses.pos.vat]]: {{product.vatValue}}%)</span>

                    </span>
                  </div>
                  <div class="horizontal layout center">
                    <div class="description">[[product.selectedCount]] [[product.unit]] @&nbsp;</div>
                    <!-- <paper-input class="flex height-adjusted" value="{{product.salePrice}}" on-change="genericPaymentInputChanged" type="number" auto-validate min="[[product.minSalePrice]]"></paper-input> -->
                    <div>[[product.salePrice]]</div>
                    <div class="description">[[app.settings.monetaryUnit]]</div>
                  </div>
                </div>
              </div>
            </template>

            <!-- warehouse selection - start -->
            <template is="dom-if" if="[[hasModule('MOD_SELL_WAREHOUSE_PRODUCTS')]]">
              <template is="dom-if" if="[[$shouldShowWarehouseSelector(warehouseList.length, productList.length)]]">
                <div>

                  <paper-dropdown-menu class="full-width-paper-dropdown" label="[[verses.pos.selectProductsFromInventoryContainer]]" class="mr-4">
                    <paper-listbox slot="dropdown-content" selected="{{selectedWarehouse}}" attr-for-selected="name">
                      <paper-item name="--current-outlet">[[verses.pos.currentOutlet]]</paper-item>
                      <template is="dom-repeat" items="[[warehouseList]]" as="warehouse">
                        <paper-item name="[[warehouse.id]]">
                          <div class="name">[[warehouse.name]]</div>
                        </paper-item>
                      </template>
                    </paper-listbox>
                  </paper-dropdown-menu>

                </div>
              </template>
            </template>
            <!-- warehouse selection - end -->

            <div class="select-product-button-container">
              <paper-button raised class="btn primary" on-tap="addProductTapped">[[verses.pos.selectProduct]]</paper-button>
            </div>

          </div>
        </div>
      </template>
      <!-- selected product list - end -->

      <!-- selected service list - start -->
      <template is="dom-if" if="[[!isInOfflineMode]]">
        <template is="dom-if" if="[[hasModule('MOD_SERVICE')]]">
          <div class="card vertical layout">
            <div class="list">

              <template is="dom-repeat" items="[[serviceList]]" as="service">
                <div class="horizontal layout item center">
                  <div class="vertical layout flex">

                    <div class="horizontal layout center">
                      <div class="service-info">
                        <span class="service-title">[[service.name]]</span>
                        <span class="service-vat-detail">([[verses.pos.vat]]: {{service.vatValue}}%)</span>
                      </div>

                      <template is="dom-if" if="{{service.isEmployeeAssignable}}">

                        <template is="dom-if" if="{{service.assignedEmploymentId}}">
                          <div class="employee-icon-container-active" on-tap="assignEmployeeTapped">
                            <iron-icon icon="icons:account-circle" class="assign-icon"></iron-icon>[[verses.pos.assignedEmployee]]
                          </div>
                        </template>

                        <template is="dom-if" if="{{!service.assignedEmploymentId}}">
                          <div class="employee-icon-container" on-tap="assignEmployeeTapped">
                            <iron-icon icon="icons:account-circle" class="assign-icon"></iron-icon>[[verses.pos.assignEmployee]]
                          </div>
                        </template>

                      </template>
                    </div>

                    <template is="dom-if" if="{{service.isCustomerRequired}}">
                      <span class="service-customer-required">*[[verses.pos.serviceRequiresCustomerSelection]]</span>
                    </template>

                    <div class="horizontal layout center">
                      <paper-input class="flex height-adjusted" value="{{service.salePrice}}" min="[[service.minSalePrice]]" on-change="genericPaymentInputChanged" type="number" auto-validate></paper-input>
                      <div class="description">[[app.settings.monetaryUnit]]</div>
                    </div>

                  </div>
                </div>
              </template>

              <div class="select-product-button-container">
                <paper-button raised class="btn primary" on-tap="addServiceTapped">[[verses.pos.selectService]]</paper-button>
              </div>

            </div>
          </div>
        </template>
      </template>
      <!-- selected service list - end -->

      <!-- calculations - start -->
      <template is="dom-if" if="[[productListOrServiceListHasElement(productList.length, serviceList.length)]]">
        <div class="card vertical layout">
          <div class="individual-calculation-field-container">
            <span>[[verses.pos.totalSalePrice]]: <b>{{$round(payment.totalAmount)}} [[app.settings.monetaryUnit]]</b></span>
          </div>
        </div>
      </template>

      <template is="dom-if" if="[[productListOrServiceListHasElement(productList.length, serviceList.length)]]">
        <div class="card vertical layout">
          <div class="list">

            <div class="individual-calculation-field-container">
              [[verses.pos.vatAmount]]:
              <b>{{$round(payment.vatAmount)}} [[app.settings.monetaryUnit]]</b>

            </div>

            <div class="individual-calculation-field-container">

              <div class="vertical layout m-bottom-18">

                <paper-dropdown-menu class="full-width-paper-dropdown" label="[[verses.pos.discount]]" class="mr-4">
                  <paper-listbox slot="dropdown-content" selected="{{selectedDiscountPreset}}" attr-for-selected="name">
                    <paper-item name="--no-discount">[[verses.pos.noDiscountApplicable]]</paper-item>
                    <template is="dom-repeat" items="[[discountPresetList]]" as="discountPreset">
                      <paper-item name="[[discountPreset.id]]">
                        <div class="name">[[discountPreset.name]]</div>
                        <template is="dom-if" if="[[$equals(discountPreset.discountType, 'percent')]]">
                          <div>&nbsp;([[discountPreset.discountValue]]%)</div>
                        </template>
                        <template is="dom-if" if="[[$equals(discountPreset.discountType, 'fixed')]]">
                          <div>&nbsp;([[discountPreset.discountValue]] [[app.settings.monetaryUnit]])</div>
                        </template>
                      </paper-item>
                    </template>
                  </paper-listbox>
                </paper-dropdown-menu>

              </div>

              [[verses.pos.discountedAmount]]:
              <b>{{$round(payment.discountedAmount)}} [[app.settings.monetaryUnit]]</b>

            </div>

            <div class="individual-calculation-field-container horizontal layout center">

              <paper-input class="payment--serviceChargeAmount flex" value="{{payment.serviceChargeAmount}}" on-change="genericPaymentInputChanged" type="number" required min="0" error-message="[[verses.pos.serviceChargeInputError]]" label="[[verses.pos.serviceChargeInput]]">
                <div slot="suffix">[[app.settings.monetaryUnit]]</div>
              </paper-input>

              <template is="dom-if" if="{{!isInOfflineMode}}">

                <template is="dom-if" if="{{assignedAssistedByEmployee}}">
                  <div class="employee-icon-container-active" on-tap="assignAssistedByEmployeeTapped">
                    <iron-icon icon="icons:account-circle" class="assign-icon"></iron-icon>[[verses.pos.assistedEmployee]]
                  </div>
                </template>

                <template is="dom-if" if="{{!assignedAssistedByEmployee}}">
                  <div class="employee-icon-container" on-tap="assignAssistedByEmployeeTapped">
                    <iron-icon icon="icons:account-circle" class="assign-icon"></iron-icon>[[verses.pos.assistedEmployee]]
                  </div>
                </template>

              </template>

            </div>

          </div>
        </div>
      </template>

      <!-- payment area card - start -->
      <template is="dom-if" if="[[productListOrServiceListHasElement(productList.length, serviceList.length)]]">
        <div class="card vertical layout" style="background: var(--app-primary-color-light);">
          <div class="list">

            <template is="dom-if" if="[[payment.roundedByAmount]]">
              <div class="individual-calculation-field-container light">
                <div class="horizontal layout center m-top-16">
                  <div class="flex">
                    [[verses.sales.totalBillBeforeRounding]]:
                    <b>{{$round(payment.totalBillBeforeRounding)}} [[app.settings.monetaryUnit]]</b>
                  </div>
                </div>
                <div class="horizontal layout center">
                  <div class="flex">
                    [[verses.sales.roundedByAmount]]:
                    <b>{{$round(payment.roundedByAmount)}} [[app.settings.monetaryUnit]]</b>
                  </div>
                  <paper-icon-button on-tap="clearRounderByAmountTapped" icon="clear"></paper-icon-button>
                </div>
              </div>
            </template>
            <div class="horizontal layout center individual-calculation-field-container light">
              <div class="flex">
                [[verses.pos.totalBilled]]:
                <b>{{$round(payment.totalBilled)}} [[app.settings.monetaryUnit]]</b>
              </div>
              <template is="dom-if" if="[[hasPrivilege('PRIV_ALLOW_FLEXIBLE_PRICE', organization)]]">
                <paper-icon-button on-tap="editTotalBilledTapped" icon="create"></paper-icon-button>
              </template>
            </div>

            <div class="individual-calculation-field-container light">

              <paper-dropdown-menu class="full-width-paper-dropdown" label="[[verses.pos.paymentMethod]]" class="mr-4" on-iron-select="paymentMethodSelected">
                <paper-listbox slot="dropdown-content" selected="{{payment.paymentMethod}}" attr-for-selected="name">
                  <paper-item name="cash">[[verses.general.cash]]</paper-item>
                  <paper-item name="card">[[verses.general.card]]</paper-item>
                  <paper-item name="digital">[[verses.general.digital]]</paper-item>
                  <template is="dom-if" if="[[customer]]">
                    <paper-item name="change-wallet">[[verses.general.balance]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>

              <template is="dom-if" if="[[!isPaymentMethodChangeWallet(payment.paymentMethod)]]">
                <paper-input class="payment--paidAmount flex" value="{{payment.paidAmount}}" on-change="genericPaymentInputChanged" on-input="genericPaymentInputChanged" type="number" required min="0" error-message="[[verses.pos.paidAmountInputError]]" label="[[verses.pos.paidAmountInput]]">
                  <div slot="suffix">[[app.settings.monetaryUnit]]</div>
                </paper-input>
              </template>

              <template is="dom-if" if="[[payment.changeAmount]]">
                <br> [[verses.pos.changeAmount]]:
                <b>{{$round(payment.changeAmount)}} [[app.settings.monetaryUnit]]</b>

                <br>
                <template is="dom-if" if="[[hasModule('MOD_CUSTOMER_ACCOUNT_BALANCE')]]">
                  <template is="dom-if" if="[[customer]]">
                    <template is="dom-if" if="[[payment.changeAmount]]">
                      <paper-checkbox checked="{{payment.shouldSaveChangeInAccount}}">
                        [[verses.pos.shouldSaveChangeInAccount]]
                      </paper-checkbox>
                    </template>
                  </template>
                </template>

              </template>

              <template is="dom-if" if="[[isValidCreditSale(customer, payment.totalBilled, payment.paidAmount)]]">
                [[verses.pos.thisWillBeACreditSale]]
              </template>

            </div>

            <div class="horizontal layout m-top-16">
              <paper-button raised class="primary flex" on-tap="saveSaleTapped">[[verses.pos.confirmSales]]</paper-button>
            </div>

            <div class="horizontal layout m-top-16">
              <paper-button id="sale-and-print-button" raised class="primary flex" on-tap="saveSaleAndPrintTapped">[[verses.pos.confirmSalesAndPrint]]</paper-button>
            </div>

          </div>
        </div>
      </template>
      <!-- payment area card - end -->
      <!-- calculations - end -->

    </div>

  </template>

  <script>
    class PagePos extends FxPage.mixin(TorqueCommonBehavior, TorquePageBehavior, TorqueDbBehavior, FxCommonBehavior, TorqueLanguageBehavior) {

      static get is() {
        return 'page-pos';
      }

      static get properties() {
        return {
          productList: {
            type: Array,
            value: () => []
          },
          serviceList: {
            type: Array,
            value: () => []
          },
          warehouseList: {
            type: Array,
            value: () => []
          },
          payment: {
            type: Object,
            value: () => {
              return {
                totalAmount: null,
                vatAmount: 0,
                discountType: 'percent',
                discountValue: 0,
                discountedAmount: 0,
                serviceChargeAmount: 0,
                totalBillBeforeRounding: 0,
                roundedByAmount: 0,
                totalBilled: null,
                shouldSaveChangeInAccount: false,
                paymentMethod: 'cash',
                paidAmount: 0,
                changeAmount: 0
              }
            }
          },
          isSearchingCustomer: {
            type: Boolean,
            value: false
          },
          customer: {
            type: Object,
            value: null,
            observer: 'customerChanged'
          },
          isInOfflineMode: {
            type: Boolean,
            value: false
          },
          shouldExpandOfflineSalesList: {
            type: Boolean,
            value: false
          },
          selectedDiscountPreset: {
            type: String,
            value: '--no-discount',
            observer: 'selectedDiscountPresetChanged'
          },
          selectedWarehouse: {
            type: String,
            value: '--current-outlet',
            observer: 'selectedWarehouseChanged'
          },
          productsSelectedFromWarehouseId: {
            type: Number,
            value: null,
          }
        };
      }

      // region: core =================================

      constructor() {
        super();
        this.confirmPageReady();
      }

      onNavigateIn() {
        this.app.shouldShowSaveButton = false;
        this.app.currentPageIsModal = true;
        this.useLanguageServices();
        this.onOfflineDataChange();
        this.onOrganizationChange(this.app.organization);
        this.app.pushPageTitle(this.app.verses.pos.posPageTitle);
        if (!'outlet' in this.params) {
          return this.app.showModalDialog(this.app.verses.general.errorMessageTitle, this.app.verses.general.somethingWentWrong, () => {
            return this.navigateTo('/home');
          });
        }
        if (!this._ensureAccess()) return;
        this.selectedDiscountPreset = '--no-discount';

        this.selectedWarehouse = this.app.getFromSession('pos-selected-warehouse') || '--current-outlet';
        this.productsSelectedFromWarehouseId = this.app.getFromSession('product-selected-from-warehouse-id') || null;

        this.assignedAssistedByEmployee = this.app.getFromSession('pos-assigned-assisted-by-employee');

        this.delay(0, () => {
          this.self = this;
          let customerId = this.app.extractFromSession('last-created-customer');
          if (customerId) {
            this._processGetCustomer({ customerId }, (customer) => {
              this.customer = customer;
            });
          } else {
            let customer = this.app.getFromSession('last-selected-customer');
            if (customer) {
              this.customer = customer;
            }
          }

          let productList = this.app.getFromSession('pos-selected-product-list');
          if (productList) {
            this.productList = productList;
          }

          let serviceList = this.app.getFromSession('pos-selected-service-list');
          if (serviceList) {
            this.serviceList = serviceList;
          }
          this._calculatePayment();
        });
        this._processDiscountPresetList(() => {

        });
        if (!this.isInOfflineMode) {
          this._fetchWarehouseList((warehouseList) => {
            warehouseList.reverse();
            this.warehouseList = warehouseList;
          });
        }
        this.delay(10, () => {
          if (!this._skipToProductOrServiceSelectionPage()) {
            this.isReady = true;
            this.jumpToPaymentIfPossible();
          }
        });
      }

      jumpToPaymentIfPossible() {
        this.delay(300, () => {
          try {
            this.elem('#sale-and-print-button').scrollIntoView({ block: "end", inline: "nearest" });
            this.delay(100, () => {
              try {
                let input = this.elem('.payment--paidAmount');
                input.click();
                this.delay(50, () => {
                  try {
                    input.focus();
                    this.delay(50, () => {
                      try {
                        input.inputElement.inputElement.select();
                      } catch (ex) { }
                    });
                  } catch (ex) { }
                });
              } catch (ex) { }
            });
          } catch (ex) { }
        });
      }

      selectedWarehouseChanged() {
        this.app.storeInSession('pos-selected-warehouse', this.selectedWarehouse);
      }

      _setProductSelectedFromWarehouseId(id) {
        this.productsSelectedFromWarehouseId = id;
        this.app.storeInSession('product-selected-from-warehouse-id', this.productsSelectedFromWarehouseId);
      }

      onNavigateOut() {
        super.onNavigateOut();
        this.app.currentPageAllowsBackButton = true;
        this.app.popPageTitle();
      }

      _ensureAccess() {
        return this.accessControl({
          authLevel: 'organization-selected',
          privilegeList: ['PRIV_ACCESS_POS']
        });
      }

      onOrganizationChange(organization) {
        this.organization = organization;
      }

      _skipToProductOrServiceSelectionPage() {
        if (this.app.pageName !== 'pos') return;
        if (this.hasModule('MOD_PRODUCT') && this.hasModule('MOD_SERVICE')) return;
        if (this.hasModule('MOD_SELL_WAREHOUSE_PRODUCTS')) return;
        if (window.isComingFromProductOrServiceSelection) {
          window.isComingFromProductOrServiceSelection = false;
          return;
        }
        if (this.productList.length > 0 || this.serviceList.length > 0) return;
        if (this.hasModule('MOD_PRODUCT')) {
          this.addProductTapped();
        }
        if (this.hasModule('MOD_SERVICE')) {
          this.addServiceTapped();
        }
        return true;
      }

      // region: pos =================================

      selectedDiscountPresetChanged() {
        if (this.selectedDiscountPreset === '--no-discount') {
          this.payment.discountPresetId = null;
          this.payment.discountType = 'percent';
          this.payment.discountValue = '0';
        } else {
          let key = parseInt(String(this.selectedDiscountPreset));
          let discountPreset = this.discountPresetList.find(discountPreset => discountPreset.id === key);
          this.payment.discountPresetId = discountPreset.id;
          this.payment.discountType = discountPreset.discountType;
          this.payment.discountValue = discountPreset.discountValue;
        }
        this._calculatePayment();
      }

      customerChanged() {
        if (!this.customer) return;
        this.app.storeInSession('last-selected-customer', this.customer);
      }

      _processGetCustomer({ customerId }, cbfn) {
        let data = {
          customerId
        };
        this.app.callGetCustomerApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          cbfn(response.customer);
        });
      }

      _processGetWarehouse(cbfn) {
        let data = { warehouseId: this.selectedWarehouse };
        this.app.callGetWarehouseApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response);
        });
      }

      _processGetOutletDefaultInventoryIdOnline(cbfn) {
        let data = { outletId: this.params.outlet };
        this.app.callGetOutletApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response.defaultInventory.id);
        });
      }

      _processGetOutletDefaultInventoryIdOffline(cbfn) {
        window.setTimeout(() => {
          cbfn(this.app.offlineData.cache.getOutlet.defaultInventory.id);
        }, 10);
      }

      _processGetOutletDefaultInventoryId(cbfn) {
        if (this.selectedWarehouse === '--current-outlet') {
          this._setProductSelectedFromWarehouseId(null);
          if (this.isInOfflineMode) {
            this._processGetOutletDefaultInventoryIdOffline(cbfn);
          } else {
            this._processGetOutletDefaultInventoryIdOnline(cbfn);
          }
        } else {
          if (this.isInOfflineMode) {
            return this.app.showModalDialog(this.verses.pos.saleNotValid, this.verses.pos.offlineWarehouseSellNotAllowed);
          } else {
            this._processGetWarehouse(({ defaultInventory, warehouse }) => {
              this._setProductSelectedFromWarehouseId(warehouse.id);
              return cbfn(defaultInventory.id);
            });
          }
        }
      }

      _fetchDiscountPresetList(cbfn) {
        let data = { organizationId: this.app.organization.id };
        this.app.callGetDiscountPresetListApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response.discountPresetList);
        });
      }

      _processDiscountPresetList(cbfn) {
        if (this.isInOfflineMode) return cbfn(null);
        this._fetchDiscountPresetList(discountPresetList => {
          this.discountPresetList = discountPresetList;
          return cbfn();
        });
      }

      // main payment calculation method
      _calculatePayment({ resetRounding = true } = {}) {
        let {
          totalAmount,
          vatAmount,
          discountType,
          discountValue,
          discountedAmount,
          serviceChargeAmount,
          totalBillBeforeRounding,
          roundedByAmount,
          totalBilled,
          shouldSaveChangeInAccount,
          paymentMethod,
          paidAmount,
          changeAmount,
          discountPresetId = null
        } = this.payment;

        // setting vatAmount to default value of 0 before calculating vatAmount on a loop
        vatAmount = 0;

        // reducing to find totalProductAmount
        let totalProductAmount = 0;
        totalProductAmount = this.productList.reduce((sum, product) => {
          let { salePrice, selectedCount, vatValue } = product;

          let salePriceForAllSelected = parseFloat(salePrice * selectedCount);

          // adding product vat value to to total vatAmount
          vatAmount += salePriceForAllSelected * (vatValue / 100);

          // the sum to be set as totalProductAmount
          return parseFloat(sum) + salePriceForAllSelected;
        }, 0);

        // reducing to find totalServiceAmount
        let totalServiceAmount = 0;
        totalServiceAmount = this.serviceList.reduce((sum, service) => {
          let { salePrice, vatValue } = service;

          // adding service vat value to to total vatAmount
          vatAmount += salePrice * (vatValue / 100);

          // the sum to be set as totalServiceAmount
          return parseFloat(sum) + parseFloat(salePrice);
        }, 0);

        // totalAmount of service and product sale price(s)
        totalAmount = parseFloat(totalProductAmount) + parseFloat(totalServiceAmount);

        // overall discount calculation
        if (discountValue) {
          if (discountType === 'percent') {
            discountedAmount = totalAmount * (discountValue / 100);
          } else if (discountType === 'fixed') {
            discountedAmount = discountValue;
          }
        }

        // updating totalBilled with calculated totalAmount, vatAmount and discountedAmount
        totalBilled = totalAmount + vatAmount - discountedAmount;
        this.totalBilledCopy = totalBilled;

        // service charge calculation
        if (serviceChargeAmount) {
          totalBilled += parseFloat(serviceChargeAmount);
        }

        // take rounding into account
        if (resetRounding) roundedByAmount = 0;
        totalBillBeforeRounding = totalBilled;
        totalBilled = totalBillBeforeRounding - roundedByAmount;

        // setting the default paid amount equal to total billed
        if (paymentMethod !== 'cash' && paidAmount < 1) {
          paidAmount = totalBilled;
        }

        // calculating change amount, paid amount depending on payment method
        if (paymentMethod === 'change-wallet') {
          changeAmount = 0;
          paidAmount = 0;
        } else {
          if (paidAmount > totalBilled) {
            changeAmount = paidAmount - totalBilled;
          } else {
            changeAmount = 0;
          }
        }

        // returning updated payment info
        this.payment = {
          totalAmount,
          vatAmount,
          discountType,
          discountValue,
          discountedAmount,
          serviceChargeAmount,
          totalBillBeforeRounding,
          roundedByAmount,
          totalBilled,
          paidAmount,
          changeAmount,
          shouldSaveChangeInAccount,
          paymentMethod,
          discountPresetId
        };
      }

      clearRounderByAmountTapped(e = null) {
        this.payment.roundedByAmount = 0;
        this._calculatePayment();
      }

      editTotalBilledTapped(e = null) {
        this.app.showModalInput(this.verses.sales.editBill, this.verses.sales.editBillDetails, this.payment.totalBilled, (answer) => {
          if (parseFloat(answer) > 0) {
            this.payment.roundedByAmount = Math.max(0, (this.payment.totalBillBeforeRounding - parseFloat(answer)));
            this._calculatePayment({ resetRounding: false });
          }
        });
      }

      _processAddSalesOnline(data, cbfn) {
        data.wasOfflineSale = false;
        this.app.callAddSalesApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          cbfn(response);
        });
      }

      _processAddSalesOffline(salesData, cbfn) {
        if (salesData.payment.totalBilled > salesData.payment.paidAmount) {
          this.app.showModalDialog(this.verses.general.errorMessageTitle, this.verses.pos.disallowCreditSale);
          return;
        }
        this.app.db.update('offline-data', (({ which }) => which === 'only'), offlineData => {
          if (!offlineData.data.unsyncedSalesIdSeed) offlineData.data.unsyncedSalesIdSeed = 0;
          offlineData.data.unsyncedSalesIdSeed += 1;
          salesData.id = 'OFFLINE-' + offlineData.data.unsyncedSalesIdSeed;
          salesData.createdDatetimeStamp = Date.now();
          offlineData.data.unsyncedSalesList.push(salesData);
          return offlineData;
        });
        cbfn({ salesId: salesData.id });
      }

      _processAddSales(cbfn) {
        let outletId = this.params.outlet;
        let payment = this.payment;

        let customerId = null;
        if (this.customer) {
          customerId = this.customer.id;
        }

        let productList = this.productList.map(product => {
          let { name, productId, selectedCount, salePrice, vatValue } = product;
          let vatPercentage = vatValue;
          let finalProduct = { productId, count: selectedCount, salePrice, vatPercentage };
          if (this.isInOfflineMode) {
            finalProduct.productBlueprintName = name;
            finalProduct.returnedProductCount = 0;
            finalProduct.count = parseInt(String(finalProduct.count));
          }
          return finalProduct;
        });

        let serviceList = this.serviceList.map(service => {
          let { id, salePrice, vatValue, assignedEmploymentId, name } = service;
          let serviceId = id;
          let vatPercentage = vatValue;
          let finalService = { serviceId, salePrice, vatPercentage, assignedEmploymentId };
          if (this.isInOfflineMode) {
            finalService.serviceBlueprintName = name;
          }
          return finalService;
        });

        let assistedByEmployeeId = (this.assignedAssistedByEmployee) ? this.assignedAssistedByEmployee.id : null;

        let productsSelectedFromWarehouseId = this.productsSelectedFromWarehouseId;

        if (this.isInOfflineMode && productsSelectedFromWarehouseId !== null) {
          return this.app.showModalDialog(this.verses.pos.saleNotValid, this.verses.pos.offlineWarehouseSellNotAllowed);
        }

        let data = {
          customerId, outletId, productList, serviceList, assistedByEmployeeId, payment,
          productsSelectedFromWarehouseId
        };

        if (this.isInOfflineMode) {
          this._processAddSalesOffline(data, cbfn);
        } else {
          this._processAddSalesOnline(data, cbfn);
        }
      }

      _resetSales() {
        this.selectedDiscountPreset = '--no-discount';
        this.selectedWarehouse = '--current-outlet';
        this.productsSelectedFromWarehouseId = null;

        this.app.extractFromSession('pos-selected-warehouse');
        this.app.extractFromSession('product-selected-from-warehouse-id');

        this.app.extractFromSession('pos-selected-product-list');
        this.app.extractFromSession('pos-selected-service-list');

        this.app.extractFromSession('last-selected-customer');

        this.app.extractFromSession('pos-assigned-assisted-by-employee');

        this.resetProperties('payment', 'productList', 'serviceList', 'customer', 'isSearchingCustomer');

        this.app.refreshCurrentPage();
      }

      _customerSelected(customer) {
        this.customer = customer;
        this.isSearchingCustomer = false;
      }

      _fetchWarehouseList(cbfn) {
        if (!this.hasModule('MOD_SELL_WAREHOUSE_PRODUCTS')) {
          return cbfn([]);
        }
        let data = { organizationId: this.app.organization.id };
        this.app.callGetWarehouseListApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response.warehouseList);
        });
      }

      // region: ui =================================

      changeCustomerTapped(e = null) {
        this.isSearchingCustomer = true;
      }

      createCustomerTapped(e = null) {
        this.app.navigateTo('/edit-customer');
      }

      removeCustomerTapped(e = null) {
        this.customer = null;
        this.app.storeInSession('last-selected-customer', null);
      }

      addProductTapped(e = null) {
        this._processGetOutletDefaultInventoryId(defaultInventoryId => {
          return this.app.navigateTo(`/pos-select-products/inventory:${defaultInventoryId}`);
        })
      }

      addServiceTapped(e = null) {
        return this.app.navigateTo(`/pos-select-services/outlet:${this.params.outlet}`);
      }

      paymentMethodSelected(e) {
        // NOTE: The timeout should not be necessary. However, without it
        // the value of this.payment.paymentMethod is not being updated in time.
        window.setTimeout(() => {
          this._calculatePayment();
        }, 100);
      }

      genericPaymentInputChanged(e) {
        this.enforceMinMaxOnPaperInput(e);
        if (e.target.className.indexOf('payment--paidAmount') > -1) {
          this._calculatePayment({ resetRounding: false });
        } else {
          this._calculatePayment();
        }
      }

      backButtonOnTopBarPressed(e = null) {
        this._resetSales();
        this.app.navigateToPreviousUrl('/home');
      }

      saveSaleTapped(e = null) {
        this._processAddSales(({ salesId }) => {
          let message = this.app.verses.pos.newSalesAdded;
          this.app.showToast(message, _ => {
            this._resetSales();
          });
        });
      }

      saveSaleAndPrintTapped(e = null) {
        this._processAddSales(({ salesId }) => {
          this._resetSales();
          return this.app.navigateTo(`/print-sales-receipt/sales:${salesId}/from:pos`);
        });
      }

      toggleAllOfflineSalesTapped(e = null) {
        this.shouldExpandOfflineSalesList = !this.shouldExpandOfflineSalesList;
      }

      printOfflineSalesTapped(e) {
        return this.app.navigateTo(`/print-sales-receipt/sales:${e.model.unsyncedSales.id}/from:pos`);
      }

      discardOfflineSalesTapped(e) {
        let salesId = e.model.unsyncedSales.id;
        this.app.db.update('offline-data', (({ which }) => which === 'only'), offlineData => {
          let index = offlineData.data.unsyncedSalesList.findIndex(sales => sales.id === salesId);
          if (index > -1) {
            offlineData.data.unsyncedSalesList.splice(index, 1);
          }
          return offlineData;
        });
      }

      _submitAnOfflineSales(unsyncedSales, cbfn) {
        unsyncedSales = JSON.parse(JSON.stringify(unsyncedSales));

        // Remove temporarily added properties (that were required for offline preview)
        unsyncedSales.productList.forEach(product => {
          delete product.productBlueprintName;
          delete product.returnedProductCount;
        });
        unsyncedSales.serviceList.forEach(service => {
          delete service.serviceBlueprintName;
        });
        delete unsyncedSales.id;
        delete unsyncedSales.createdDatetimeStamp;

        unsyncedSales.wasOfflineSale = true;
        this.app.callAddSalesApi(unsyncedSales, (err, response) => {
          if (err) return cbfn(err, null, null);
          if (response.hasError) {
            return this.onApiError(response.error, null, () => {
              return cbfn(null, response.error, null);
            });
          }
          cbfn(null, null, response);
        });
      }

      goOnlineTapped() {
        if (this.isInOfflineMode) {
          this.app.callUserAssertApiKeyApi({}, (err, response) => {
            if (err) {
              this.app.showModalDialog(this.verses.root.networkErrorTitle, this.verses.root.networkErrorContent);
              return;
            }
            this.app.toggleOfflineMode();
          });
        }
      }

      submitAllOfflineSalesTapped(e) {
        let list = this.offlineData.data.unsyncedSalesList;
        let left = list.length;
        const submitNext = () => {
          if (!left) {
            if (this.isInOfflineMode) {
              this.app.toggleOfflineMode();
            }
            return;
          }

          left -= 1;
          let unsyncedSales = list[left];

          this._submitAnOfflineSales(unsyncedSales, (networkError, validationError, response) => {
            if (networkError) {
              return;
            }
            if (validationError) return submitNext();

            this.app.db.update('offline-data', (({ which }) => which === 'only'), offlineData => {
              let index = offlineData.data.unsyncedSalesList.findIndex(sales => sales.id === unsyncedSales.id);
              if (index > -1) {
                offlineData.data.unsyncedSalesList.splice(index, 1);
              }
              return offlineData;
            });

            submitNext();
          });

        }
        submitNext();
      }

      isDiscountTypePercent(discountType) {
        return (discountType === 'percent');
      }

      isPaymentMethodCash(paymentMethod) {
        return (paymentMethod === 'cash');
      }

      isPaymentMethodChangeWallet(paymentMethod) {
        return (paymentMethod === 'change-wallet');
      }

      isValidCreditSale(customer, totalBilled, paidAmount) {
        return (customer && totalBilled > paidAmount);
      }

      assignEmployeeTapped(e) {
        let { id } = e.model.service;
        return this.app.navigateTo(`/pos-assign-employee-service/service:${id}`);
      }

      assignAssistedByEmployeeTapped() {
        return this.app.navigateTo(`/pos-assign-assisted-by-employee`);
      }

      $shouldShowWarehouseSelector(warehouseListLength, productListLength) {
        return (warehouseListLength > 0 && productListLength === 0);
      }

      // region: misc =================================

      productListOrServiceListHasElement(productListLength, serviceListLength) {
        return (productListLength || serviceListLength);
      }

      // region: offline sales =================================

      onOfflineDataChange() {
        this.isInOfflineMode = this.app.isInOfflineMode;
        this.offlineData = this.app.offlineData;

        // NOTE: Willingly written in an expressive manner
        if (this.isInOfflineMode) {
          this.app.currentPageAllowsBackButton = false;
        } else {
          this.app.currentPageAllowsBackButton = true;
        }
      }

    }

    window.customElements.define(PagePos.is, PagePos);
  </script>
</dom-module>