<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tab.html">
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">

<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/hardware-icons.html">
<link rel="import" href="../bower_components/iron-icons/editor-icons.html">

<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">

<link rel="import" href="../bower_components/iron-input/iron-input.html">

<link rel="import" href="../bower_components/baselib/baselib.html">

<link rel="import" href="../bower_components/polymer-fx/fx-page.html">
<link rel="import" href="../bower_components/polymer-fx/fx-common-behavior.html">

<link rel="import" href="torque-db-behavior.html">
<link rel="import" href="torque-common-behavior.html">
<link rel="import" href="torque-page-behavior.html">
<link rel="import" href="torque-language-behavior.html">

<link rel="import" href="shared-styles.html">

<link rel="import" href="elem-customer-selector.html">

<dom-module id="page-pos">
  <template>
    <style include="shared-styles">
      :host {
        font-size: 14px;
      }

      select-product-button-container paper-button {
        width: 100%;
        margin: 5px;
      }

      .individual-calculation-field-container {
        border: 1px solid #eee;
        background-color: #f7f7f7;
        padding: 6px;
        margin: 8px 0px;
      }

      .individual-calculation-field-container.light {
        background-color: white;
      }

      .full-width-paper-dropdown {
        width: 100%;
      }

      .height-adjusted {
        margin-top: -14px;
      }

      .product-title {
        font-weight: bold;
      }

      .monetary-unit {
        font-size: 10px;
        margin-left: 4px;
      }

      .product-discount-vat-detail {
        font-size: 10px;
        margin-left: 12px;
      }

      .service-info {
        flex: 1;
        /* border: 1px solid blue; */
      }

      .service-title {
        font-weight: bold;
      }

      .service-vat-detail {
        font-size: 10px;
        margin-left: 12px;
        margin-right: 10px;
      }

      .service-customer-required {
        font-size: 11px;
        font-weight: bold;
      }

      .employee-icon-container {
        padding: 10px;
      }

      .employee-icon-container-active {
        padding: 10px;
        color: var(--app-button-primary);
      }

      .assign-icon {
        margin-right: 4px;
      }

      .m-top-16 {
        margin-top: 16px;
      }

      .m-bottom-18 {
        margin-bottom: 18px;
      }

      .card.warning {
        background: var(--app-button-alternative);
      }

      .bold-customer-card-title {
        font-weight: bold;
      }

      .column {
        min-width: 320px;
        min-height: 70vh;
        /* background: #e1f5fe; */
        position: relative;
        margin-left: 2px;
        margin-right: 2px;
      }

      .placeholder {
        background: #dde4e7;
        text-align: center;
      }

      paper-tabs.view-selector {
        --paper-tabs: {
          background-color: var(--app-primary-color);
          color: white;
        }
      }

      .edit-product-price-icon {
        padding: 0;
        height: 16px;
        max-width: 16px;
        min-width: 16px;
        margin-left: 4px;
      }

      .multi-column-header-row {
        margin-top: 8px;
      }

      .multi-column-header {
        cursor: pointer;
        text-align: center;
        padding: 16px 0;
        background-color: var(--app-tab-unselected);
        border-bottom: 2px solid var(--app-tab-selected);
        margin: 2px;
      }

      .multi-column-header .title {
        font-size: 20px;
        font-weight: bold;
      }

      .multi-column-header .subtitle {
        font-size: 14px;
      }

      .multi-column-header .icon {
        padding: 0;
        height: 16px;
        max-width: 16px;
        min-width: 16px;
        margin-left: 4px;
      }

      .single-column-tabs-row {
        margin: 8px;
        margin-bottom: 0;
      }

      .single-column-tab {
        cursor: pointer;
        text-align: center;
        padding: 16px 0;
        background-color: var(--app-tab-unselected);
        border-bottom: 2px solid var(--app-tab-selected);
      }

      .single-column-tab.selected {
        background-color: var(--app-tab-selected);
        color: var(--app-tab-label-selected);
      }

      .single-column-tab.selected .icon {
        color: var(--app-tab-label-selected);
      }

      .single-column-tab .icon {
        padding: 0;
        height: 16px;
        max-width: 16px;
        min-width: 16px;
        margin-left: 4px;
      }

      .single-column-tab .title {
        font-size: 16px;
        font-weight: bold;
      }

      .single-column-tab .subtitle {
        font-size: 12px;
      }

      .product-count-input {
        --paper-input-container-color: var(--app-primary-color);
      }

      .product-search-bar {
        background: var(--app-button-alternative);
      }

      .service-search-bar {
        background: var(--app-button-alternative);
      }

      .scanning-active-message {
        font-size: 20px;
        text-align: center;
        color: blue;
      }

      .positive {
        color: var(--app-button-primary);
      }

      .negative {
        color: var(--app-button-label-danger);
      }

      .selected-products-or-services-card {
        background: var(--app-primary-color-light);
      }

      .selected-products-or-services-list {
        background: white;
        padding: 0px 6px 0 6px;
      }

      .selected-products-or-services-list .item {
        padding-top: 8px;
      }

      .pos-card-heading {
        margin-bottom: 8px;
      }

      .pos-card-heading-label {
        font-size: 20px;
      }

      .not-found-message {
        text-align: center;
        color: red;
      }

      .category-box {
        font-size: 14px;
        padding: 6px;
        margin: 2px;
        border-radius: 4px;
        cursor: pointer;
      }

      .product-subtab {
        text-align: center;
        padding: 12px;
        font-size: 14px;
        background: #B2DFDB;
        border-bottom: 4px solid #80CBC4;
        cursor: pointer;
      }

      .product-subtab.selected {
        border-bottom: 4px solid #004D40;
      }

      .psb-category-container {
        font-size: 16px;
        padding: 8px;
        margin: 4px;
        border-radius: 4px;
        cursor: pointer;
      }

      .psb-product {
        background: rgb(191, 221, 219);
        font-size: 14px;
        padding: 8px;
        margin: 4px;
        cursor: pointer;
      }

      .psb-container {
        max-height: 300px;
        overflow-y: auto;
        /* scroll-behavior: auto; */
      }

      .psb-product .price {}

      .product-categories-card {
        max-height: 360px;
        overflow-y: auto;
        /* padding: 2px; */
      }
    </style>

    <elem-not-ready is-ready="[[isReady]]"></elem-not-ready>

    <div class$="page-fullwidth layout vertical [[$if(isReady, '', 'hidden')]]" id="wrapper">

      <!-- offline mode - start -->
      <template is="dom-if" if="[[isInOfflineMode]]">
        <div class="card warning vertical layout">
          <div class="flex">[[verses.pos.offlineModeWarning]]</div>
          <paper-button raised class="primary btn" on-tap="goOnlineTapped">
            [[verses.pos.goOnline]]
          </paper-button>
        </div>
      </template>

      <template is="dom-if" if="[[offlineData.data.unsyncedSalesList.length]]">
        <div class="card vertical layout">

          <div class="vertical layout">
            <div class="flex">[[offlineData.data.unsyncedSalesList.length]] [[verses.pos.offlineSaleCountMessage]]</div>
            <div class="horizontal layout">
              <paper-button raised class="secondary btn" style="width: 100%;" on-tap="toggleAllOfflineSalesTapped">
                [[verses.pos.showHideButton]]
              </paper-button>

              <paper-button raised class="primary btn" style="width: 100%;" on-tap="submitAllOfflineSalesTapped">
                [[verses.pos.submitOfflineSales]]
              </paper-button>
            </div>
          </div>

          <template is="dom-if" if="[[shouldExpandOfflineSalesList]]">
            <div class="list m-top-16">
              <template is="dom-repeat" items="[[offlineData.data.unsyncedSalesList]]" as="unsyncedSales">
                <div class="horizontal layout item center">
                  <div class="flex">
                    <b>[[unsyncedSales.id]]</b> <br>
                    [[verses.pos.createdOfflineSaleDatetime]]: [[$mkDate(unsyncedSales.createdDatetimeStamp, 'hh:mmtt dd-MM-yyyy')]]
                  </div>

                  <div class="vertical layout">
                    <paper-button raised class="secondary btn btn-default slim" on-tap="printOfflineSalesTapped">
                      [[verses.general.print]]
                    </paper-button>
                    <paper-button raised class="danger btn btn-default slim" style="margin-top: 6px;" on-tap="discardOfflineSalesTapped">
                      [[verses.general.discard]]
                    </paper-button>
                  </div>

                </div>
              </template>
            </div>
          </template>

        </div>
      </template>
      <!-- offline mode - end -->

      <!-- header - start -->

      <!-- header - Multi Column - Start -->
      <template is="dom-if" if="[[isMultiColumn]]">
        <div class="horizontal layout multi-column-header-row">
          <template is="dom-if" if="[[$equals('undecided', salesType)]]">
            <div class="flex multi-column-header">
              <div class="title">[[verses.general.selection]]</div>
              <div class="subtitle">[[verses.pos.step1]]</div>

            </div>
          </template>
          <template is="dom-if" if="[[$equals('services', salesType)]]">
            <div class="flex multi-column-header">
              <div class="title">[[verses.pos.services]]</div>
              <div class="horizontal layout center-center">
                <div class="subtitle">[[verses.pos.step1]]</div>
                <iron-icon icon="check-circle" class$="icon positive [[$getSelectionCompleteIconClass(productList.length, serviceList.length)]]"></iron-icon>
              </div>
            </div>
          </template>
          <template is="dom-if" if="[[$equals('products', salesType)]]">
            <div class="flex multi-column-header">
              <div class="title">[[verses.pos.products]]</div>
              <div class="horizontal layout center-center">
                <div class="subtitle">[[verses.pos.step1]]</div>
                <iron-icon icon="check-circle" class$="icon positive [[$getSelectionCompleteIconClass(productList.length, serviceList.length)]]"></iron-icon>
              </div>
            </div>
          </template>
          <div class="flex multi-column-header">
            <div class="title">[[verses.general.customer]]</div>
            <div class="horizontal layout center-center">
              <div class="subtitle">[[verses.pos.step2]]</div>
              <iron-icon icon="check-circle" class$="icon positive [[$getCustomerCompleteIconClass(customer, isAnonymousSale)]]"></iron-icon>
            </div>
          </div>
          <div class="flex multi-column-header">
            <div class="title">[[verses.general.payment]]</div>
            <div class="subtitle">[[verses.pos.step3]]</div>
          </div>
        </div>
      </template>
      <!-- header - Multi Column - End -->

      <!-- header - Single Column - Start -->
      <template is="dom-if" if="[[!isMultiColumn]]">
        <div class="horizontal layout single-column-tabs-row">

          <template is="dom-if" if="[[$equals('undecided', salesType)]]">
            <div class$="flex single-column-tab [[$getTabSelectedClass('selection', selectedTabName)]]" data-key="selection" on-tap="singleColumnTabTapped">
              <div class="title">[[verses.general.selection]]</div>
              <div class="subtitle">[[verses.pos.step1]]</div>
            </div>
          </template>

          <template is="dom-if" if="[[$equals('products', salesType)]]">
            <div class$="flex single-column-tab [[$getTabSelectedClass('products', selectedTabName)]]" data-key="products" on-tap="singleColumnTabTapped">
              <div class="title">[[verses.pos.products]]</div>
              <div class="horizontal layout center-center">
                <div class="subtitle">[[verses.pos.step1]]</div>
                <iron-icon icon="check-circle" class$="icon positive [[$getSelectionCompleteIconClass(productList.length, serviceList.length)]]"></iron-icon>
              </div>
            </div>
          </template>

          <template is="dom-if" if="[[$equals('services', salesType)]]">
            <div class$="flex single-column-tab [[$getTabSelectedClass('services', selectedTabName)]]" data-key="services" on-tap="singleColumnTabTapped">
              <div class="title">[[verses.pos.services]]</div>
              <div class="horizontal layout center-center">
                <div class="subtitle">[[verses.pos.step1]]</div>
                <iron-icon icon="check-circle" class$="icon positive [[$getSelectionCompleteIconClass(productList.length, serviceList.length)]]"></iron-icon>
              </div>
            </div>
          </template>

          <div class$="flex single-column-tab [[$getTabSelectedClass('customer', selectedTabName)]]" data-key="customer" on-tap="singleColumnTabTapped">
            <div class="title">[[verses.general.customer]]</div>
            <div class="horizontal layout center-center">
              <div class="subtitle">[[verses.pos.step2]]</div>
              <iron-icon icon="check-circle" class$="icon positive [[$getCustomerCompleteIconClass(customer, isAnonymousSale)]]"></iron-icon>
            </div>
          </div>

          <div class$="flex single-column-tab [[$getTabSelectedClass('payment', selectedTabName)]]" data-key="payment" on-tap="singleColumnTabTapped">
            <div class="title">[[verses.general.payment]]</div>
            <div class="horizontal layout center-center">
              <div class="subtitle">[[verses.pos.step3]]</div>
            </div>
          </div>
        </div>
      </template>
      <!-- header - Single Column - End -->

      <!-- header - end -->

      <!-- columns - Start -->
      <div class="horizontal layout">

        <!-- selection column - start -->
        <div class$="column flex [[$getColumnClasses('selection', 'real', isMultiColumn, selectedTabName, productList.length, serviceList.length, customer, isAnonymousSale, isInOfflineMode)]]">

          <div class="card vertical layout">

            <paper-button raised class="primary" on-tap="salesTypeIsProductsTapped" style="margin-bottom: 8px;">
              [[verses.pos.productSales]]
            </paper-button>

            <template is="dom-if" if="[[!isInOfflineMode]]">
              <paper-button raised class="primary" on-tap="salesTypeIsServicesTapped" style="margin-bottom: 8px;">
                [[verses.pos.serviceSales]]
              </paper-button>
            </template>

          </div>

        </div>
        <!-- selection column - end -->

        <!-- products column - start -->
        <div class$="column flex [[$getColumnClasses('products', 'real', isMultiColumn, selectedTabName, productList.length, serviceList.length, customer, isAnonymousSale, isInOfflineMode)]]">

          <!-- warehouse selection - start -->
          <template is="dom-if" if="[[hasModule('MOD_SELL_WAREHOUSE_PRODUCTS')]]">
            <template is="dom-if" if="[[!productSourceSelectionComplete]]">
              <template is="dom-if" if="[[$shouldShowWarehouseSelector(warehouseList.length, productList.length)]]">
                <div class="card horizontal layout center">
                  <paper-dropdown-menu class="full-width-paper-dropdown flex" label="[[verses.pos.selectProductsFromInventoryContainer]]" class="mr-4">
                    <paper-listbox slot="dropdown-content" selected="{{selectedWarehouse}}" attr-for-selected="name">
                      <paper-item name="--current-outlet">[[verses.pos.currentOutlet]]</paper-item>
                      <template is="dom-repeat" items="[[warehouseList]]" as="warehouse">
                        <paper-item name="[[warehouse.id]]">
                          <div class="name">[[warehouse.name]]</div>
                        </paper-item>
                      </template>
                    </paper-listbox>
                  </paper-dropdown-menu>
                  <paper-button class="primary" raised on-tap="selectedWarehouseChanged">[[verses.general.select]]</paper-button>
                </div>
              </template>
            </template>
            <template is="dom-if" if="[[productSourceSelectionComplete]]">
              <div class="card horizontal layout center">
                <div class="flex">[[verses.pos.sellingProductsFrom]] <b>[[productSourceToDisplay]]</b></div>
                <template is="dom-if" if="[[!isInOfflineMode]]">
                  <paper-button class="secondary" raised on-tap="changeProductSourceTapped">[[verses.general.change]]</paper-button>
                </template>
              </div>
            </template>
          </template>
          <!-- warehouse selection - end -->

          <template is="dom-if" if="[[productSourceSelectionComplete]]">
            <template is="dom-if" if="[[!isInOfflineMode]]">
              <div class="horizontal layout">
                <div class$="product-subtab flex [[$getProductSubtabClass('categories', selectedProductSubtab)]]" on-tap="productSubtabCategoryTapped" style="margin-right: 1px;;">
                  [[verses.pos.categoriesTabTitle]]
                </div>
                <div class$="product-subtab flex [[$getProductSubtabClass('search', selectedProductSubtab)]]" on-tap="productSubtabSearchTapped">
                  [[verses.pos.searchProductTabTitle]]
                </div>
              </div>
            </template>
          </template>

          <!-- categories - subtab - start -->
          <template is="dom-if" if="[[productSourceSelectionComplete]]">
            <template is="dom-if" if="[[$equals(selectedProductSubtab, 'categories')]]">

              <template is="dom-if" if="[[!selectedProductCategory]]">
                <div class="card horizontal layout wrap product-categories-card">

                  <template is="dom-if" if="[[!productCategoryList.length]]">
                    <div>[[verses.pos.noProductCategoryFound]]</div>
                  </template>

                  <template is="dom-if" if="[[productCategoryList.length]]">
                    <template is="dom-repeat" items="[[productCategoryList]]" as="productCategory">
                      <div class="category-box" on-tap="productCategoryTapped" style$="background-color: #{{productCategory.colorCode}}; color: #{{$guessCategoryFontColorCode(productCategory.colorCode)}}; border-color: #{{$guessCategoryFontColorCode(productCategory.colorCode)}}">[[productCategory.name]]</div>
                    </template>
                  </template>

                </div>
              </template>

              <!-- product selection box - start -->
              <template is="dom-if" if="[[selectedProductCategory]]">
                <div class="">
                  <div class="product-selection-box">
                    <div class="psb-category-container horizontal layout center" style$="background-color: #{{selectedProductCategory.colorCode}}; color: #{{$guessCategoryFontColorCode(selectedProductCategory.colorCode)}}; border-color: #{{$guessCategoryFontColorCode(selectedProductCategory.colorCode)}}">
                      <paper-icon-button icon="arrow-back" on-tap="backFromProductCategoryTapped"></paper-icon-button>
                      [[selectedProductCategory.name]]
                    </div>
                  </div>
                  <div class="psb-container card">
                    <template is="dom-repeat" items="[[productCategoryProductList]]" as="product">
                      <div class="psb-product horizontal layout center" on-tap="productFromProductCategorySelected">
                        <div class="name">[[product.name]]</div>
                        <div class="flex"></div>
                        <div class="price">[[product.salePrice]]</div>
                      </div>
                    </template>
                  </div>
                </div>
              </template>
              <!-- product selection box - end -->

            </template>
          </template>
          <!-- categories - subtab - end -->

          <!-- product searchbar - start -->
          <template is="dom-if" if="[[$equals(selectedProductSubtab, 'search')]]">
            <template is="dom-if" if="[[productSourceSelectionComplete]]">
              <div class="card vertical layout product-search-bar">
                <template is="dom-if" if="[[isScanningActive]]">
                  <div class="scanning-active-message">[[verses.pos.scanningActive]]</div>
                </template>
                <div class="horizontal layout center">
                  <paper-input id="product-search-field" class="flex" value="{{productSearchString}}" always-float-label label="[[verses.pos.productSearchLabel]]" on-keydown="productSearchFieldKeypressed" on-focus="productSearchFieldFocused" on-blur="productSearchFieldBlurred"></paper-input>
                  <template is="dom-if" if="[[!matchingProductList.length]]">
                    <paper-icon-button icon="search" on-tap="productSearchTapped"></paper-icon-button>
                  </template>
                  <template is="dom-if" if="[[matchingProductList.length]]">
                    <paper-icon-button icon="clear" on-tap="productSearchClearTapped"></paper-icon-button>
                  </template>
                </div>
                <template is="dom-if" if="[[notFoundMessage]]">
                  <div class="not-found-message">[[notFoundMessage]]</div>
                </template>
              </div>
            </template>
          </template>
          <!-- product searchbar - end -->

          <!-- product search results - start -->
          <template is="dom-if" if="[[$equals(selectedProductSubtab, 'search')]]">
            <template is="dom-if" if="{{matchingProductList.length}}">

              <div class="card vertical layout">

                <div class="list">
                  <template is="dom-repeat" items="[[matchingProductList]]" as="product">
                    <div class="horizontal layout item center">
                      <div class="flex" style="min-width: 128px;">
                        <div class="inventory-product-important-detail-container">[[product.name]]</div>
                        <div class="inventory-product-price-container">[[verses.posSelectProduct.sale]]: [[product.salePrice]][[app.organization.settings.monetaryUnit]]</div>
                      </div>

                      <template is="dom-if" if="[[product.count]]">
                        <paper-icon-button class="positive" icon="add-circle" on-tap="selectMatchingProductTapped"></paper-icon-button>
                      </template>
                    </div>
                  </template>
                </div>

                <div class="pagination">
                  <span class="offset">[[$paginationStartText(productPagination.offset, productPagination.limit)]]</span> -
                  <span class="limit">[[$paginationEndText(productPagination.offset, productPagination.limit)]]</span>
                  [[verses.general.paginationSeparator]]
                  <span class="total-count">[[productPagination.totalCount]]</span>
                </div>

                <div class="horizontal layout center">
                  <template is="dom-if" if="[[$hasPreviousPagination(productPaginate.offset)]]">
                    <paper-button raised class="flex neutral" on-tap="showPreviousProductsTapped">[[verses.general.showPrevious]]</paper-button>
                  </template>

                  <template is="dom-if" if="[[$hasMorePagination(productPagination.totalCount, productPaginate.offset, productPaginate.limit)]]">
                    <paper-button raised class="flex neutral" on-tap="showMoreProductsTapped">[[verses.general.showMore]]</paper-button>
                  </template>
                </div>

              </div>
            </template>
          </template>
          <!-- product search results - end -->

          <!-- selected product list - start -->
          <template is="dom-if" if="[[productList.length]]">

            <div class="card vertical layout selected-products-or-services-card">

              <div class="horizontal layout center pos-card-heading">
                <div class="flex pos-card-heading-label">[[verses.pos.selectedProducts]]</div>
                <template is="dom-if" if="[[!isMultiColumn]]">
                  <paper-button raised class="primary" on-tap="productSelectionDoneTapped" style="margin-bottom: 8px;">
                    [[verses.general.nextOrContinue]]
                  </paper-button>
                </template>
              </div>

              <div class="list selected-products-or-services-list">
                <template is="dom-repeat" items="[[productList]]" as="product" index-as="productIndex">
                  <div class="horizontal layout item center">
                    <div class="vertical layout flex">
                      <div>
                        <span class="product-title">[[product.name]]</span>
                      </div>
                      <div class="horizontal layout center">
                        <paper-input no-label-float class="small-input m-horizontal-4 product-count-input" value="{{product.selectedCount}}" on-change="productSelectedCountInputChanged" type="number" min="1" max="99999999999" label="[[verses.posSelectProduct.count]]">
                          <div slot="suffix">&nbsp;[[product.unit]]</div>
                        </paper-input>

                        <div>&nbsp;@&nbsp;[[product.salePrice]]</div>
                        <div class="monetary-unit">[[app.organization.settings.monetaryUnit]]</div>
                        <template is="dom-if" if="[[hasPrivilege('PRIV_ALLOW_FLEXIBLE_PRICE', organization)]]">
                          <paper-icon-button on-tap="editProductSalePriceTapped" icon="create" class="edit-product-price-icon"></paper-icon-button>
                        </template>
                        <span class="product-discount-vat-detail">+[[verses.pos.vat]] {{product.vatValue}}%</span>
                      </div>
                    </div>
                    <paper-icon-button class="negative" on-tap="discardProductTapped" icon="remove-circle"></paper-icon-button>
                  </div>
                </template>
              </div>
            </div>

          </template>
          <!-- selected product list - end -->

        </div>
        <!-- products column - end -->

        <!-- services column - start -->
        <div class$="column flex [[$getColumnClasses('services', 'real', isMultiColumn, selectedTabName, productList.length, serviceList.length, customer, isAnonymousSale, isInOfflineMode)]]">

          <!-- service searchbar - start -->
          <div class="card vertical layout service-search-bar">
            <div class="horizontal layout center">
              <paper-input id="service-search-field" class="flex" value="{{serviceSearchString}}" always-float-label label="[[verses.posSelectService.searchForServiceInput]]" on-keydown="serviceSearchFieldKeypressed"></paper-input>
              <template is="dom-if" if="[[!matchingServiceList.length]]">
                <paper-icon-button icon="search" on-tap="serviceSearchTapped"></paper-icon-button>
              </template>
              <template is="dom-if" if="[[matchingServiceList.length]]">
                <paper-icon-button icon="clear" on-tap="serviceSearchClearTapped"></paper-icon-button>
              </template>
            </div>
            <template is="dom-if" if="[[notFoundMessage]]">
              <div class="not-found-message">[[notFoundMessage]]</div>
            </template>
          </div>
          <!-- service searchbar - end -->

          <!-- service search results - start -->
          <template is="dom-if" if="{{matchingServiceList.length}}">

            <div class="card vertical layout">

              <div class="list">
                <template is="dom-repeat" items="[[matchingServiceList]]" as="service">

                  <div class="horizontal layout item center">
                    <div class="flex" style="min-width: 128px;">
                      <div class="inventory-product-important-detail-container">[[service.name]]</div>
                      <div class="inventory-product-price-container">[[verses.posSelectService.sale]]: [[service.salePrice]][[app.organization.settings.monetaryUnit]]</div>
                    </div>

                    <paper-icon-button class="primary positive" icon="add-circle" on-tap="selectMatchingServiceTapped"></paper-icon-button>
                  </div>

                </template>
              </div>

              <div class="pagination">
                <span class="offset">[[$paginationStartText(servicePagination.offset, servicePagination.limit)]]</span> -
                <span class="limit">[[$paginationEndText(servicePagination.offset, servicePagination.limit)]]</span>
                [[verses.general.paginationSeparator]]
                <span class="total-count">[[servicePagination.totalCount]]</span>
              </div>

              <div class="horizontal layout center">
                <template is="dom-if" if="[[$hasPreviousPagination(servicePaginate.offset)]]">
                  <paper-button raised class="flex neutral" on-tap="showPreviousServicesTapped">[[verses.general.showPrevious]]</paper-button>
                </template>

                <template is="dom-if" if="[[$hasMorePagination(servicePagination.totalCount, servicePaginate.offset, servicePaginate.limit)]]">
                  <paper-button raised class="flex neutral" on-tap="showMoreServicesTapped">[[verses.general.showMore]]</paper-button>
                </template>
              </div>

            </div>
          </template>
          <!-- service search results - end -->

          <!-- selected service list - start -->
          <template is="dom-if" if="[[serviceList.length]]">

            <div class="card vertical layout selected-products-or-services-card">

              <div class="horizontal layout center pos-card-heading">
                <div class="flex pos-card-heading-label">[[verses.pos.selectedServices]]</div>
                <template is="dom-if" if="[[!isMultiColumn]]">
                  <paper-button raised class="primary" on-tap="serviceSelectionDoneTapped">
                    [[verses.general.nextOrContinue]]
                  </paper-button>
                </template>
              </div>

              <div class="list selected-products-or-services-list">
                <template is="dom-repeat" items="[[serviceList]]" as="service" index-as="serviceIndex">
                  <div class="horizontal layout item center">
                    <div class="vertical layout flex">

                      <div class="horizontal layout center">
                        <div class="service-info">
                          <span class="service-title">[[service.name]]</span>
                        </div>

                        <template is="dom-if" if="{{service.isEmployeeAssignable}}">

                          <template is="dom-if" if="{{service.assignedEmploymentId}}">
                            <div class="employee-icon-container-active" on-tap="assignEmployeeTapped">
                              <iron-icon icon="icons:account-circle" class="assign-icon"></iron-icon>[[verses.pos.assignedEmployee]]
                            </div>
                          </template>

                          <template is="dom-if" if="{{!service.assignedEmploymentId}}">
                            <div class="employee-icon-container" on-tap="assignEmployeeTapped">
                              <iron-icon icon="icons:account-circle" class="assign-icon"></iron-icon>[[verses.pos.assignEmployee]]
                            </div>
                          </template>

                        </template>
                      </div>

                      <template is="dom-if" if="{{service.isCustomerRequired}}">
                        <span class="service-customer-required">*[[verses.pos.serviceRequiresCustomerSelection]]</span>
                      </template>

                      <div class="horizontal layout center">
                        <div>[[service.salePrice]]</div>
                        <div class="monetary-unit">[[app.organization.settings.monetaryUnit]]</div>
                        <span class="service-vat-detail">+[[verses.pos.vat]] {{service.vatValue}}%</span>
                        <paper-icon-button class="negative" on-tap="discardServiceTapped" icon="remove-circle"></paper-icon-button>
                      </div>

                    </div>
                  </div>
                </template>
              </div>

            </div>

          </template>
          <!-- selected service list - end -->

        </div>
        <!-- services column - end -->

        <!-- customer column - start -->
        <div class$="customer-column column flex [[$getColumnClasses('customer', 'real', isMultiColumn, selectedTabName, productList.length, serviceList.length, customer, isAnonymousSale, isInOfflineMode)]]" on-tap="customerColumnTapped">

          <!-- customer selection - start -->
          <template is="dom-if" if="[[$shouldShowCustomerSelectionOptions(customer, isAnonymousSale)]]">
            <elem-customer-selector page="{{self}}" showing-in-pos="true"></elem-customer-selector>
          </template>
          <!-- customer selector - end -->

          <!-- customer creation - start -->
          <template is="dom-if" if="[[$shouldShowCustomerSelectionOptions(customer, isAnonymousSale)]]">
            <iron-form id="editCustomerForm" on-keypress="genericFormSubmitionKeypress">
              <form>
                <div class="card vertical layout" style="margin-top: 34px;">

                  <div class="horizontal layout center pos-card-heading">
                    <div class="flex pos-card-heading-label">[[verses.customer.createNewCustomer]]</div>
                  </div>
                  <div style="font-size: 11px;">[[verses.pos.whyCustomerInfo]]</div>

                  <paper-input class="editCustomerForm--fullName" value="{{editCustomerForm.fullName}}" required minlength="3" error-message=[[verses.customer.customerNameInputError]] label=[[verses.customer.customerNameInput]]></paper-input>
                  <paper-input class="editCustomerForm--phone" value="{{editCustomerForm.phone}}" required minlength="4" minlength="14" error-message=[[verses.customer.customerNumberInputError]] label=[[verses.customer.customerNumberInput]]></paper-input>

                  <paper-input class="editCustomerForm--email" value="{{editCustomerForm.email}}" pattern="^.+@.+\..+$" minlength="3" error-message=[[verses.customer.emailAddressInputError]] label=[[verses.customer.emailAddressInput]]></paper-input>
                  <paper-textarea class="editCustomerForm--address" value="{{editCustomerForm.address}}" label=[[verses.customer.addressInput]] rows="3"></paper-textarea>
                  <div class="horizontal layout m-top-16">
                    <paper-button raised class="flex danger" on-tap="skipCustomerSelectionTapped">[[verses.pos.continueWithoutCustomer]]</paper-button>
                  </div>

                  <div class="horizontal layout m-top-16">
                    <paper-button raised class="flex primary editCustomerForm--submit" on-tap="createCustomerTapped">[[verses.customer.createCustomer]]</paper-button>
                  </div>

                </div>
              </form>
            </iron-form>
          </template>
          <!-- customer creation - end -->

          <!-- customer preview - start -->
          <template is="dom-if" if="[[!$shouldShowCustomerSelectionOptions(customer, isAnonymousSale)]]">
            <div class="card vertical layout">
              <div class="bold-customer-card-title">[[verses.pos.customerSelectionCardHeader]]</div>

              <template is="dom-if" if="[[customer]]">
                <div>
                  <div class="type title capitalize">[[customer.fullName]]</div>
                  <div class="horizontal layout wrap">

                    <div class="horizontal layout center m-right-8">
                      <iron-icon icon="hardware:smartphone" class="icon secondary small m-right-8"></iron-icon>
                      <div class="type body secondary">[[customer.phone]]</div>
                    </div>

                    <template is="dom-if" if="[[hasModule('MOD_CUSTOMER_ACCOUNT_BALANCE')]]">
                      <div class="horizontal layout center">
                        <iron-icon icon="icons:account-balance-wallet" class="icon secondary small m-right-8"></iron-icon>
                        <div class="type body secondary">[[customer.changeWalletBalance]] [[page.app.organization.settings.monetaryUnit]]</div>
                      </div>
                    </template>

                  </div>
                </div>
              </template>

              <template is="dom-if" if="[[isAnonymousSale]]">
                <div>[[verses.pos.noCustomerSelected]]</div>
              </template>

              <div class="horizontal layout end-justified m-top-16">
                <template is="dom-if" if="[[customer]]">
                  <paper-button raised class="danger btn btn-default" on-tap="removeCustomerTapped">
                    [[verses.pos.selectADifferentCustomer]]
                  </paper-button>
                </template>
                <template is="dom-if" if="[[!isInOfflineMode]]">
                  <template is="dom-if" if="[[isAnonymousSale]]">
                    <paper-button raised class="secondary btn btn-default" on-tap="removeCustomerTapped">
                      [[verses.pos.selectACustomer]]
                    </paper-button>
                  </template>
                </template>
              </div>
            </div>

            <template is="dom-if" if="[[!isMultiColumn]]">
              <paper-button raised class="primary" on-tap="customerSelectionDoneTapped" style="width: calc(100% - 16px); margin: 8px;">
                [[verses.general.nextOrContinue]]
              </paper-button>
            </template>

          </template>
          <!-- customer preview - end -->

        </div>
        <!-- customer column - end -->

        <!-- customer column placeholder - start -->
        <div class$="column flex placeholder  vertical layout center-center [[$getColumnClasses('customer', 'placeholder', isMultiColumn, selectedTabName, productList.length, serviceList.length, customer, isAnonymousSale, isInOfflineMode)]]">
          <div style="max-width: 250px;">
            [[verses.pos.customerSectionBlocked]]
          </div>
        </div>
        <!-- customer column placeholder - end -->

        <!-- payment column - start -->
        <div class$="column flex [[$getColumnClasses('payment', 'real', isMultiColumn, selectedTabName, productList.length, serviceList.length, customer, isAnonymousSale, isInOfflineMode)]]" on-tap="paymentColumnTapped">

          <!-- calculations - start -->
          <template is="dom-if" if="[[productListOrServiceListHasElement(productList.length, serviceList.length)]]">
            <div class="card vertical layout">
              <div class="individual-calculation-field-container">
                <span>[[verses.pos.totalSalePrice]]: <b>{{$applyThousandDecimalFormatting(payment.totalAmount)}} [[app.organization.settings.monetaryUnit]]</b></span>
              </div>
            </div>
          </template>

          <template is="dom-if" if="[[productListOrServiceListHasElement(productList.length, serviceList.length)]]">
            <div class="card vertical layout">
              <div class="list">

                <!-- discount preset - start -->
                <template is="dom-if" if="[[discountPresetList.length]]">
                  <div class="individual-calculation-field-container">

                    <div class="vertical layout m-bottom-18">

                      <paper-dropdown-menu class="full-width-paper-dropdown" label="[[verses.pos.discount]]" class="mr-4">
                        <paper-listbox slot="dropdown-content" selected="{{selectedDiscountPreset}}" attr-for-selected="name">
                          <paper-item name="--no-discount">[[verses.pos.noDiscountApplicable]]</paper-item>
                          <template is="dom-repeat" items="[[discountPresetList]]" as="discountPreset">
                            <paper-item name="[[discountPreset.id]]">
                              [[getDiscountPresetLabel(discountPreset)]]
                            </paper-item>
                          </template>
                        </paper-listbox>
                      </paper-dropdown-menu>

                    </div>

                    [[verses.pos.discountedAmount]]:
                    <b>{{$applyThousandDecimalFormatting(payment.discountedAmount)}} [[app.organization.settings.monetaryUnit]]</b>

                  </div>
                </template>
                <template is="dom-if" if="[[!discountPresetList.length]]">
                  <div class="individual-calculation-field-container" style="text-align: center;">
                    <div class="link primary" on-tap="buttonGoToDiscountTapped">[[verses.pos.createYourFirstDiscount]]</div>
                  </div>
                </template>
                <!-- discount preset - end -->

                <div class="individual-calculation-field-container">
                  [[verses.pos.vatAmount]]:
                  <b>{{$applyThousandDecimalFormatting(payment.vatAmount)}} [[app.organization.settings.monetaryUnit]]</b>
                </div>

                <div class="individual-calculation-field-container horizontal layout center">

                  <paper-input class="payment--serviceChargeAmount flex" value="{{payment.serviceChargeAmount}}" on-change="genericPaymentInputChanged" type="number" required min="0" error-message="[[verses.pos.serviceChargeInputError]]" label="[[verses.pos.serviceChargeInput]]">
                    <div slot="suffix">[[app.organization.settings.monetaryUnit]]</div>
                  </paper-input>

                  <template is="dom-if" if="{{!isInOfflineMode}}">

                    <template is="dom-if" if="{{assignedAssistedByEmployee}}">
                      <div class="employee-icon-container-active" on-tap="assignAssistedByEmployeeTapped">
                        <iron-icon icon="icons:account-circle" class="assign-icon"></iron-icon>[[verses.pos.assistedEmployee]]
                      </div>
                    </template>

                    <template is="dom-if" if="{{!assignedAssistedByEmployee}}">
                      <div class="employee-icon-container" on-tap="assignAssistedByEmployeeTapped">
                        <iron-icon icon="icons:account-circle" class="assign-icon"></iron-icon>[[verses.pos.assistedEmployee]]
                      </div>
                    </template>

                  </template>

                </div>

              </div>
            </div>
          </template>
          <!-- calculations - end -->

          <!-- payment area card - start -->
          <template is="dom-if" if="[[productListOrServiceListHasElement(productList.length, serviceList.length)]]">
            <div class="card vertical layout" style="background: var(--app-primary-color-light);">
              <div class="list">

                <template is="dom-if" if="[[payment.roundedByAmount]]">
                  <div class="individual-calculation-field-container light">
                    <div class="horizontal layout center m-top-16">
                      <div class="flex">
                        [[verses.sales.totalBillBeforeRounding]]:
                        <b>{{$applyThousandDecimalFormatting(payment.totalBillBeforeRounding)}} [[app.organization.settings.monetaryUnit]]</b>
                      </div>
                    </div>
                    <div class="horizontal layout center">
                      <div class="flex">
                        [[verses.sales.roundedByAmount]]:
                        <b>{{$applyThousandDecimalFormatting(payment.roundedByAmount)}} [[app.organization.settings.monetaryUnit]]</b>
                      </div>
                      <paper-icon-button on-tap="clearRounderByAmountTapped" icon="clear"></paper-icon-button>
                    </div>
                  </div>
                </template>
                <div class="horizontal layout center individual-calculation-field-container light">
                  <div class="flex">
                    [[verses.pos.totalBilled]]:
                    <b>{{$applyThousandDecimalFormatting(payment.totalBilled)}} [[app.organization.settings.monetaryUnit]]</b>
                  </div>
                  <template is="dom-if" if="[[hasPrivilege('PRIV_ALLOW_FLEXIBLE_PRICE', organization)]]">
                    <paper-icon-button on-tap="editTotalBilledTapped" icon="create"></paper-icon-button>
                  </template>
                </div>

                <div class="individual-calculation-field-container light">

                  <paper-dropdown-menu class="full-width-paper-dropdown" label="[[verses.pos.paymentMethod]]" class="mr-4" on-iron-select="paymentMethodSelected">
                    <paper-listbox slot="dropdown-content" selected="{{payment.paymentMethodId}}" attr-for-selected="name">
                      <template is="dom-repeat" items="[[paymentMethodList]]" as="paymentMethod">
                        <paper-item name="[[paymentMethod.id]]">
                          [[paymentMethod.name]]
                        </paper-item>
                      </template>
                    </paper-listbox>
                  </paper-dropdown-menu>

                  <paper-input class="payment--paidAmount flex" value="{{payment.paidAmount}}" on-change="genericPaymentInputChanged" on-input="genericPaymentInputChanged" type="number" required min="0" error-message="[[verses.pos.paidAmountInputError]]" label="[[verses.pos.paidAmountInput]]" on-focus="paidAmountInputFocuesd">
                    <div slot="suffix">[[app.organization.settings.monetaryUnit]]</div>
                  </paper-input>

                  <template is="dom-if" if="[[payment.changeAmount]]">
                    <br> [[verses.pos.changeAmount]]:
                    <b>{{$applyThousandDecimalFormatting(payment.changeAmount)}} [[app.organization.settings.monetaryUnit]]</b>

                    <br>
                    <template is="dom-if" if="[[hasModule('MOD_CUSTOMER_ACCOUNT_BALANCE')]]">
                      <template is="dom-if" if="[[customer]]">
                        <template is="dom-if" if="[[payment.changeAmount]]">
                          <paper-checkbox checked="{{payment.shouldSaveChangeInAccount}}">
                            [[verses.pos.shouldSaveChangeInAccount]]
                          </paper-checkbox>
                        </template>
                      </template>
                    </template>

                  </template>

                  <template is="dom-if" if="[[isValidCreditSale(customer, payment.totalBilled, payment.paidAmount)]]">
                    [[verses.pos.thisWillBeACreditSale]]
                  </template>

                </div>

                <div class="horizontal layout m-top-16">

                  <paper-button raised class="danger" on-tap="discardSalesTapped">
                    <iron-icon icon="delete"></iron-icon>
                  </paper-button>

                  <paper-button raised class="primary flex" on-tap="saveSaleTapped">[[verses.pos.confirmSales]]</paper-button>
                </div>

              </div>
            </div>
          </template>
          <!-- payment area card - end -->

        </div>
        <!-- payment column - end -->

        <!-- payment column placeholder - start -->
        <div class$="column flex placeholder vertical layout center-center  [[$getColumnClasses('payment', 'placeholder', isMultiColumn, selectedTabName, productList.length, serviceList.length, customer, isAnonymousSale, isInOfflineMode)]]">
          <div style="max-width: 300px;">
            [[verses.pos.paymentSectionBlocked]]
          </div>
        </div>
        <!-- payment column placeholder - end -->

      </div>
      <!-- columns - End -->

    </div>

  </template>

  <script>

    let sendSmsUsingCordova = function (number, message) {

      var error = function (e) {
        // console.log('Something went wrong:' + e);
        // alert("Message was not delivered. Unable to request SMS permission.");
      };

      var denied = function (e) {
        // console.log('Permission Denied:' + e);
        // alert("Message was not delivered. SMS permission was denied.");
      };

      var actuallySendSms = function () {

        var options = {
          replaceLineBreaks: false,
          android: {
            intent: 'INTENT'  // send SMS with the native android SMS messaging
            // intent: '' // send SMS without opening any other app
          }
        };

        var success = function () {
          // console.log('Message sent successfully');
          // alert('message sent')
        };

        var error = function (e) {
          // console.log('Message Failed:' + e);
          // alert("Message was not delivered although permission was given.");
        };

        sms.send(number, message, options, success, error);
      }

      actuallySendSms();

    }

    class PagePos extends FxPage.mixin(TorqueCommonBehavior, TorquePageBehavior, TorqueDbBehavior, FxCommonBehavior, TorqueLanguageBehavior) {

      static get is() {
        return 'page-pos';
      }

      static get properties() {
        return {
          // Tabination =============
          isMultiColumn: {
            type: Boolean,
            value: false
          },
          selectedTabName: {
            type: String,
            value: 'selection'
          },
          salesType: {
            type: String,
            value: 'undecided' // can be - 'undecided', 'products', 'services'
          },
          // Products =============
          productSourceSelectionComplete: {
            type: Boolean,
            value: false
          },
          warehouseList: {
            type: Array,
            value: () => []
          },
          selectedWarehouse: {
            type: String,
            value: '--current-outlet',
            // observer: 'selectedWarehouseChanged'
          },
          productsSelectedFromWarehouseId: {
            type: Number,
            value: null,
          },
          productList: {
            type: Array,
            value: () => [],
            observer: 'productListChanged'
          },
          matchingProductList: {
            type: Array,
            value: () => []
          },
          productPaginate: {
            type: Object,
            value: () => {
              return {
                offset: 0,
                limit: 3
              }
            }
          },
          productPagination: {
            type: Object,
            value: () => {
              return {}
            }
          },
          // Services =============
          serviceList: {
            type: Array,
            value: () => [],
            observer: 'serviceListChanged'
          },
          matchingServiceList: {
            type: Array,
            value: () => []
          },
          servicePaginate: {
            type: Object,
            value: () => {
              return {
                offset: 0,
                limit: 3
              }
            }
          },
          servicePagination: {
            type: Object,
            value: () => {
              return {}
            }
          },
          // Customer =============
          isAnonymousSale: {
            type: Boolean,
            value: false
          },
          customer: {
            type: Object,
            value: null,
            observer: 'customerChanged'
          },
          editCustomerForm: {
            type: Object,
            value: _ => {
              if (mode === 'development') {
                return {
                  fullName: 'Rahim Karim',
                  phone: '1700000011',
                  email: 'rahim@gmail.com',
                  address: 'house road block code 1213 city country'
                };
              } else {
                return {
                  fullName: '',
                  phone: '',
                  email: null,
                  address: ''
                };
              }
            }
          },
          // Payment =============
          selectedDiscountPreset: {
            type: String,
            value: '--no-discount',
            observer: 'selectedDiscountPresetChanged'
          },
          payment: {
            type: Object,
            value: () => {
              return {
                totalAmount: null,
                vatAmount: 0,
                discountType: 'percent',
                discountValue: 0,
                discountedAmount: 0,
                serviceChargeAmount: 0,
                totalBillBeforeRounding: 0,
                roundedByAmount: 0,
                totalBilled: null,
                shouldSaveChangeInAccount: false,
                paymentMethodId: null,
                paidAmount: 0,
                changeAmount: 0
              }
            }
          },
          // Offline Mode =============
          isInOfflineMode: {
            type: Boolean,
            value: false
          },
          shouldExpandOfflineSalesList: {
            type: Boolean,
            value: false
          },
        };
      }

      // region: core =================================

      constructor() {
        super();
        this.confirmPageReady();
      }

      _ensureAccess() {
        return this.accessControl({
          authLevel: 'organization-selected',
          privilegeList: ['PRIV_ACCESS_POS']
        });
      }

      onNavigateIn() {
        this.app.shouldShowSaveButton = false;
        this.app.currentPageIsModal = true;
        this.useLanguageServices();
        this.onOfflineDataChange();
        this.onOrganizationChange(this.app.organization);
        this.app.pushPageTitle(this.app.verses.pos.posPageTitle);
        if (!'outlet' in this.params) {
          return this.app.showModalDialog(this.app.verses.general.errorMessageTitle, this.app.verses.general.somethingWentWrong, () => {
            return this.navigateTo('/home');
          });
        }
        if (!this._ensureAccess()) return;

        this._initProductCategorySubtab();

        this.notFoundMessage = '';

        // tabination
        this._detectMultiColumnSupport();
        window.addEventListener('resize', () => this._detectMultiColumnSupport());

        let salesType = this.app.getFromSession('pos-sales-type') || 'undecided';
        if (salesType === 'undecided') {
          if (this.hasModule('MOD_PRODUCT') && this.hasModule('MOD_SERVICE')) {
            'pass'
          } else if (this.hasModule('MOD_PRODUCT')) {
            salesType = 'products';
          } else if (this.hasModule('MOD_SERVICE')) {
            salesType = 'services';
          }
        }
        this.salesType = salesType;

        let selectedTabName = null;
        if (salesType === 'undecided') {
          selectedTabName = 'selection';
        } else {
          selectedTabName = salesType;
        }

        // products
        if (this.salesType === 'products') {
          this._initProductColumn();
        }

        // services
        if (this.salesType === 'services') {
          this.serviceList = this.app.getFromSession('pos-selected-service-list') || [];
          this._focusServiceSearchField();
        }

        // customer
        this.delay(0, () => {
          this.self = this;
          if (this.isInOfflineMode) {
            this.customer = null;
            this.isAnonymousSale = true;
          } else {
            this.customer = this.app.getFromSession('last-selected-customer') || null;
            this.isAnonymousSale = this.app.getFromSession('last-selected-customer-is-anonymous') || false;
          }
          this.elem('elem-customer-selector').resetVariables();
        });

        // payment
        this.assignedAssistedByEmployee = this.app.getFromSession('pos-assigned-assisted-by-employee');
        this.selectedDiscountPreset = '--no-discount';
        this._processDiscountPresetList(() => { });
        this._processPaymentMethodList(() => { });
        this.delay(0, () => {
          this._calculatePayment();
        });

        // set currently selected tab
        if (window.isComingFromAssistedByAssignment) {
          window.isComingFromAssistedByAssignment = false;
          let isProductOrServiceSelectionDone = this.productList.length > 0 || this.serviceList.length > 0;
          let isCustomerSelectionDone = (!!this.customer) || this.isAnonymousSale;
          if (isProductOrServiceSelectionDone && isCustomerSelectionDone) {
            if (!this.isMultiColumn) {
              selectedTabName = 'payment';
            }
          }
        } this.selectedTabName = selectedTabName;

        this.isReady = true;
        this._scrollToNavBar();
      }

      _initProductColumn() {
        this.matchingProductList = [];
        this.productList = this.app.getFromSession('pos-selected-product-list') || [];

        if (this.hasModule('MOD_SELL_WAREHOUSE_PRODUCTS') && !this.isInOfflineMode) {
          this.productSourceSelectionComplete = false;
          this._fetchWarehouseList((warehouseList) => {
            warehouseList.reverse();
            this.warehouseList = warehouseList;

            let shouldSkipWarehouseSelection = true;
            if (this.app.getFromSession('pos-selected-warehouse')) {
              shouldSkipWarehouseSelection = false;
            }
            this.selectedWarehouseChanged({ shouldSkipWarehouseSelection });
          });
        } else {
          this.productSourceSelectionComplete = true;
          this.selectedWarehouseChanged();
        }
        this.productSourceToDisplay = this.app.verses.pos.currentOutlet;
        this.selectedWarehouse = this.app.getFromSession('pos-selected-warehouse') || '--current-outlet'; // for dropdown
        this.productsSelectedFromWarehouseId = this.app.getFromSession('product-selected-from-warehouse-id') || null; // for calculation
      }

      _initProductCategorySubtab() {
        this.selectedProductCategory = null;
        if (this.hasModule('MOD_RESTAURANT') && !this.isInOfflineMode) {
          this.selectedProductSubtab = 'categories';
        } else {
          this.selectedProductSubtab = 'search';
        }
        // NOTE: _processEntireInventory Is called seperately
      }

      onNavigateOut() {
        super.onNavigateOut();
        this.app.currentPageAllowsBackButton = true;
        this.app.popPageTitle();
      }

      onOrganizationChange(organization) {
        this.organization = organization;
      }

      backButtonOnTopBarPressed(e = null) {
        this._resetSales();
        this.app.navigateToPreviousUrl('/home');
      }

      // region: tabination =================================

      singleColumnTabTapped(e) {
        e.stopPropagation();
        let attr = e.currentTarget.getAttribute('data-key');
        this.selectedTabName = attr;
      }

      $getTabSelectedClass(tabName, selectedTabName) {
        let classNames = '';
        if (tabName === selectedTabName) {
          classNames += 'selected ';
        }
        return classNames;
      }

      _detectMultiColumnSupport() {
        const minimumPageWidth = 960;
        const leftSidebarWidth = 280;
        const margins = 2 + 2 + 2 + 2;
        const scrollbars = 25;
        if (window.innerWidth < (minimumPageWidth + leftSidebarWidth + margins + scrollbars)) {
          this.isMultiColumn = false;
        } else {
          this.isMultiColumn = true;
        }
      }

      $getSelectionCompleteIconClass(productListLength, serviceListLength) {
        let isProductOrServiceSelectionDone = productListLength > 0 || serviceListLength > 0;
        if (isProductOrServiceSelectionDone) {
          return '';
        }
        return 'hidden ';
      }

      $getCustomerCompleteIconClass(customer, isAnonymousSale) {
        let isCustomerSelectionDone = (!!customer) || isAnonymousSale;
        if (isCustomerSelectionDone) {
          return '';
        }
        return 'hidden ';
      }

      $getColumnClasses(tabName, type, isMultiColumn, selectedTabName, productListLength, serviceListLength, customer, isAnonymousSale, isInOfflineMode) {
        let classNames = '';

        let isProductOrServiceSelectionDone = productListLength > 0 || serviceListLength > 0;
        let isCustomerSelectionDone = (!!customer) || isAnonymousSale;

        if (tabName === 'customer') {
          if (isProductOrServiceSelectionDone && type === 'placeholder') {
            classNames += 'hidden ';
          } else if (!isProductOrServiceSelectionDone && type !== 'placeholder') {
            classNames += 'hidden ';
          }
        }

        if (tabName === 'payment') {
          if ((isProductOrServiceSelectionDone && isCustomerSelectionDone) && type === 'placeholder') {
            classNames += 'hidden ';
          } else if (!(isProductOrServiceSelectionDone && isCustomerSelectionDone) && type !== 'placeholder') {
            classNames += 'hidden ';
          }
        }

        if (isMultiColumn) {
          if (tabName !== 'payment' && tabName !== 'customer') {
            if (tabName === selectedTabName) {
              classNames += ''
            } else {
              classNames += 'hidden ';
            }
          }
        } else {
          if (tabName === selectedTabName) {
            classNames += ''
          } else {
            classNames += 'hidden ';
          }
        }

        return classNames;
      }

      salesTypeIsProductsTapped(e = null) {
        this.salesType = 'products';
        this.selectedTabName = 'products';
        this.app.storeInSession('pos-sales-type', this.salesType);
        this._initProductColumn();
      }

      salesTypeIsServicesTapped(e = null) {
        this.salesType = 'services';
        this.selectedTabName = 'services';
        this.app.storeInSession('pos-sales-type', this.salesType);
        this._focusServiceSearchField({ repeat: false });
      }

      _scrollToNavBar() {
        try {
          this.elem('.page-fullwidth').scrollIntoView();
          // this.elem('.single-column-tabs-row').scrollIntoView();
          // this.elem('.multi-column-header-row').scrollIntoView();
        } catch (ex) { }
      }

      // region: products =================================

      // sub-region: warehouse

      $shouldShowWarehouseSelector(warehouseListLength, productListLength) {
        return (warehouseListLength > 0 && productListLength === 0);
      }

      selectedWarehouseChanged({ shouldSkipWarehouseSelection = false } = {}) {
        this.app.storeInSession('pos-selected-warehouse', this.selectedWarehouse);
        this._resetProductSearch();
        this._focusProductSearchField();
        this._updateDefaultInventoryId({ shouldSkipWarehouseSelection }, () => { }); // Makes sure defaultInventoryId is set correctly
      }

      _setProductSelectedFromWarehouseId(id) {
        this.productsSelectedFromWarehouseId = id;
        this.app.storeInSession('product-selected-from-warehouse-id', this.productsSelectedFromWarehouseId);
      }

      _fetchWarehouseList(cbfn) {
        if (!this.hasModule('MOD_SELL_WAREHOUSE_PRODUCTS')) {
          return cbfn([]);
        }
        let data = { organizationId: this.app.organization.id };
        this.app.callGetWarehouseListApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response.warehouseList);
        });
      }

      changeProductSourceTapped(e = null) {
        this.productList = [];
        this.productListChanged();
        this.productSourceSelectionComplete = false;
      }

      // sub-region: getting default inventory

      _processGetOutletDefaultInventoryIdOnline(cbfn) {
        let data = { outletId: this.params.outlet };
        this.app.callGetOutletApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response.defaultInventory.id);
        });
      }

      _processGetOutletDefaultInventoryIdOffline(cbfn) {
        window.setTimeout(() => {
          cbfn(this.app.offlineData.cache.getOutlet.defaultInventory.id);
        }, 10);
      }

      _processGetWarehouse(cbfn) {
        let data = { warehouseId: this.selectedWarehouse };
        this.app.callGetWarehouseApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          this.productSourceToDisplay = response.warehouse.name;
          return cbfn(response);
        });
      }

      _processGetDefaultInventoryId(cbfn) {
        if (this.selectedWarehouse === '--current-outlet') {
          this._setProductSelectedFromWarehouseId(null);
          this.productSourceToDisplay = this.app.verses.pos.currentOutlet;
          if (this.isInOfflineMode) {
            this._processGetOutletDefaultInventoryIdOffline(cbfn);
          } else {
            this._processGetOutletDefaultInventoryIdOnline(cbfn);
          }
        } else {
          if (this.isInOfflineMode) {
            return this.app.showModalDialog(this.verses.pos.saleNotValid, this.verses.pos.offlineWarehouseSellNotAllowed);
          } else {
            this._processGetWarehouse(({ defaultInventory, warehouse }) => {
              this._setProductSelectedFromWarehouseId(warehouse.id);
              return cbfn(defaultInventory.id);
            });
          }
        }
      }

      _updateDefaultInventoryId({ shouldSkipWarehouseSelection }, cbfn) {
        this.defaultInventoryId = null;
        this._processGetDefaultInventoryId(defaultInventoryId => {
          this.defaultInventoryId = defaultInventoryId;
          if (!shouldSkipWarehouseSelection) {
            this.productSourceSelectionComplete = true;
          }

          if (this.hasModule('MOD_PRODUCT') && !this.isInOfflineMode) {
            // Fetch full inventory to allow category-wise selection
            this._processEntireInventory(() => {
              this._processProductCategoryList(() => { });
            });
          }

          cbfn();
        });
      }

      // sub-region: product-subtab selection

      $getProductSubtabClass(name, selectedProductSubtab) {
        if (selectedProductSubtab === name) return 'selected';
        return '';
      }

      productSubtabCategoryTapped() {
        this.selectedProductSubtab = 'categories';
      }

      productSubtabSearchTapped() {
        this.selectedProductSubtab = 'search';
      }

      // sub-region: product categories and category wise data

      _fetchProductCategoryList(cbfn) {
        let data = {
          organizationId: this.app.organization.id,
          searchString: this.searchString,
          productCategoryIdList: [],
        };
        this.app.callGetProductCategoryListApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response.productCategoryList);
        });
      }

      _processProductCategoryList(cbfn) {
        this._fetchProductCategoryList(productCategoryList => {

          productCategoryList.forEach(productCategory => {
            productCategory.productCategoryProductList = this.entireProductList.filter(product => {
              return product.product.productBlueprint.productCategoryIdList.indexOf(productCategory.id) > -1
            });
          });

          this.productCategoryList = productCategoryList.filter(productCategory => productCategory.productCategoryProductList.length);

          return cbfn();
        });
      }

      _fetchEntireInventoryDetails(cbfn) {
        let inventoryId = this.defaultInventoryId;
        let data = { inventoryId, includeZeroCountProducts: false, sortOrder: 'blueprint-created-date-descending' };
        this.app.callGetAggregatedInventoryDetailsApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response);
        });
      }

      _processEntireInventory(cbfn) {
        this._fetchEntireInventoryDetails(({ aggregatedProductList, inventoryContainerDetails, inventoryDetails }) => {

          let productList = aggregatedProductList.map(product => {
            let { purchasePrice, salePrice } = product.product;
            let { name, unit } = product.product.productBlueprint;
            product.isSelected = false;
            Object.assign(product, { name, unit, purchasePrice, salePrice });
            return product;
          });

          productList = productList.map(product => {
            let { purchasePrice, salePrice } = product.product;
            let { name, unit, defaultVat, identifierCode } = product.product.productBlueprint;
            let vatValue = defaultVat;
            Object.assign(product, { name, unit, purchasePrice, salePrice, vatValue, identifierCode });
            return product;
          });

          this.entireProductList = productList;
          cbfn();
        });
      }

      productCategoryTapped(e) {
        let { productCategory } = e.model;
        this.selectedProductCategory = productCategory;
        this.productCategoryProductList = this.entireProductList.filter(product => {
          return product.product.productBlueprint.productCategoryIdList.indexOf(productCategory.id) > -1
        });
      }

      backFromProductCategoryTapped() {
        this.selectedProductCategory = null;
      }

      productFromProductCategorySelected(e) {
        let { product } = e.model;
        product.selectedCount = 1;
        this._selectProduct({ product });
      }

      // sub-region: search

      productSearchFieldFocused(e) {
        this.isScanningActive = true;
      }

      productSearchFieldBlurred(e) {
        this.isScanningActive = false;
        this.notFoundMessage = '';
      }

      _fetchAggregatedInventoryDetailsOnline(cbfn) {
        let data = {
          inventoryId: this.defaultInventoryId,
          searchString: String(this.productSearchString),
          paginate: this.productPaginate,
          includeZeroCountProducts: false,
          sortOrder: 'blueprint-created-date-descending'
        };
        this.app.callGetAggregatedInventoryDetailsApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          this.productPagination = response.pagination;
          return cbfn(response);
        });
      }

      _fetchAggregatedInventoryDetailsOffline(cbfn) {
        window.setTimeout(() => {
          let response = JSON.parse(JSON.stringify(this.app.offlineData.cache.getAggregatedInventoryDetails));

          let searchString = String(this.productSearchString);
          if (searchString.length > 0) {
            searchString = searchString.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            let regex = new RegExp(searchString, 'g');
            response.aggregatedProductList = response.aggregatedProductList.filter(product => {
              return (regex.test(product.product.productBlueprint.name) || searchString === product.product.productBlueprint.identifierCode);
            });
          }

          ([response.aggregatedProductList, response.pagination] = this._paginateOfflineData(response.aggregatedProductList));

          this.productPagination = response.pagination;
          cbfn(response);
        }, 100);
      }

      _fetchAggregatedInventoryDetails(cbfn) {
        if (this.isInOfflineMode) {
          this._fetchAggregatedInventoryDetailsOffline(cbfn);
        } else {
          this._fetchAggregatedInventoryDetailsOnline(cbfn);
        }
      }

      _searchProducts(cbfn) {
        this._fetchAggregatedInventoryDetails(({ aggregatedProductList, inventoryContainerDetails, inventoryDetails }) => {

          if (aggregatedProductList.length === 0 && this.productPagination.offset === 0) {
            this.notFoundMessage = this.app.verses.pos.productNotFound;
            this._focusProductSearchField();
            cbfn();
            return;
          }

          // Prepare Products
          let productList = aggregatedProductList.map(product => {
            let { purchasePrice, salePrice } = product.product;
            let { name, unit, defaultVat, identifierCode } = product.product.productBlueprint;
            let vatValue = defaultVat;
            Object.assign(product, { name, unit, purchasePrice, salePrice, vatValue, identifierCode });
            return product;
          });

          if (productList.length === 1 && this.productSearchString.length > 0 && productList[0].identifierCode === this.productSearchString) {
            // search by identifierCode was successful.
            productList[0].selectedCount = 1;
            this._selectProduct({ product: productList[0], isSelectedByIdentifierCode: true });
            this.productSearchString = '';
          } else {
            this.matchingProductList = productList;
          }

          cbfn();
        });
      }

      _selectProduct({ product, isSelectedByIdentifierCode = false }) {
        let { productId, name, selectedCount, count, salePrice, vatValue, unit } = product;
        let maxAllowedCount = count;
        selectedCount = parseFloat(String(selectedCount));
        let minSalePrice = salePrice;

        let existingProductIndex = this.productList.findIndex(existingProduct => existingProduct.productId === product.productId);
        if (existingProductIndex > -1) {
          let existingProduct = this.productList[existingProductIndex];
          this.set(`productList.${existingProductIndex}.selectedCount`, (parseFloat(existingProduct.selectedCount) + selectedCount));
        } else {
          this.unshift('productList', { productId, name, selectedCount, maxAllowedCount, salePrice, vatValue, minSalePrice, unit });
        }
        this.productListChanged();

        if (isSelectedByIdentifierCode) {
          this._focusProductSearchField();
        }
      }

      _resetProductSearch() {
        this.notFoundMessage = '';
        this.productSearchString = '';
        this.matchingProductList = [];
      }

      productSearchFieldKeypressed(e) {
        this.notFoundMessage = '';
        if (e.which === 13) {
          this.productSearchTapped(null);
        } else if (e.which === 27) {
          this._resetProductSearch();
        } else {
          this.matchingProductList = [];
        }
      }

      productSearchClearTapped(e) {
        this._resetProductSearch();
        this._focusProductSearchField();
      }

      _focusProductSearchField() {
        const fn = () => {
          try {
            this.elem('#product-search-field').focus();
          } catch (ex) {
          }
        }
        this.delay(100, fn);
        fn();
      }

      productSearchTapped(e = null) {
        if (!this.isReady) return;
        this.productPaginate.offset = 0;
        this.isReady = false;
        this._searchProducts(() => {
          this.isReady = true;
        });
      }

      showMoreProductsTapped(e = null) {
        this.set('productPaginate.offset', this.productPaginate.offset + this.productPaginate.limit);
        this.isReady = false;
        this._searchProducts(() => this.isReady = true);
      }

      showPreviousProductsTapped(e = null) {
        this.set('productPaginate.offset', Math.max(0, this.productPaginate.offset - this.productPaginate.limit));
        this.isReady = false;
        this._searchProducts(() => this.isReady = true);
      }

      selectMatchingProductTapped(e) {
        let { product } = e.model;
        product.selectedCount = 1;
        this._selectProduct({ product });
      }

      productListChanged() {
        this.app.storeInSession('pos-selected-product-list', this.productList);
        this._calculatePayment({ resetRounding: true });
      }

      // sub-region: post selection

      productSelectedCountInputChanged(e) {
        this.enforceMinMaxOnPaperInput(e);
        this._calculatePayment({ resetRounding: true });
      }

      editProductSalePriceTapped(e) {
        let { product } = e.model;
        this.app.showModalInput(this.verses.sales.editSalePrice, this.verses.sales.editSalePriceDetails, product.salePrice, (answer) => {
          let salePrice = parseFloat(answer);
          if (salePrice >= 0) {
            e.model.set('product.salePrice', salePrice);
            this._calculatePayment({ resetRounding: true });
          }
        });
      }

      discardProductTapped(e) {
        let { productIndex } = e.model;
        this.splice('productList', productIndex, 1);
        this.productListChanged();
        this._calculatePayment({ resetRounding: true });
      }

      productSelectionDoneTapped(e = null) {
        this._resetProductSearch();
        this.selectedTabName = 'customer';
        this._scrollToNavBar();
        this._calculatePayment({ resetRounding: true });
      }

      // region: services =================================

      // subregion: search

      _fetchOutletServiceListOnline(cbfn) {
        let data = {
          outletId: parseInt(this.params.outlet),
          searchString: this.serviceSearchString,
          paginate: this.servicePaginate
        };

        this.app.callGetActiveServiceListApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          this.servicePagination = response.pagination;
          return cbfn(response);
        });
      }

      _fetchOutletServiceListOffline(cbfn) {
        window.setTimeout(() => {
          let response = JSON.parse(JSON.stringify(this.app.offlineData.cache.getActiveServiceList));

          let searchString = String(this.serviceSearchString);
          if (searchString.length > 0) {
            searchString = searchString.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            let regex = new RegExp(searchString, 'g');
            response.serviceList = response.serviceList.filter(product => {
              return regex.test(product.product.productBlueprint.name);
            });
          }

          ([response.serviceList, response.pagination] = this._paginateOfflineData(response.serviceList));

          this.servicePagination = response.pagination;
          cbfn(response);
        }, 100);
      }

      _fetchOutletServiceList(cbfn) {
        if (this.isInOfflineMode) {
          // FIXME: Probably not going to work
          this._fetchOutletServiceListOffline(cbfn);
        } else {
          this._fetchOutletServiceListOnline(cbfn);
        }
      }

      _searchServices(cbfn) {
        this._fetchOutletServiceList(({ serviceList }) => {

          if (serviceList.length === 0 && this.servicePagination.offset === 0) {
            this.notFoundMessage = this.app.verses.pos.serviceNotFound;
            this._focusServiceSearchField();
            cbfn();
            return;
          }

          this.matchingServiceList = serviceList.map(service => {
            let { salePrice } = service;
            let { name, defaultVat, isCustomerRequired, isEmployeeAssignable, isLongstanding, serviceDuration } = service.serviceBlueprint;
            service.isSelected = false;
            let vatValue = defaultVat;
            let assignedEmploymentId = null;
            Object.assign(service, { name, salePrice, vatValue, isCustomerRequired, isEmployeeAssignable, assignedEmploymentId, isLongstanding, serviceDuration });
            return service;
          });

          cbfn();
        });
      }

      _selectService({ service }) {
        let { id, name, salePrice, vatValue, isCustomerRequired, isEmployeeAssignable, assignedEmploymentId, isLongstanding, serviceDuration } = service;
        let minSalePrice = salePrice;
        this.push('serviceList', { id, name, minSalePrice, salePrice, vatValue, isCustomerRequired, isEmployeeAssignable, assignedEmploymentId, isLongstanding, serviceDuration });
        this.serviceListChanged();
      }

      _resetServiceSearch() {
        this.notFoundMessage = '';
        this.serviceSearchString = '';
        this.matchingServiceList = [];
      }

      serviceSearchFieldKeypressed(e) {
        this.notFoundMessage = '';
        if (e.which === 13) {
          this.serviceSearchTapped(null);
        } else if (e.which === 27) {
          this._resetServiceSearch();
        } else {
          this.matchingServiceList = [];
        }
      }

      serviceSearchClearTapped(e) {
        this._resetServiceSearch();
        this._focusServiceSearchField();
      }

      _focusServiceSearchField({ repeat = true } = {}) {
        const fn = () => {
          try {
            this.elem('#service-search-field').focus();
          } catch (ex) { }
        }
        if (repeat) {
          this.delay(100, fn);
        }
        fn();
      }

      serviceSearchTapped(e = null) {
        if (!this.isReady) return;
        this.servicePaginate.offset = 0;
        this.isReady = false;
        this._searchServices(() => {
          this.isReady = true;
        });
      }

      showMoreServicesTapped(e = null) {
        this.set('servicePaginate.offset', this.servicePaginate.offset + this.servicePaginate.limit);
        this.isReady = false;
        this._searchServices(() => this.isReady = true);
      }

      showPreviousServicesTapped(e = null) {
        this.set('servicePaginate.offset', Math.max(0, this.servicePaginate.offset - this.servicePaginate.limit));
        this.isReady = false;
        this._searchServices(() => this.isReady = true);
      }

      selectMatchingServiceTapped(e) {
        let { service } = e.model;
        service.selectedCount = 1;
        this._selectService({ service });
      }

      serviceListChanged() {
        this.app.storeInSession('pos-selected-service-list', this.serviceList);
        this._calculatePayment({ resetRounding: true });
      }

      // sub-region: post selection

      editServiceSalePriceTapped(e) {
        let { service } = e.model;
        this.app.showModalInput(this.verses.sales.editSalePrice, this.verses.sales.editSalePriceDetails, service.salePrice, (answer) => {
          let salePrice = parseFloat(answer);
          if (salePrice >= 0) {
            e.model.set('service.salePrice', salePrice);
            this._calculatePayment({ resetRounding: true });
          }
        });
      }

      discardServiceTapped(e) {
        let { serviceIndex } = e.model;
        this.splice('serviceList', serviceIndex, 1);
        this.serviceListChanged();
        this._calculatePayment({ resetRounding: true });
      }

      serviceSelectionDoneTapped(e = null) {
        this._resetServiceSearch();
        this.selectedTabName = 'customer';
        this._scrollToNavBar();
        this._calculatePayment({ resetRounding: true });
      }

      // region: customer =================================

      _customerVariablesChanged() {
        this.app.storeInSession('last-selected-customer', this.customer);
        this.app.storeInSession('last-selected-customer-is-anonymous', this.isAnonymousSale);
        if ((this.customer || this.isAnonymousSale) && this.isMultiColumn) {
          window.setTimeout(() => {
            this.elem('.payment--paidAmount').focus();
          }, 100);
        }
      }

      customerColumnTapped(e = null) {
        this._resetProductSearch();
        this._resetServiceSearch();
      }

      removeCustomerTapped(e = null) {
        this.customer = null;
        this.isAnonymousSale = false;
        this._customerVariablesChanged();
      }

      customerChanged() {
        if (!this.customer) return;
        this._customerVariablesChanged();
      }

      _processGetCustomer({ customerId }, cbfn) {
        let data = {
          customerId
        };
        this.app.callGetCustomerApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          cbfn(response.customer);
        });
      }

      _customerSelected(customer) {
        this.customer = customer;
      }

      _processCreateCustomer({ fullName, phone, email, address }, cbfn) {
        if (!email) email = null;
        if (!phone) phone = null;
        let data = {
          fullName, phone, email, address,
          organizationId: this.app.organization.id
        };
        this.app.callAddCustomerApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error, 'editCustomerForm');
          let message = this.app.verses.customer.newCustomerCreated;
          this.app.showToast(message, _ => {
            let customerId = response.customerId;
            cbfn({ customerId });
          });
        });
      }

      createCustomerTapped(e = null) {
        this.elemAll('#editCustomerForm paper-input').forEach(el => el.autoValidate = true);
        if (!this.elem('#editCustomerForm').validate()) return;

        let { fullName, phone, email, address } = this.editCustomerForm;
        this._processCreateCustomer({ fullName, phone, email, address }, ({ customerId }) => {
          this._processGetCustomer({ customerId }, (customer) => {
            this.customer = customer;
            this.isAnonymousSale = false;
            this._customerVariablesChanged();
            this.elem('elem-customer-selector').cancelTapped();
            this._scrollToNavBar();
          });
        });
      }

      skipCustomerSelectionTapped(e = null) {
        this.isAnonymousSale = true;
        this._customerVariablesChanged();
        this.elem('elem-customer-selector').cancelTapped();
        this._scrollToNavBar();
        if (!this.isMultiColumn) {
          this.customerSelectionDoneTapped(null);
        }
      }

      $shouldShowCustomerSelectionOptions(customer, isAnonymousSale) {
        if (!customer && !isAnonymousSale) return true;
        return false;
      }

      customerSelectionDoneTapped(e) {
        this.selectedTabName = 'payment';
        this._customerVariablesChanged();
        this._scrollToNavBar();
      }

      // region: payment =================================

      paidAmountInputFocuesd(e) {
        try {
          e.target.inputElement.inputElement.select();
        } catch (ex) {
          'pass'
        }
      }

      paymentColumnTapped(e = null) {
        this._resetProductSearch();
        this._resetServiceSearch();
      }

      paymentMethodSelected(e) {
        // NOTE: The timeout should not be necessary. However, without it
        // the value of this.payment.paymentMethod is not being updated in time.
        window.setTimeout(() => {
          this._calculatePayment();
        }, 100);
      }

      genericPaymentInputChanged(e) {
        this.enforceMinMaxOnPaperInput(e);
        if (e.target.className.indexOf('payment--paidAmount') > -1) {
          this._calculatePayment({ resetRounding: false });
        } else {
          this._calculatePayment();
        }
      }

      buttonGoToDiscountTapped() {
        this.app.navigateTo(`/edit-discount-preset/from:pos`);
      }

      selectedDiscountPresetChanged() {
        if (this.selectedDiscountPreset === '--no-discount') {
          this.payment.discountPresetId = null;
          this.payment.discountType = 'percent';
          this.payment.discountValue = '0';
        } else {
          let key = parseInt(String(this.selectedDiscountPreset));
          let discountPreset = this.discountPresetList.find(discountPreset => discountPreset.id === key);
          this.payment.discountPresetId = discountPreset.id;
          this.payment.discountType = discountPreset.discountType;
          this.payment.discountValue = discountPreset.discountValue;
        }
        this._calculatePayment();
      }

      _fetchDiscountPresetList(cbfn) {
        let data = { organizationId: this.app.organization.id };
        this.app.callGetDiscountPresetListApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          return cbfn(response.discountPresetList);
        });
      }

      _processDiscountPresetList(cbfn) {
        if (this.isInOfflineMode) return cbfn(null);
        this._fetchDiscountPresetList(discountPresetList => {
          this.discountPresetList = discountPresetList;
          return cbfn();
        });
      }

      getDiscountPresetLabel(discountPreset) {
        let { name, discountType, discountValue } = discountPreset;
        if (discountType === 'percent') {
          return `${name} (${discountValue}%)`;
        } else {
          return `${name} (${discountValue} ${this.app.organization.settings.monetaryUnit})`;
        }
      }

      _fetchPaymentMethodList(cbfn) {
        // only for offline mode
        if (this.isInOfflineMode) {
          window.setTimeout(() => {
            cbfn(this.app.offlineData.cache.getPaymentMethodListResponse.paymentMethodList);
          }, 10);
          return;
        }

        let data = { organizationId: this.app.organization.id, paginate: this.paginate };
        this.app.callGetPaymentMethodListApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          this.pagination = response.pagination;
          return cbfn(response.paymentMethodList);
        });
      }

      _processPaymentMethodList(cbfn) {
        this._fetchPaymentMethodList(paymentMethodList => {
          this.paymentMethodList = paymentMethodList;
          if (paymentMethodList.length === 0) {
            return this.app.navigateTo('/manage-payment-methods');
          }

          let defaultPaymentMethod = paymentMethodList[0]

          this.set('payment.paymentMethodId', defaultPaymentMethod.id);
          return cbfn();
        });
      }

      // main payment calculation method
      _calculatePayment({ resetRounding = true } = {}) {
        let {
          totalAmount,
          vatAmount,
          discountType,
          discountValue,
          discountedAmount,
          serviceChargeAmount,
          totalBillBeforeRounding,
          roundedByAmount,
          totalBilled,
          shouldSaveChangeInAccount,
          paymentMethodId,
          paidAmount,
          changeAmount,
          discountPresetId = null
        } = this.payment;

        if (paymentMethodId === null || typeof (paymentMethodId) === 'undefined') return;
        let paymentMethodDetails = this.paymentMethodList.find(pm => pm.id === paymentMethodId);

        let totalProductAmount = this.calculateTotalProductAmount();
        let totalServiceAmount = this.calculateTotalServiceAmount();

        vatAmount = this.calculateVatBeforeDiscount();

        // totalAmount of service and product sale price(s)
        totalAmount = parseFloat(totalProductAmount) + parseFloat(totalServiceAmount);

        discountedAmount = this.calculateDiscount({ discountType, discountValue, totalAmount });

        if (this.app.organization.settings.vatRule === 'vat-after-discount' && discountType === 'percent') {
          vatAmount = this.calculateVatAfterDiscount({ vatAmount, discountValue });
        }

        // updating totalBilled with calculated totalAmount, vatAmount and discountedAmount
        totalBilled = totalAmount + vatAmount - discountedAmount;
        this.totalBilledCopy = totalBilled;

        // service charge calculation
        if (serviceChargeAmount) {
          totalBilled += parseFloat(serviceChargeAmount);
        }

        // take rounding into account
        if (resetRounding) roundedByAmount = 0;
        totalBillBeforeRounding = totalBilled;
        totalBilled = totalBillBeforeRounding - roundedByAmount;

        // setting the default paid amount equal to total billed
        if (paymentMethodDetails.monetaryAccountDetails.codeName !== 'CASH' && paidAmount < 1) {
          paidAmount = totalBilled;
        }

        // calculating change amount, paid amount
        if (paidAmount > totalBilled) {
          changeAmount = paidAmount - totalBilled;
        } else {
          changeAmount = 0;
        }

        // returning updated payment info
        this.payment = {
          totalAmount,
          vatAmount,
          discountType,
          discountValue,
          discountedAmount,
          serviceChargeAmount,
          totalBillBeforeRounding,
          roundedByAmount,
          totalBilled,
          paidAmount,
          changeAmount,
          shouldSaveChangeInAccount,
          paymentMethodId,
          discountPresetId
        };
      }

      calculateTotalProductAmount() {
        let totalProductAmount = 0;

        this.productList.forEach(product => {
          let { salePrice, selectedCount } = product;
          let salePriceForAllSelected = parseFloat(salePrice * selectedCount);
          totalProductAmount += salePriceForAllSelected;
        });

        return totalProductAmount;
      }

      calculateTotalServiceAmount() {
        let totalServiceAmount = 0;

        this.serviceList.forEach(service => {
          let { salePrice } = service;
          totalServiceAmount += parseFloat(salePrice);
        });

        return totalServiceAmount;
      }

      calculateVatBeforeDiscount() {
        let vatAmount = 0;

        this.productList.forEach(product => {
          let { salePrice, selectedCount, vatValue } = product;
          let salePriceForAllSelected = parseFloat(salePrice * selectedCount);
          vatAmount += salePriceForAllSelected * (vatValue / 100);
        });

        this.serviceList.forEach(service => {
          let { salePrice, vatValue } = service;
          vatAmount += parseFloat(salePrice) * (vatValue / 100);
        });

        return vatAmount;
      }

      calculateDiscount({ discountType, discountValue, totalAmount }) {
        let discountedAmount = 0;

        if (discountValue) {
          if (discountType === 'percent') {
            discountedAmount = totalAmount * (discountValue / 100);
          } else if (discountType === 'fixed') {
            discountedAmount = discountValue;
          }
        }

        return discountedAmount;
      }

      calculateVatAfterDiscount({ vatAmount, discountValue }) {
        vatAmount -= vatAmount * (discountValue / 100);
        return vatAmount;
      }

      clearRounderByAmountTapped(e = null) {
        this.payment.roundedByAmount = 0;
        this._calculatePayment();
      }

      editTotalBilledTapped(e = null) {
        this.app.showModalInput(this.verses.sales.editBill, this.verses.sales.editBillDetails, this.payment.totalBilled, (answer) => {
          if (parseFloat(answer) > 0) {
            let roundedByAmount = (this.payment.totalBillBeforeRounding - parseFloat(answer));
            if (roundedByAmount < 0) {
              this.app.showModalDialog(this.verses.pos.invalidAmount, this.verses.pos.invalidTotalBillAmountMessage);
              return;
            }
            this.payment.roundedByAmount = roundedByAmount;
            this._calculatePayment({ resetRounding: false });
          }
        });
      }

      _processAddSalesOnline(data, cbfn) {
        data.wasOfflineSale = false;
        this.app.callAddSalesApi(data, (err, response) => {
          if (err) return;
          if (response.hasError) return this.onApiError(response.error);
          cbfn(response);
        });
      }

      _processAddSalesOffline(salesData, cbfn) {
        if (salesData.payment.totalBilled > salesData.payment.paidAmount) {
          this.app.showModalDialog(this.verses.general.errorMessageTitle, this.verses.pos.disallowCreditSale);
          return;
        }
        this.app.db.update('offline-data', (({ which }) => which === 'only'), offlineData => {
          if (!offlineData.data.unsyncedSalesIdSeed) offlineData.data.unsyncedSalesIdSeed = 0;
          offlineData.data.unsyncedSalesIdSeed += 1;
          salesData.id = 'OFFLINE-' + offlineData.data.unsyncedSalesIdSeed;
          salesData.createdDatetimeStamp = Date.now();
          offlineData.data.unsyncedSalesList.push(salesData);
          return offlineData;
        });
        cbfn({ salesId: salesData.id });
      }

      _processAddSales({ sentVia }, cbfn) {
        let outletId = this.params.outlet;
        let payment = this.payment;

        let customerId = null;
        if (this.customer) {
          customerId = this.customer.id;
        }

        let productList = this.productList.map(product => {
          let { name, productId, selectedCount, salePrice, vatValue } = product;
          let vatPercentage = vatValue;
          let finalProduct = { productId, count: selectedCount, salePrice, vatPercentage };
          if (this.isInOfflineMode) {
            finalProduct.productBlueprintName = name;
            finalProduct.returnedProductCount = 0;
            finalProduct.count = parseInt(String(finalProduct.count));
          }
          return finalProduct;
        });

        let serviceList = this.serviceList.map(service => {
          let { id, salePrice, vatValue, assignedEmploymentId, name } = service;
          let serviceId = id;
          let vatPercentage = vatValue;
          let finalService = { serviceId, salePrice, vatPercentage, assignedEmploymentId };
          if (this.isInOfflineMode) {
            finalService.serviceBlueprintName = name;
          }
          return finalService;
        });

        let assistedByEmployeeId = (this.assignedAssistedByEmployee) ? this.assignedAssistedByEmployee.id : null;

        let productsSelectedFromWarehouseId = this.productsSelectedFromWarehouseId;

        if (this.isInOfflineMode && productsSelectedFromWarehouseId !== null) {
          return this.app.showModalDialog(this.verses.pos.saleNotValid, this.verses.pos.offlineWarehouseSellNotAllowed);
        }

        let data = {
          customerId, outletId, productList, serviceList, assistedByEmployeeId, payment,
          productsSelectedFromWarehouseId,
          sentVia
        };

        if (this.isInOfflineMode) {
          this._processAddSalesOffline(data, cbfn);
        } else {
          this._processAddSalesOnline(data, cbfn);
        }
      }

      isDiscountTypePercent(discountType) {
        return (discountType === 'percent');
      }

      // NOTE: Probably not in use
      // isPaymentMethodCash(paymentMethod) {
      //   return (paymentMethod === 'cash');
      // }

      // isPaymentMethodChangeWallet(paymentMethod) {
      //   return (paymentMethod === 'change-wallet');
      // }

      isValidCreditSale(customer, totalBilled, paidAmount) {
        return (customer && totalBilled > paidAmount);
      }

      // region: finalize & offline mode =================================

      _resetSales({ refreshCurrentPage = true } = {}) {
        this.selectedDiscountPreset = '--no-discount';
        this.selectedWarehouse = '--current-outlet';
        this.productsSelectedFromWarehouseId = null;

        this.app.extractFromSession('pos-sales-type');

        this.app.extractFromSession('pos-selected-warehouse');
        this.app.extractFromSession('product-selected-from-warehouse-id');
        this.app.extractFromSession('last-selected-customer');

        this.app.extractFromSession('pos-selected-product-list');
        this.app.extractFromSession('pos-selected-service-list');

        this.app.extractFromSession('last-selected-customer');
        this.app.extractFromSession('last-selected-customer-is-anonymous');

        this.app.extractFromSession('pos-assigned-assisted-by-employee');

        this.productSourceSelectionComplete = false;
        this.productSourceToDisplay = '';
        this.productSearchString = '';
        this.serviceSearchString = '';
        this.resetProperties('payment', 'productList', 'serviceList', 'customer', 'isAnonymousSale', 'salesType', 'editCustomerForm');
        this.removeAutoValidation('#editCustomerForm paper-input');

        if (refreshCurrentPage) {
          this.app.refreshCurrentPage();
        }
      }

      _sendReceiptBySms({ data, receiptToken }) {
        let organizationName = this.organization.name;

        if (organizationName.length > 48) {
          organizationName = organizationName.slice(0, 45) + ' ..';
        }
        let { totalBilled, changeAmount } = data.payment;
        totalBilled = Math.round(totalBilled * 100) / 100;
        changeAmount = Math.round(changeAmount * 100) / 100;

        let body = `${organizationName}
Total ${totalBilled}
Change ${changeAmount}

Full receipt: https://lipi.shop/r/${receiptToken}

Powered by Lipi for Business.`;

        let phone = data.customer.phone;

        if (window.hasOwnProperty("cordova")) {
          // alert("Using cordova method");

          sendSmsUsingCordova(phone, body);

        } else {
          // alert("Using browser method");

          phone = encodeURIComponent(phone);
          body = encodeURIComponent(body);
          let url = `sms:${phone};?&body=${body}`;

          try {
            window.open(url);
          } catch (ex) {
            const message = "Unable to send SMS. Please contact developers with the following messag: " + ex.message;
            alert(message);
          }
        }
      }

      saveSaleTapped(e = null) {
        let canHaveEmailReceipt = false;
        let canHaveSmsReceipt = false;
        if (this.customer) {
          if (this.customer.email) canHaveEmailReceipt = true;
          if (this.customer.phone) canHaveSmsReceipt = true;
        }
        this.app.displayReceiptDialog({ canHaveEmailReceipt, canHaveSmsReceipt }, ({ receiptType }) => {
          if (receiptType === 'close') {
            'pass'
          } else if (receiptType === 'print-receipt') {
            this._processAddSales({ sentVia: 'print' }, ({ salesId }) => {
              this._resetSales();
              return this.app.navigateTo(`/print-sales-receipt/sales:${salesId}/from:pos`);
            });
          } else if (receiptType === 'email-receipt') {
            this._processAddSales({ sentVia: 'email' }, ({ salesId }) => {
              let message = this.app.verses.pos.newSalesAdded;
              this.app.showToast(message, _ => {
                this._resetSales();
              });
            });
          } else if (receiptType === 'sms-receipt') {
            this._processAddSales({ sentVia: 'sms' }, ({ receiptToken }) => {
              let message = this.app.verses.pos.newSalesAdded;
              this.app.showToast(message, _ => {

                let data = {
                  payment: this.payment,
                  customer: this.customer,
                }

                this._sendReceiptBySms({
                  data: JSON.parse(JSON.stringify(data)),
                  receiptToken
                });

                this._resetSales();

              });
            });
          } else if (receiptType === 'no-receipt') {
            this._processAddSales({ sentVia: 'none' }, ({ salesId }) => {
              let message = this.app.verses.pos.newSalesAdded;
              this.app.showToast(message, _ => {
                this._resetSales();
              });
            });
          }
        });
      }

      // saveSaleTapped(e = null) {
      //   this._processAddSales(({ salesId }) => {
      //     let message = this.app.verses.pos.newSalesAdded;
      //     this.app.showToast(message, _ => {
      //       this._resetSales();
      //     });
      //   });
      // }

      // saveSaleAndPrintTapped(e = null) {
      //   this._processAddSales(({ salesId }) => {
      //     this._resetSales();
      //     return this.app.navigateTo(`/print-sales-receipt/sales:${salesId}/from:pos`);
      //   });
      // }

      discardSalesTapped(e = null) {
        this.app.showModalConfirmation(
          this.app.verses.pos.discardSalesTitle,
          this.app.verses.pos.discardSalesText,
          (answer) => {
            if (!answer) return;
            this._resetSales();
          });
      }

      toggleAllOfflineSalesTapped(e = null) {
        this.shouldExpandOfflineSalesList = !this.shouldExpandOfflineSalesList;
      }

      printOfflineSalesTapped(e) {
        return this.app.navigateTo(`/print-sales-receipt/sales:${e.model.unsyncedSales.id}/from:pos`);
      }

      discardOfflineSalesTapped(e) {
        let salesId = e.model.unsyncedSales.id;
        this.app.db.update('offline-data', (({ which }) => which === 'only'), offlineData => {
          let index = offlineData.data.unsyncedSalesList.findIndex(sales => sales.id === salesId);
          if (index > -1) {
            offlineData.data.unsyncedSalesList.splice(index, 1);
          }
          return offlineData;
        });
      }

      _submitAnOfflineSales(unsyncedSales, cbfn) {
        unsyncedSales = JSON.parse(JSON.stringify(unsyncedSales));

        // Remove temporarily added properties (that were required for offline preview)
        unsyncedSales.productList.forEach(product => {
          delete product.productBlueprintName;
          delete product.returnedProductCount;
        });
        unsyncedSales.serviceList.forEach(service => {
          delete service.serviceBlueprintName;
        });
        delete unsyncedSales.id;
        delete unsyncedSales.createdDatetimeStamp;

        unsyncedSales.wasOfflineSale = true;
        this.app.callAddSalesApi(unsyncedSales, (err, response) => {
          if (err) return cbfn(err, null, null);
          if (response.hasError) {
            return this.onApiError(response.error, null, () => {
              return cbfn(null, response.error, null);
            });
          }
          cbfn(null, null, response);
        });
      }

      goOnlineTapped() {
        if (this.isInOfflineMode) {
          this.app.callUserAssertApiKeyApi({}, (err, response) => {
            if (err) {
              this.app.showModalDialog(this.verses.root.networkErrorTitle, this.verses.root.networkErrorContent);
              return;
            }
            this.app.toggleOfflineMode();
          });
        }
      }

      submitAllOfflineSalesTapped(e) {
        let list = this.offlineData.data.unsyncedSalesList;
        let left = list.length;
        const submitNext = () => {
          if (!left) {
            if (this.isInOfflineMode) {
              this.app.toggleOfflineMode();
            }
            return;
          }

          left -= 1;
          let unsyncedSales = list[left];

          this._submitAnOfflineSales(unsyncedSales, (networkError, validationError, response) => {
            if (networkError) {
              return;
            }
            if (validationError) return submitNext();

            this.app.db.update('offline-data', (({ which }) => which === 'only'), offlineData => {
              let index = offlineData.data.unsyncedSalesList.findIndex(sales => sales.id === unsyncedSales.id);
              if (index > -1) {
                offlineData.data.unsyncedSalesList.splice(index, 1);
              }
              return offlineData;
            });

            submitNext();
          });

        }
        submitNext();
      }

      onOfflineDataChange() {
        this.isInOfflineMode = this.app.isInOfflineMode;
        this.offlineData = this.app.offlineData;

        // NOTE: Willingly written in an expressive manner
        if (this.isInOfflineMode) {
          this.app.currentPageAllowsBackButton = false;
        } else {
          this.app.currentPageAllowsBackButton = true;
        }
      }

      // region: misc =================================

      productListOrServiceListHasElement(productListLength, serviceListLength) {
        return (productListLength || serviceListLength);
      }

      assignEmployeeTapped(e) {
        let { id } = e.model.service;
        this._resetServiceSearch();
        return this.app.navigateTo(`/pos-assign-employee-service/service:${id}`);
      }

      assignAssistedByEmployeeTapped() {
        return this.app.navigateTo(`/pos-assign-assisted-by-employee`);
      }

    }

    window.customElements.define(PagePos.is, PagePos);
  </script>
</dom-module>