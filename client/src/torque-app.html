<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../bower_components/atomicdb/atomicdb.html">

<link rel="import" href="../bower_components/polymer-fx/fx-app.html">
<link rel="import" href="../bower_components/polymer-fx/fx-dialog-behavior.html">
<link rel="import" href="../bower_components/polymer-fx/fx-common-behavior.html">
<link rel="import" href="../bower_components/polymer-fx/fx-page-manager-behavior.html">

<link rel="import" href="torque-db-behavior.html">
<link rel="import" href="torque-http-behavior.html">
<link rel="import" href="torque-language-behavior.html">
<link rel="import" href="torque-common-behavior.html">

<link rel="import" href="elem-not-ready.html">

<script src="xdate.js"></script>
<script src="csv.min.js"></script>

<script src="torque-utils.js"></script>

<link rel="lazy-import" href="page-home.html">
<link rel="lazy-import" href="page-payment.html">
<link rel="lazy-import" href="page-settings.html">
<link rel="lazy-import" href="page-error404.html">
<link rel="lazy-import" href="page-error403.html">
<link rel="lazy-import" href="page-about.html">
<link rel="lazy-import" href="page-login.html">
<link rel="lazy-import" href="page-verify.html">
<link rel="lazy-import" href="page-confirm-password-reset.html">
<link rel="lazy-import" href="page-register.html">
<link rel="lazy-import" href="page-toc.html">
<link rel="lazy-import" href="page-edit-profile.html">
<link rel="lazy-import" href="page-add-organization.html">
<link rel="lazy-import" href="page-manage-organizations.html">
<link rel="lazy-import" href="page-manage-employees.html">
<link rel="lazy-import" href="page-add-employee.html">
<link rel="lazy-import" href="page-view-employee.html">
<link rel="lazy-import" href="page-edit-employee.html">
<link rel="lazy-import" href="page-hire-employee.html">
<link rel="lazy-import" href="page-manage-outlets.html">
<link rel="lazy-import" href="page-edit-outlet.html">
<link rel="lazy-import" href="page-view-outlet.html">
<link rel="lazy-import" href="page-manage-warehouses.html">
<link rel="lazy-import" href="page-edit-warehouse.html">
<link rel="lazy-import" href="page-view-warehouse.html">
<link rel="lazy-import" href="page-manage-product-blueprints.html">
<link rel="lazy-import" href="page-edit-product-blueprint.html">

<link rel="lazy-import" href="page-manage-service-blueprints.html">
<link rel="lazy-import" href="page-edit-service-blueprint.html">
<link rel="lazy-import" href="page-manage-outlet-services.html">

<link rel="lazy-import" href="page-view-inventory.html">
<link rel="lazy-import" href="page-edit-product.html">
<link rel="lazy-import" href="page-add-products.html">
<link rel="lazy-import" href="page-manage-customers.html">
<link rel="lazy-import" href="page-view-customer.html">
<link rel="lazy-import" href="page-edit-customer.html">
<link rel="lazy-import" href="page-withdraw-from-change-wallet-balance.html">
<link rel="lazy-import" href="page-pos.html">
<link rel="lazy-import" href="page-report-sales.html">
<link rel="lazy-import" href="page-report-inventories.html">
<link rel="lazy-import" href="page-report-select-inventories.html">
<link rel="lazy-import" href="page-pos-select-products.html">
<link rel="lazy-import" href="page-pos-assign-employee-service.html">
<link rel="lazy-import" href="page-pos-select-services.html">
<link rel="lazy-import" href="page-manage-sales.html">
<link rel="lazy-import" href="page-view-sales.html">
<link rel="lazy-import" href="page-manage-sales-return.html">
<link rel="lazy-import" href="page-edit-sales-return.html">
<link rel="lazy-import" href="page-manage-service-membership.html">
<link rel="lazy-import" href="page-view-sales-return.html">
<link rel="lazy-import" href="page-bulk-import-product-blueprints.html">
<link rel="lazy-import" href="page-select-geolocation.html">

<link rel="import" href="shared-icons.html">
<link rel="import" href="shared-styles.html">

<dom-module id="torque-app">
  <template>
    <style include="shared-styles">
      /* ============= variables ============= */

      :host {
        --app-primary-color: #009688;
        --app-primary-color-dark: #004D40;
        --app-primary-color-light: #B2DFDB;
        --app-primary-text-color: #ffffff;
        --app-text: #000000;
        --app-text-light: #424242;
        --app-text-lighter: #757575;
        --app-text-invert: #ffffff;

        --app-button-primary: #009688;
        --app-button-label-primary: #FFFFFF;
        --app-button-secondary: #B2DFDB;
        --app-button-label-secondary: #00695C;
        --app-button-danger: #ffcdd2;
        --app-button-label-danger: #c62828;
        --app-button-neutral: #CFD8DC;
        --app-button-label-neutral: #263238;

        display: block;
      }

      /* ============= styles ============= */

      @media print {

        app-drawer,
        app-header,
        .footer {
          display: none;
        }
      }

      /* ============= styles ============= */

      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }

      app-header {
        color: var(--app-primary-text-color);
        background-color: var(--app-primary-color);
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: var(--app-primary-text-color);
      }

      .drawer-list {
        margin: 0 020px;
      }

      .logout-link,
      .drawer-list a {
        display: block;
        padding: 0 16px;
        text-decoration: none;
        color: var(--app-text);
        line-height: 40px;
      }

      .drawer-list a.iron-selected {
        color: var(--app-text);
        font-weight: bold;
      }

      .footer {
        margin-top: 36px;
        margin-bottom: 36px;
        text-align: center;
        color: var(--app-text-lighter);
        line-height: 100%;
      }

      .title-line-2 {
        font-size: 14px;
        margin: 0px;
        padding: 0px;
        line-height: 0px;
        margin-top: 4px;
      }

      .top-nav-spinner {
        --paper-spinner-color: white;
      }

      .language-active {
        border-bottom: 2px solid #009688;
      }

      .language-icon {
        cursor: pointer;
      }

      .app-drawer-wrapper {
        display: block;
        height: 100vh;
        overflow-y: auto;
      }

      .sidebar-divider {
        border: 0;
        height: 0;
        border-top: 1px solid rgba(0, 0, 0, 0.2);
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      }
    </style>

    <app-drawer-layout responsive-width="2560px" fullbleed narrow="{{narrow}}">
      <!-- Drawer content -->
      <app-drawer id="drawer" slot="drawer" swipe-open="[[narrow]]" style$="[[$invisibleUnless(user)]]">
        <div class="app-drawer-wrapper">
          <app-toolbar>Torque</app-toolbar>
          <iron-selector selected="[[pageName]]" attr-for-selected="name" class="drawer-list" role="navigation">

            <a name="home" href="#/home">[[verses.sidebar.home]]</a>
            <hr class="sidebar-divider">

            <a name="manage-product-blueprints" href="#/manage-product-blueprints">[[verses.sidebar.productBlueprints]]</a>
            <a name="manage-service-blueprints" href="#/manage-service-blueprints">[[verses.sidebar.serviceBlueprints]]</a>
            <a name="manage-outlets" href="#/manage-outlets">[[verses.sidebar.outlets]]</a>
            <a name="manage-warehouses" href="#/manage-warehouses">[[verses.sidebar.warehouses]]</a>
            <hr class="sidebar-divider">

            <a name="manage-customers" href="#/manage-customers">[[verses.sidebar.customers]]</a>
            <a name="manage-employees" href="#/manage-employees">[[verses.sidebar.employees]]</a>
            <hr class="sidebar-divider">


            <a name="report-sales" href="#/report-sales">[[verses.sidebar.salesReport]]</a>
            <a name="report-inventories" href="#/report-inventories">[[verses.sidebar.inventoryReport]]</a>
            <hr class="sidebar-divider">

            <a name="manage-sales" href="#/manage-sales">[[verses.sidebar.sales]]</a>
            <a name="manage-sales-return" href="#/manage-sales-return">[[verses.sidebar.salesReturn]]</a>
            <a name="manage-service-membership" href="#/manage-service-membership">[[verses.sidebar.serviceMembership]]</a>
            <hr class="sidebar-divider">

            <a name="edit-profile" href="#/edit-profile">[[verses.sidebar.profile]]</a>
            <a name="settings" href="#/settings">[[verses.sidebar.settings]]</a>
            <a name="about" href="#/about">[[verses.sidebar.about]]</a>

          </iron-selector>
        </div>
      </app-drawer>

      <!-- Main content -->
      <app-header-layout has-scrolling-region>

        <app-header slot="header" style$="[[$invisibleUnless(user)]]" fixed>
          <app-toolbar>
            <template is="dom-if" if="[[!currentPageIsModal]]">
              <paper-icon-button icon="shared-icons:menu" drawer-toggle=""></paper-icon-button>
            </template>
            <template is="dom-if" if="[[currentPageIsModal]]">
              <paper-icon-button icon="arrow-back" on-click="backButtonOnTopBarPressed"></paper-icon-button>
            </template>
            <div main-title="" class="flex vertical layout">
              <div style$="[[$computePageTitleFontSize(pageTitleList.length)]]">[[$getPageTitle(pageTitleList.length)]]</div>
              <div class="title-line-2">[[organization.name]]</div>
            </div>
            <template is="dom-if" if="[[$and(activeServiceCount, topSpinnerEnabled)]]">
              <paper-spinner-lite active="" class="top-nav-spinner"></paper-spinner-lite>
            </template>
            <template is="dom-if" if="[[shouldShowPrintButton]]">
              <paper-icon-button icon="print" on-click="printButtonOnTopBarPressed"></paper-icon-button>
            </template>
            <paper-menu-button horizontal-align="right">
              <paper-icon-button icon="icons:apps" slot="dropdown-trigger"></paper-icon-button>
              <paper-listbox slot="dropdown-content" selected="-1">
                <paper-item on-tap="homeTapped">[[verses.topMenu.home]]</paper-item>
                <paper-item on-tap="switchOrganizationTapped">[[verses.topMenu.switchOrganization]]</paper-item>
                <paper-item on-tap="reloadTapped">[[verses.topMenu.reload]]</paper-item>
                <paper-item on-tap="logoutTapped">[[verses.topMenu.logout]]</paper-item>
              </paper-listbox>
            </paper-menu-button>
            <template is="dom-if" if="[[shouldShowSaveButton]]">
              <paper-icon-button icon="save" on-click="saveButtonOnTopBarPressed"></paper-icon-button>
            </template>
          </app-toolbar>
        </app-header>

        <iron-pages on-iron-select="mainIronPagesIronSelected" id="main-iron-pages" selected="[[pageName]]" attr-for-selected="name" fallback-selection="error404" role="main">
          <page-home name="home"></page-home>
          <page-payment name="payment"></page-payment>
          <page-settings name="settings"></page-settings>
          <page-error404 name="error404"></page-error404>
          <page-error403 name="error403"></page-error403>
          <page-about name="about"></page-about>
          <page-login name="login"></page-login>
          <page-verify name="verify"></page-verify>
          <page-confirm-password-reset name="confirm-password-reset"></page-confirm-password-reset>
          <page-register name="register"></page-register>
          <page-toc name="toc"></page-toc>
          <page-edit-profile name="edit-profile"></page-edit-profile>
          <page-add-organization name="add-organization"></page-add-organization>
          <page-manage-organizations name="manage-organizations"></page-manage-organizations>
          <page-manage-employees name="manage-employees"></page-manage-employees>
          <page-add-employee name="add-employee"></page-add-employee>
          <page-view-employee name="view-employee"></page-view-employee>
          <page-edit-employee name="edit-employee"></page-edit-employee>
          <page-hire-employee name="hire-employee"></page-hire-employee>
          <page-manage-outlets name="manage-outlets"></page-manage-outlets>
          <page-edit-outlet name="edit-outlet"></page-edit-outlet>
          <page-view-outlet name="view-outlet"></page-view-outlet>
          <page-manage-warehouses name="manage-warehouses"></page-manage-warehouses>
          <page-view-warehouse name="view-warehouse"></page-view-warehouse>
          <page-edit-warehouse name="edit-warehouse"></page-edit-warehouse>
          <page-manage-product-blueprints name="manage-product-blueprints"></page-manage-product-blueprints>
          <page-edit-product-blueprint name="edit-product-blueprint"></page-edit-product-blueprint>
          <page-manage-service-blueprints name="manage-service-blueprints"></page-manage-service-blueprints>
          <page-edit-service-blueprint name="edit-service-blueprint"></page-edit-service-blueprint>
          <page-manage-outlet-services name="manage-outlet-services"></page-manage-outlet-services>
          <page-view-inventory name="view-inventory"></page-view-inventory>
          <page-edit-product name="edit-product"></page-edit-product>
          <page-add-products name="add-products"></page-add-products>
          <page-manage-customers name="manage-customers"></page-manage-customers>
          <page-view-customer name="view-customer"></page-view-customer>
          <page-edit-customer name="edit-customer"></page-edit-customer>
          <page-withdraw-from-change-wallet-balance name="withdraw-from-change-wallet-balance"></page-withdraw-from-change-wallet-balance>
          <page-pos name="pos"></page-pos>
          <page-report-sales name="report-sales"></page-report-sales>
          <page-report-inventories name="report-inventories"></page-report-inventories>
          <page-report-select-inventories name="report-select-inventories"></page-report-select-inventories>
          <page-pos-select-products name="pos-select-products"></page-pos-select-products>
          <page-pos-select-services name="pos-select-services"></page-pos-select-services>
          <page-pos-assign-employee-service name="pos-assign-employee-service"></page-pos-assign-employee-service>
          <page-manage-sales name="manage-sales"></page-manage-sales>
          <page-view-sales name="view-sales"></page-view-sales>
          <page-manage-sales-return name="manage-sales-return"></page-manage-sales-return>
          <page-edit-sales-return name="edit-sales-return"></page-edit-sales-return>
          <page-manage-service-membership name="manage-service-membership"></page-manage-service-membership>
          <page-view-sales-return name="view-sales-return"></page-view-sales-return>
          <page-print-sales-receipt name="print-sales-receipt"></page-print-sales-receipt>
          <page-bulk-import-product-blueprints name="bulk-import-product-blueprints"></page-bulk-import-product-blueprints>
          <page-select-geolocation name="select-geolocation"></page-select-geolocation>
        </iron-pages>

        <div class="footer">
          <div>
            <img src="../images/icons/en-us.png" data-key="en-us" class$="language-icon [[$getLanguageClass(selectedLanguageIdentifier, 'en-us')]]" on-tap="languageIconTapped">
            <img src="../images/icons/bn-bd.png" data-key="bn-bd" class$="language-icon [[$getLanguageClass(selectedLanguageIdentifier, 'bn-bd')]]" on-tap="languageIconTapped">
          </div>
          <br>
          <br>
          <div>&#xA9; 2017
            <a style="color: var(--app-primary-color-dark);" href="[[authorWebsite]]">[[authorName]]</a>
          </div>
          <div style="margin-top: 12px">[[verses.root.rightsReserved]]</div>
          <div>
            <span class="extra-small" on-click="buildNumberTapped">ver [[appVersion]]</span>
            <paper-icon-button icon="[[websocketConnectivityIndicatorIconName]]" on-tap="websocketConnectivityIndicatorIconTapped"></paper-icon-button>
            <span class="extra-small" on-click="buildNumberTapped">build
              <span id="build-number">[[__deploy.build]]</span>
            </span>
          </div>

        </div>
      </app-header-layout>
    </app-drawer-layout>
    <paper-toast id="generic-toast" text="Done"></paper-toast>
    <div class="super-class-insertion-point"></div>
  </template>

  <script>
    let localDocument = document.currentScript.ownerDocument;

    class TorqueApp extends FxApp.mixin(FxCommonBehavior, FxPageManagerBehavior, FxDialogBehavior, TorqueDbBehavior, TorqueHttpBehavior, TorqueLanguageBehavior, TorqueCommonBehavior) {

      static get is() { return 'torque-app'; }

      static get properties() {
        return {
          __deploy: {
            type: Object,
            value: () => {
              '%__deploy-start'
              return JSON.parse('{"build":144,"datetimeStamp":1545995532841}');
              '%__deploy-end'
            }
          },
          appVersion: {
            type: String,
            value: '0.0.4'
          },
          definitionRevisionVersion: {
            type: Number,
            value: 1
          },
          brandName: {
            type: String,
            value: 'Lipi'
          },
          authorName: {
            type: String,
            value: 'Anvil Global Dynamics'
          },
          authorWebsite: {
            type: String,
            value: 'https://anvil.live'
          },
          currentPageIsModal: {
            type: Boolean,
            value: false
          },
          activeServiceCount: {
            type: Number,
            value: 0
          },
          topSpinnerEnabled: {
            type: Boolean,
            value: true
          },
          shouldShowPrintButton: {
            type: Boolean,
            value: false
          },
          websocketConnectivityIndicatorIconName: {
            type: String,
            value: 'cloud-queue'
          },
          tocVersionUpdatedDatetimeStamp: {
            type: Number,
            value: 1542184791941
          }
        };
      }

      static get template() {
        this.insertExternalTemplate(FxApp.template, '.super-class-insertion-point');
        this.insertExternalTemplate(FxDialogBehavior.template, '.super-class-insertion-point');
        return this.getOwnTemplate();
      }

      static get observers() {
        return [
          'selectedLanguageIdentifierChanged(selectedLanguageIdentifier)'
        ]
      }

      selectedLanguageIdentifierChanged(selectedLanguageIdentifier) {
        if (!selectedLanguageIdentifier) return;
        // PATCH-START for PolymerFx#FxDialogBehavior
        this.delay(0, () => {
          if (selectedLanguageIdentifier === 'bn-bd') {
            this.elem('#generic-modal-input [dialog-dismiss]').innerHTML = "বাতিল";
            this.elem('#generic-modal-input [dialog-confirm]').innerHTML = "ঠিক আছে";
            this.elem('#generic-modal-dialog [dialog-confirm]').innerHTML = "ঠিক আছে";
            this.elem('#generic-modal-confirmation [dialog-dismiss]').innerHTML = "বাতিল";
            this.elem('#generic-modal-confirmation [dialog-confirm]').innerHTML = "ঠিক আছে";
          } else {
            this.elem('#generic-modal-input [dialog-dismiss]').innerHTML = "Cancel";
            this.elem('#generic-modal-input [dialog-confirm]').innerHTML = "Okay";
            this.elem('#generic-modal-dialog [dialog-confirm]').innerHTML = "Okay";
            this.elem('#generic-modal-confirmation [dialog-dismiss]').innerHTML = "Cancel";
            this.elem('#generic-modal-confirmation [dialog-confirm]').innerHTML = "Okay";
          }
        });
        // PATCH-END
      }

      constructor() {
        super();
        this._initializeDatabase();
        this._fillDatabase();
        this._setUpDatabaseObservers();
        this._intializeServiceManager();
        this._manageProductionVariables();
        this.useLanguageServices();
        this.initiateLanguageServices();
        this.pushPageTitle(this.brandName);
        this._notifyResizeHack();
        this.delay(5000, () => this._assertApiKey());
      }

      _assertApiKey() {
        if ('user' in this && this.user && 'apiKey' in this.user) {
          this.callUserAssertApiKeyApi({}, (err, response) => {
            if (err) return;
            if (response.hasError) return this.logoutTapped();
            let { apiKey, warning, sessionId, user } = response;
            Object.assign(user, { apiKey, warning, sessionId });
            this.saveUser(user);
          });
        }
        this.delay(30000, () => this._assertApiKey());
      }

      _notifyResizeHack() {
        // TODO: Find a better way of handling this issue.
        // [0, 100, 250, 500, 1000].forEach(timeout => {
        //   this.delay(timeout, () => this.elem('app-header-layout').notifyResize());
        // });
        let timeoutList = [0, 100, 250, 500, 1000];
        let counter = 10;
        const fn = () => {
          try {
            this.elem('app-header-layout').notifyResize();
          } catch (ex) {
            'pass';
          }
          if (!(counter--)) return; // Comment out in case the back button issue persists.
          let timeout = (timeoutList.length > 1) ? timeoutList.shift() : timeoutList[0];
          this.delay(timeout, fn);
        }
        fn();
      }

      _manageProductionVariables() {
        if (mode === 'production') {
          this.serverHost = 'https://server.lipi.live'
          this.jsonPostApiPathPrefix = 'https://server.lipi.live/api/';
          this.websocketHost = 'wss://socket.lipi.live';
        } else {
          this.serverHost = 'http://localhost:8540'
          this.jsonPostApiPathPrefix = 'http://localhost:8540/api/';
          this.websocketHost = 'ws://localhost:8410';
        }
      }

      _initializeDatabase() {
        this.db = new atomicdb.Atomicdb({
          name: 'torqueMain',
          storageEngine: localStorage,
          serializationEngine: JSON,
          uniqueKey: 'idOnClient'
        });
        this.db.initializeDatabase();
        this.db.defineCollection({
          name: 'settings'
        });
        this.db.defineCollection({
          name: 'user'
        });
        this.db.defineCollection({
          name: 'organization'
        });
      }

      _fillDatabase() {
        this.db.upsert('settings', (({ which }) => which === 'only'), (doc => doc), {
          which: 'only',
          shouldUseWebsockets: true,
          monetaryUnit: 'BDT'
        });
      }

      _setUpDatabaseObservers() {
        this.db.observe('user', (...args) => this.onUserChange(...args));
        this.db.observe('organization', (...args) => this.onOrganizationChange(...args));
        this.db.observe('settings', (...args) => this.onSettingsChange(...args));
        this.onUserChange();
        this.onOrganizationChange();
        this.onSettingsChange();
      }

      _intializeServiceManager() {
        this.serviceManager.on('service-change', (event) => {
          this.activeServiceCount = event.detail.activeCount;
        });
        this.serviceManager.on('error', (event) => {
          try {
            if (event.path[0].url.indexOf('user-assert-api-key') > -1) return;
            this.showModalDialog("Network error", "Make sure you are connected to the internet and try again");
          } catch (ex) {
            this.showModalDialog("Network error", "Make sure you are connected to the internet and try again");
          }
        });
        this.serviceManager.on('success', (event) => {
          'pass'
        });
        (window.torqueWebsocketIndicatorStatusReceivedFn = (status) => {
          if (!window.torqueMasterOptions.allowWebsockets || !this.settings.shouldUseWebsockets) {
            this.websocketConnectivityIndicatorIconName = 'http';
            return;
          }
          if (status === 'connected') {
            this.websocketConnectivityIndicatorIconName = 'cloud';
          } else if (status === 'error') {
            this.websocketConnectivityIndicatorIconName = 'error';
          } else if (status === 'closed') {
            this.websocketConnectivityIndicatorIconName = 'cloud-queue';
          } else if (status === 'success') {
            this.websocketConnectivityIndicatorIconName = 'cloud-done';
          } else if (status === 'failure') {
            this.websocketConnectivityIndicatorIconName = 'cloud-off';
          } else {
            this.websocketConnectivityIndicatorIconName = 'gif';
          }
        })('closed');
      }

      showToast(message, cbfn) {
        let el = this.elem('#generic-toast');
        el.text = message;
        el.open();
        this.delay(0, cbfn);
      }

      // ====================== navigation =============================

      _pageNameChanged() {
        let qualifiedName = 'page-' + this.pageName + '.html';
        let matchingEl = Array.from(localDocument.querySelectorAll('link[rel="lazy-import"]')).find(el => {
          return el.href.indexOf(qualifiedName) > -1;
        });
        if (matchingEl) {
          qualifiedName = matchingEl.href;
        }
        var resolvedPageUrl = this.resolveUrl(qualifiedName);
        const successFn = (...args) => {
          'pass'
        }
        const failureFn = (...args) => {
          if (mode === 'development') {
            console.log(`STATIC_ERROR/url=${resolvedPageUrl}`);
          }
          this.pageName = 'error404';
          // NOTE: At this point, there is no guarantee that any language *.json file has been loaded.
          // So, translation has to be manual.
          if (this.selectedLanguageIdentifier === 'bn-bd') {
            this.showAlertMessage("দুঃখিত!", "আপনার ইন্টারনেট সংযোগ বিচ্ছিন্ন হয়ে আছে।");
          } else {
            this.showAlertMessage("Sorry!", "Unable to connect to the internet.");
          }
        }
        Polymer.importHref(resolvedPageUrl, successFn, failureFn, true);
      }

      mainIronPagesIronSelected(e, details) {
        if (e.target.nodeName !== 'IRON-PAGES') return;
        if (!details.item) return;
        this._notifyPageSelect(details.item);
      }

      refreshCurrentPage() {
        this.activePageElement.onNavigateOut();
        this.activePageElement.onNavigateIn();
      }

      // ======================  events =============================

      websocketConnectivityIndicatorIconTapped(e = null) {
        this.settings.shouldUseWebsockets = !this.settings.shouldUseWebsockets;
        window.torqueWebsocketIndicatorStatusReceivedFn('closed');
      }

      logoutTapped(e = null) {
        this.callUserLogoutApi({}, (err, response) => {
          this.removeUser();
          this.navigateTo('/login');
        })
      }

      languageIconTapped(e) {
        let languageIdentifier = e.target.getAttribute('data-key');
        this.delay(0, () => {
          if (this.getLastLoadedLanguage() === languageIdentifier) return;
          this.initiateLanguageServices(languageIdentifier);
        });
      }

      // ====================== delegated events =============================

      backButtonOnTopBarPressed(e) {
        if (this._proxyToActivePage('backButtonOnTopBarPressed', e)) return;
        this.navigateToPreviousUrl('/home');
      }

      saveButtonOnTopBarPressed(e) {
        this._proxyToActivePage('saveButtonOnTopBarPressed', e);
      }

      printButtonOnTopBarPressed(e) {
        this._proxyToActivePage('printButtonOnTopBarPressed', e);
      }

      // ====================== delegated callbacks =============================

      onUserChange() {
        this.user = this.loadUser();
        this._proxyToActivePage('onUserChange', this.user);
      }

      onSettingsChange() {
        this.settings = this.loadSettings();
        this._proxyToActivePage('onSettingsChange', this.settings);
      }

      onOrganizationChange() {
        this.organization = this.loadOrganization();
        this._proxyToActivePage('onOrganizationChange', this.organization);
      }

      // ====================== shortcuts =============================

      homeTapped(e = null) {
        this.navigateTo('/home');
      }

      reloadTapped(e = null) {
        window.location.reload();
      }

      switchOrganizationTapped(e = null) {
        this.navigateTo('/manage-organizations')
      }

      // ====================== sessionStorage =============================

      storeInSession(key, value) {
        window.sessionStorage.setItem(key, JSON.stringify(value));
      }

      getFromSession(key) {
        let value = window.sessionStorage.getItem(key);
        return JSON.parse(value);
      }

      extractFromSession(key) {
        let value = window.sessionStorage.getItem(key);
        if (value) {
          window.sessionStorage.removeItem(key);
        }
        return JSON.parse(value);
      }

      // ====================== utilities =============================

      showAlertMessage(...args) {
        this.showModalDialog.apply(this, args);
      }

      $invisibleUnless(condition) {
        if (!condition) {
          return 'visibility:hidden; '
        } else {
          return '';
        }
      }

      _proxyToActivePage(methodName, ...args) {
        if (this.activePageElement && (methodName in this.activePageElement)) {
          this.activePageElement[methodName](...args);
          return true;
        }
        return false;
      }

      $getLanguageClass(selectedLanguageIdentifier, languageIdentifier) {
        if (selectedLanguageIdentifier === languageIdentifier) {
          return 'language-active';
        }
        return '';
      }

      buildNumberTapped(e = null) {
        this.showAlertMessage("Build Details", "Released on: " + new Date(this.__deploy.datetimeStamp));
      }

      $computePageTitleFontSize(length) {
        let title = this.$getPageTitle(length) || "Lipi";
        let size = 20;
        let windowWidth = window.document.body.clientWidth;
        if (windowWidth <= 496) {
          if (title.length < 20) size = 20;
          else if (title.length < 30) size = 14;
          else size = 12;
        }
        return `font-size: ${size}px`;
      }

    }

    window.customElements.define(TorqueApp.is, TorqueApp);
  </script>
</dom-module>