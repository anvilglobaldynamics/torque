<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/neon-animation/web-animations.html">

<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../bower_components/atomicdb/atomicdb.html">

<script src="../bower_components/chart.js/dist/Chart.bundle.min.js"></script>

<link rel="import" href="../bower_components/polymer-fx/fx-app.html">
<link rel="import" href="../bower_components/polymer-fx/fx-dialog-behavior.html">
<link rel="import" href="../bower_components/polymer-fx/fx-common-behavior.html">
<link rel="import" href="../bower_components/polymer-fx/fx-page-manager-behavior.html">

<link rel="import" href="torque-db-behavior.html">
<link rel="import" href="torque-http-behavior.html">
<link rel="import" href="torque-language-behavior.html">
<link rel="import" href="torque-common-behavior.html">

<link rel="import" href="elem-not-ready.html">

<script src="xdate.js"></script>

<!-- NOTE: csv.min.js has been heavily customized manually after copying -->
<script src="csv.min.js"></script>

<script src="torque-utils.js"></script>

<link rel="lazy-import" href="page-home.html">
<link rel="lazy-import" href="page-help.html">
<link rel="lazy-import" href="page-payment.html">
<link rel="lazy-import" href="page-settings.html">
<link rel="lazy-import" href="page-error404.html">
<link rel="lazy-import" href="page-error403.html">
<link rel="lazy-import" href="page-about.html">
<link rel="lazy-import" href="page-login.html">
<link rel="lazy-import" href="page-verify.html">
<link rel="lazy-import" href="page-confirm-password-reset.html">
<link rel="lazy-import" href="page-register.html">
<link rel="lazy-import" href="page-toc.html">
<link rel="lazy-import" href="page-edit-profile.html">
<link rel="lazy-import" href="page-add-organization.html">
<link rel="lazy-import" href="page-edit-organization.html">
<link rel="lazy-import" href="page-manage-organizations.html">
<link rel="lazy-import" href="page-manage-employees.html">
<link rel="lazy-import" href="page-add-employee.html">
<link rel="lazy-import" href="page-view-employee.html">
<link rel="lazy-import" href="page-edit-employee.html">
<link rel="lazy-import" href="page-hire-employee.html">

<link rel="lazy-import" href="page-manage-inventories.html">
<link rel="lazy-import" href="page-manage-outlets.html">
<link rel="lazy-import" href="page-edit-outlet.html">
<link rel="lazy-import" href="page-view-outlet.html">
<link rel="lazy-import" href="page-manage-warehouses.html">
<link rel="lazy-import" href="page-edit-warehouse.html">
<link rel="lazy-import" href="page-view-warehouse.html">
<link rel="lazy-import" href="page-manage-product-blueprints.html">
<link rel="lazy-import" href="page-edit-product-blueprint.html">

<link rel="lazy-import" href="page-manage-vendors.html">
<link rel="lazy-import" href="page-edit-vendor.html">

<link rel="lazy-import" href="page-manage-service-blueprints.html">
<link rel="lazy-import" href="page-edit-service-blueprint.html">
<link rel="lazy-import" href="page-manage-outlet-services.html">

<link rel="lazy-import" href="page-view-inventory.html">
<link rel="lazy-import" href="page-transfer-products.html">
<link rel="lazy-import" href="page-add-products.html">
<link rel="lazy-import" href="page-manage-customers.html">
<link rel="lazy-import" href="page-view-customer.html">
<link rel="lazy-import" href="page-edit-customer.html">
<link rel="lazy-import" href="page-withdraw-from-change-wallet-balance.html">
<link rel="lazy-import" href="page-pos.html">
<link rel="lazy-import" href="page-print-sales-receipt.html">
<link rel="lazy-import" href="page-report-sales.html">
<link rel="lazy-import" href="page-report-collections.html">
<link rel="lazy-import" href="page-report-inventories.html">
<link rel="lazy-import" href="page-report-product-sales.html">
<link rel="lazy-import" href="page-manage-product-transfers.html">
<link rel="lazy-import" href="page-view-product-transfer.html">
<link rel="lazy-import" href="page-manage-product-acquisitions.html">
<link rel="lazy-import" href="page-view-product-acquisition.html">
<link rel="lazy-import" href="page-report-select-inventories.html">
<link rel="lazy-import" href="page-pos-select-products.html">
<link rel="lazy-import" href="page-pos-assign-employee-service.html">
<link rel="lazy-import" href="page-pos-assign-assisted-by-employee.html">
<link rel="lazy-import" href="page-pos-select-services.html">
<link rel="lazy-import" href="page-manage-sales.html">
<link rel="lazy-import" href="page-view-sales.html">
<link rel="lazy-import" href="page-manage-sales-return.html">
<link rel="lazy-import" href="page-edit-sales-return.html">
<link rel="lazy-import" href="page-manage-service-membership.html">
<link rel="lazy-import" href="page-view-sales-return.html">
<link rel="lazy-import" href="page-bulk-import-product-blueprints.html">
<link rel="lazy-import" href="page-select-geolocation.html">
<link rel="lazy-import" href="page-scan-identifier-code.html">
<link rel="lazy-import" href="page-manage-discount-presets.html">
<link rel="lazy-import" href="page-edit-discount-preset.html">
<link rel="lazy-import" href="page-manage-payment-methods.html">
<link rel="lazy-import" href="page-edit-payment-method.html">
<link rel="lazy-import" href="page-graph-sales.html">
<link rel="lazy-import" href="page-print-product-transfer.html">
<link rel="lazy-import" href="page-print-product-acquisition.html">

<link rel="lazy-import" href="page-manage-product-categories.html">
<link rel="lazy-import" href="page-edit-product-category.html">

<link rel="lazy-import" href="page-manage-transactions.html">
<link rel="lazy-import" href="page-accounting-reports.html">
<link rel="lazy-import" href="page-manage-monetary-accounts.html">
<link rel="lazy-import" href="page-manage-accounts.html">
<link rel="lazy-import" href="page-edit-account.html">
<link rel="lazy-import" href="page-edit-manual-transaction.html">
<link rel="lazy-import" href="page-edit-usual-transaction.html">
<link rel="lazy-import" href="page-view-transaction-list.html">
<link rel="lazy-import" href="page-view-account-ledger.html">
<link rel="lazy-import" href="page-report-income-statement.html">
<link rel="lazy-import" href="page-report-balance-sheet.html">
<link rel="lazy-import" href="page-report-trial-balance.html">
<link rel="lazy-import" href="page-report-chart-of-accounts.html">

<link rel="lazy-import" href="page-report-select-product-blueprints.html">
<link rel="lazy-import" href="page-report-select-product-categories.html">

<link rel="import" href="shared-icons.html">
<link rel="import" href="shared-styles.html">

<dom-module id="torque-app">
  <template>
    <style include="shared-styles">
      /* ============= variables ============= */

      :host {
        --app-primary-color: #009688;
        --app-primary-color-dark: #004D40;
        --app-primary-color-light: #B2DFDB;
        /* --app-primary-color-light: #c0e9e5; */
        --app-primary-text-color: #ffffff;
        --app-text: #000000;
        --app-text-light: #424242;
        --app-text-lighter: #757575;
        --app-text-invert: #ffffff;

        --app-button-primary: #009688;
        --app-button-label-primary: #FFFFFF;
        --app-button-secondary: #B2DFDB;
        --app-button-label-secondary: #00695C;
        --app-button-danger: #ffcdd2;
        --app-button-label-danger: #c62828;
        --app-button-neutral: #CFD8DC;
        --app-button-label-neutral: #263238;
        --app-button-alternative: #fdff6f;
        --app-button-label-alternative: #067e24;

        --app-tab-selected: #0091ea;
        --app-tab-label-selected: #e1f5fe;
        --app-tab-unselected: #e1f5fe;
        --app-tab-label-unselected: #000000;

        display: block;
      }

      /* ============= styles ============= */

      @media print {

        app-drawer,
        app-header,
        .footer {
          display: none;
        }
      }

      /* 
      NOTE: Uncomment to apply custom scrollbars
      ::-webkit-scrollbar {
        width: 10px;
      }

      ::-webkit-scrollbar-track {
        background: #ddd;
      }

      ::-webkit-scrollbar-thumb {
        background: #757575;
      } 
      */

      /* ============= styles ============= */

      app-drawer-layout:not([narrow]) [drawer-toggle] {
        display: none;
      }

      app-header {
        color: var(--app-primary-text-color);
        background-color: var(--app-primary-color);
      }

      app-header paper-icon-button {
        --paper-icon-button-ink-color: var(--app-primary-text-color);
      }

      .custom-drawer-list {
        margin: 20px 0;
        padding-bottom: 40px;
        display: block;
      }

      .logout-link,
      .custom-drawer-list a {
        display: block;
        padding: 2px 16px;
        text-decoration: none;
        color: #dedede;
        line-height: 40px;
      }

      .custom-drawer-list a.iron-selected {
        color: var(--app-primary-color-light);
        font-weight: bold;
      }

      .footer {
        margin-top: 36px;
        margin-bottom: 36px;
        text-align: center;
        color: var(--app-text-lighter);
        line-height: 100%;
      }

      .top-nav-spinner-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.438);
        z-index: 9999999;
      }

      .top-nav-spinner {
        width: 120px;
        height: 120px;
        position: fixed;
        top: calc(50vh - 60px);
        left: calc(50vw - 60px);
        z-index: 99999999;
        --paper-spinner-stroke-width: 12px;
        --paper-spinner-color: #009688;
      }

      .footer-login {
        margin-top: 8px;
      }

      .language-area {
        width: 100%;
      }

      .language-block {
        cursor: pointer;
        margin-left: 4px;
        margin-right: 4px;
      }

      .language-active {
        border-bottom: 2px solid #009688;
      }

      .language-icon {}

      .language-name {
        font-size: 14px;
      }

      /* ---- expansion ---- */
      @keyframes rotate-forward {
        from {
          transform: rotate(0deg);
        }

        to {
          transform: rotate(90deg);
        }
      }

      @keyframes rotate-back {
        from {
          transform: rotate(90deg);
        }

        to {
          transform: rotate(0deg);
        }
      }

      .rotate-f {
        animation: rotate-forward 0.5s;
        animation-fill-mode: forwards;
      }

      .rotate-b {
        animation: rotate-back 0.5s;
        animation-fill-mode: forwards;
      }

      .expansion-icon-collapsed {}

      .expansion-title {
        color: #dedede;
        cursor: pointer;
        margin-left: 8px;
      }

      .expansion-content-collapsed {
        display: none;
      }

      .expansion-content {
        margin-left: 20px;
        margin-top: 8px;
      }

      /* ---- expansion ---- */

      .custom-app-drawer-wrapper {
        display: block;
        /* height: 100vh; */
        /* overflow-y: auto; */
        background-color: rgb(255, 255, 255);
        min-width: 280px;
        z-index: 99;
      }

      .custom-app-drawer {
        display: block;
        height: calc(100vh - 64px);
        overflow-y: scroll;
        background-color: #262838;
        min-width: 280px;
        max-width: 280px;
        z-index: 99;
      }

      .sidebar-title {
        /* border: 1px solid greenyellow; */
      }

      .custom-sidebar-logo-image {
        padding-top: 30px;
        height: 60px;
        width: 60px;
      }

      .active-user {
        color: #e1f5fe;
        font-size: 13px;
        margin-top: 10px;
        padding-top: 14px;
        padding-right: 4px;
        padding-left: 20px;
        cursor: pointer;
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-decoration: none;
      }

      .sidebar-padded-divider {
        margin-top: 20px;
      }

      .custom-sidebar-divider {
        border: 0;
        height: 0;
        border-top: 1px solid rgba(0, 0, 0, 0.2);
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
      }

      #top-nav-hamburger {
        display: none;
      }

      .main-iron-pages-wrapper {
        max-height: calc(100vh - 64px);
        overflow-y: auto;
      }

      @media (max-width: 960px) {
        .custom-app-drawer-wrapper {
          animation-duration: 0.3s;
          animation-name: slidein;
          display: block;
          position: fixed;
          left: 0px;
          width: calc(100vh + 40px);
          overflow-x: hidden;
          background: #00000059;
        }

        #top-nav-hamburger {
          display: inline-flex;
        }
      }

      @media print {
        .custom-app-drawer-wrapper {
          display: none;
        }

        .main-iron-pages-wrapper {
          padding-top: 20px;
          max-height: none;
          /* overflow-y: auto; */
        }

        app-header {
          display: none;
        }
      }

      @keyframes slidein {
        from {
          margin-left: -100%;
          width: 300%;
        }

        to {
          margin-left: 0%;
          width: 100%;
        }
      }

      .top-right-dropdown {
        background-color: var(--app-primary-color-light);
      }

      #inventory-container-dialog .list {
        max-height: 240px;
        overflow: auto;
        margin-bottom: 8px;
        margin-top: 8px;
      }

      .popup-list {
        /* border: 1px red solid; */
      }

      .popup-list .item {
        /* border: 1px blue solid; */
        font-size: 16px;
        cursor: pointer;
        color: var(--app-button-label-secondary);
        background-color: var(--app-button-secondary);
        padding-top: 12px;
        padding-bottom: 12px;
        padding-left: 16px;
        padding-right: 16px;
        margin-bottom: 10px;
      }

      #receipt-dialog h2 {
        min-width: 200px;
      }

      .receipt-dialog-button {
        margin: 8px;
        margin-left: 24px;
        margin-right: 24px;

        /* max-width: 400px; */
      }

      .navbar-logo-image {
        display: inline-block;
        margin-left: auto;
        margin-right: auto;
        height: 60px;
        width: 60px;
        margin-top: 4px;
      }

    </style>

    <app-drawer-layout responsive-width="4000px" fullbleed narrow="{{narrow}}">

      <template is="dom-if" if="[[$and(activeServiceCount, topSpinnerEnabled)]]">
        <div class="top-nav-spinner-container">
          <paper-spinner-lite active="" class="top-nav-spinner"></paper-spinner-lite>
        </div>
      </template>

      <!-- Main content -->
      <app-header-layout has-scrolling-region>

        <app-header slot="header" style$="[[$invisibleUnless(user)]]" fixed>
          <app-toolbar>
            <template is="dom-if" if="[[!currentPageIsModal]]">
              <paper-icon-button id="top-nav-hamburger" icon="shared-icons:menu" on-tap="topNavHamburgerTapped"></paper-icon-button>
            </template>
            <template is="dom-if" if="[[$and(currentPageIsModal,currentPageAllowsBackButton)]]">
              <paper-icon-button icon="arrow-back" on-click="backButtonOnTopBarPressed"></paper-icon-button>
            </template>

            <div main-title class="flex vertical layout" style="text-align: center;">
              <template is="dom-if" if="[[$equals(pageName, 'home')]]">
                <img class="navbar-logo-image" src="../images/logo-on-titlebar-slightly-different-color.png">
              </template>
              <template is="dom-if" if="[[!$equals(pageName, 'home')]]">
                <div style$="[[$computePageTitleFontSize(pageTitleList.length)]]">[[$getPageTitle(pageTitleList.length)]]</div>
              </template>
            </div>

            <template is="dom-if" if="[[shouldShowPrintButton]]">
              <paper-icon-button icon="print" on-click="printButtonOnTopBarPressed"></paper-icon-button>
            </template>

            <paper-menu-button horizontal-align="right" style="padding: 0px;">
              <paper-icon-button icon="icons:apps" slot="dropdown-trigger"></paper-icon-button>
              <paper-listbox slot="dropdown-content" selected="-1" class="top-right-dropdown">

                <paper-item on-tap="homeTapped" hidden="[[isInOfflineMode]]">[[verses.topMenu.home]]</paper-item>
                <paper-item on-tap="switchOrganizationTapped" hidden="[[isInOfflineMode]]">[[verses.topMenu.switchOrganization]]</paper-item>

                <paper-item on-tap="profileTapped" hidden="[[isInOfflineMode]]">[[verses.sidebar.profile]]</paper-item>
                <paper-item on-tap="settingsTapped" hidden="[[isInOfflineMode]]">[[verses.sidebar.settings]]</paper-item>

                <div class="sidebar-padded-divider"></div>

                <paper-item on-tap="reloadTapped">[[verses.topMenu.reload]]</paper-item>
                <!-- FIXME: Remove offline toggle switch after testing -->
                <!-- <paper-item on-tap="toggleOfflineMode">Toggle Offline Mode (Debug Only)</paper-item> -->
                <paper-item on-tap="logoutTapped">[[verses.topMenu.logout]]</paper-item>

              </paper-listbox>
            </paper-menu-button>
            <template is="dom-if" if="[[shouldShowSaveButton]]">
              <paper-icon-button icon="save" on-click="saveButtonOnTopBarPressed"></paper-icon-button>
            </template>
          </app-toolbar>
        </app-header>

        <div class="horizontal layout">
          <!-- Drawer content - start -->
          <div class="custom-app-drawer-wrapper" on-tap="customAppDrawerWrapperTapped" style$="[[customAppDrawerStyle(user, organization, isFloatingAppDrawerExpanded, innerWidth, isInOfflineMode)]]">
            <div class="custom-app-drawer" on-tap="customAppDrawerTapped">
              <app-toolbar class="sidebar-title">
                <img class="custom-sidebar-logo-image" src="../images/logo.png">
                <div class="flex"></div>
                <a class="active-user" href="#/edit-profile">[[user.fullName]]</a>
              </app-toolbar>
              <iron-selector selected="[[pageNameForNavigationMenu]]" attr-for-selected="name" class="custom-drawer-list" role="navigation">

                <a name="home" href="#/home">[[verses.sidebar.home]]</a>
                <a name="help" href="#/help">[[verses.sidebar.help]]</a>
                <hr class="custom-sidebar-divider">

                <template is="dom-if" if="[[hasModuleWithOrganization(organization, 'MOD_PRODUCT')]]">
                  <a name="manage-product-blueprints" href="#/manage-product-blueprints">[[verses.sidebar.productBlueprints]]</a>
                </template>
                <template is="dom-if" if="[[hasModuleWithOrganization(organization, 'MOD_SERVICE')]]">
                  <template is="dom-if" if="[[!hasModuleWithOrganization(organization, 'MOD_RESTAURANT')]]">
                    <a name="manage-service-blueprints" href="#/manage-service-blueprints">[[verses.sidebar.serviceBlueprints]]</a>
                  </template>
                </template>

                <a name="manage-inventories" href="#/manage-inventories">[[verses.sidebar.inventoryContainer]]</a>

                <!-- Essential Records - start -->
                <a name="manage-sales" href="#/manage-sales">[[verses.sidebar.sales]]</a>

                <template is="dom-if" if="[[hasModuleWithOrganization(organization, 'MOD_PRODUCT')]]">
                  <template is="dom-if" if="[[!hasModuleWithOrganization(organization, 'MOD_RESTAURANT')]]">
                    <a name="report-inventories" href="#/report-inventories">[[verses.sidebar.inventoryReport]]</a>
                  </template>
                </template>

                <template is="dom-if" if="[[hasModuleWithOrganization(organization, 'MOD_SERVICE')]]">
                  <template is="dom-if" if="[[!hasModuleWithOrganization(organization, 'MOD_RESTAURANT')]]">
                    <a name="manage-service-membership" href="#/manage-service-membership">[[verses.sidebar.serviceMembership]]</a>
                  </template>
                </template>
                <!-- Essential Records - end -->

                <div class="sidebar-padded-divider"></div>

                <!-- People - start -->
                <div class="expansion-title" on-click="expansionTitleTapped" data-key="people">
                  <iron-icon class="expansion-icon-collapsed" icon="chevron-right"></iron-icon>
                  [[verses.sidebar.people]]
                </div>
                <div class$="expansion-content [[$getExpansionContentClass(expansionStatus.people)]]">
                  <a name="manage-customers" href="#/manage-customers">[[verses.sidebar.customers]]</a>
                  <a name="manage-employees" href="#/manage-employees">[[verses.sidebar.employees]]</a>
                  <template is="dom-if" if="[[hasModuleWithOrganization(organization, 'MOD_VENDOR')]]">
                    <template is="dom-if" if="[[!hasModuleWithOrganization(organization, 'MOD_RESTAURANT')]]">
                      <a name="manage-vendors" href="#/manage-vendors">[[verses.sidebar.vendors]]</a>
                    </template>
                  </template>
                </div>
                <!-- People - end -->

                <div class="sidebar-padded-divider"></div>

                <!-- Presets - start -->
                <div class="expansion-title" on-click="expansionTitleTapped" data-key="presets">
                  <iron-icon class="expansion-icon-collapsed" icon="chevron-right"></iron-icon>
                  [[verses.sidebar.presets]]
                </div>
                <div class$="expansion-content [[$getExpansionContentClass(expansionStatus.presets)]]">
                  <a name="manage-discount-presets" href="#/manage-discount-presets">[[verses.sidebar.manageDiscountPresets]]</a>
                  <a name="manage-payment-methods" href="#/manage-payment-methods">[[verses.sidebar.managePaymentMethods]]</a>
                  <template is="dom-if" if="[[hasModuleWithOrganization(organization, 'MOD_PRODUCT')]]">
                    <a name="manage-product-categories" href="#/manage-product-categories">[[verses.sidebar.manageProductCategories]]</a>
                  </template>
                </div>
                <!-- Presets - end -->

                <div class="sidebar-padded-divider"></div>

                <!-- Reports - start -->
                <div class="expansion-title" on-click="expansionTitleTapped" data-key="reportsAndGraphs">
                  <iron-icon class="expansion-icon-collapsed" icon="chevron-right"></iron-icon>
                  [[verses.sidebar.reportsAndGraphs]]
                </div>
                <div class$="expansion-content [[$getExpansionContentClass(expansionStatus.reportsAndGraphs)]]">
                  <a name="graph-sales" href="#/graph-sales">[[verses.sidebar.salesGraph]]</a>
                  <a name="report-sales" href="#/report-sales">[[verses.sidebar.salesReport]]</a>
                  <a name="report-collections" href="#/report-collections">[[verses.sidebar.collectionReport]]</a>
                  <template is="dom-if" if="[[hasModuleWithOrganization(organization, 'MOD_PRODUCT')]]">
                    <a name="report-product-sales" href="#/report-product-sales">[[verses.sidebar.productSalesReport]]</a>
                  </template>
                </div>
                <!-- Reports - end -->

                <div class="sidebar-padded-divider"></div>

                <!-- Records - start -->
                <template is="dom-if" if="[[hasModuleWithOrganization(organization, 'MOD_PRODUCT')]]">
                  <div class="expansion-title" on-click="expansionTitleTapped" data-key="records">
                    <iron-icon class="expansion-icon-collapsed" icon="chevron-right"></iron-icon>
                    [[verses.sidebar.records]]
                  </div>
                  <div class$="expansion-content [[$getExpansionContentClass(expansionStatus.records)]]">
                    <template is="dom-if" if="[[hasModuleWithOrganization(organization, 'MOD_PRODUCT')]]">
                      <template is="dom-if" if="[[!hasModuleWithOrganization(organization, 'MOD_RESTAURANT')]]">
                        <a name="manage-product-acquisitions" href="#/manage-product-acquisitions">[[verses.sidebar.manageProductAcquisition]]</a>
                        <a name="manage-product-transfers" href="#/manage-product-transfers">[[verses.sidebar.manageProductTransfer]]</a>
                      </template>
                    </template>
                    <template is="dom-if" if="[[hasModuleWithOrganization(organization, 'MOD_PRODUCT')]]">
                      <a name="manage-sales-return" href="#/manage-sales-return">[[verses.sidebar.salesReturn]]</a>
                    </template>
                  </div>
                </template>
                <!-- Records - end -->

                <div class="sidebar-padded-divider"></div>

                <!-- Accounting section - start -->
                <template is="dom-if" if="[[hasModuleWithOrganization(organization, 'MOD_ACCOUNTING')]]">

                  <div class="expansion-title" on-click="expansionTitleTapped" data-key="accounting">
                    <iron-icon class="expansion-icon-collapsed" icon="chevron-right"></iron-icon>
                    [[verses.sidebar.accounting]]
                  </div>
                  <div class$="expansion-content [[$getExpansionContentClass(expansionStatus.accounting)]]">

                    <template is="dom-if" if="[[hasPrivilege('PRIV_MANAGE_ACCOUNTING', organization)]]">
                      <a name="manage-monetary-accounts" href="#/manage-monetary-accounts">[[verses.sidebar.manageMonetaryAccounts]]</a>
                      <a name="manage-accounts" href="#/manage-accounts">[[verses.sidebar.manageAccounts]]</a>
                      <a name="manage-transactions" href="#/manage-transactions">[[verses.sidebar.manageTransactions]]</a>
                    </template>

                    <template is="dom-if" if="[[hasPrivilege('PRIV_VIEW_ACCOUNTING_REPORTS', organization)]]">
                      <a name="accounts-payable" on-click="accountsPayableTapped" style="cursor: pointer;">[[verses.sidebar.accountsPayable]]</a>
                      <a name="accounts-receivable" on-click="accountsReceivableTapped" style="cursor: pointer;">[[verses.sidebar.accountsReceivable]]</a>
                      <a name="accounting-reports" href="#/accounting-reports">[[verses.sidebar.accountingReports]]</a>
                    </template>

                  </div>
                </template>
                <!-- Accounting section - end -->

                <div class="sidebar-padded-divider"></div>

                <a name="about" href="#/about">[[verses.sidebar.about]]</a>

                <div style="margin-bottom: 60px; height: 1px; width: 1px">
                </div>


              </iron-selector>
            </div>
          </div>
          <!-- Drawer content - end -->
          <div class="flex main-iron-pages-wrapper">
            <iron-pages on-iron-select="mainIronPagesIronSelected" id="main-iron-pages" selected="[[pageName]]" attr-for-selected="name" fallback-selection="error404" role="main">
              <page-home name="home"></page-home>
              <page-help name="help"></page-help>
              <page-payment name="payment"></page-payment>
              <page-settings name="settings"></page-settings>
              <page-error404 name="error404"></page-error404>
              <page-error403 name="error403"></page-error403>
              <page-about name="about"></page-about>
              <page-login name="login"></page-login>
              <page-verify name="verify"></page-verify>
              <page-confirm-password-reset name="confirm-password-reset"></page-confirm-password-reset>
              <page-register name="register"></page-register>
              <page-toc name="toc"></page-toc>
              <page-edit-profile name="edit-profile"></page-edit-profile>
              <page-add-organization name="add-organization"></page-add-organization>
              <page-edit-organization name="edit-organization"></page-edit-organization>
              <page-manage-organizations name="manage-organizations"></page-manage-organizations>
              <page-manage-employees name="manage-employees"></page-manage-employees>
              <page-add-employee name="add-employee"></page-add-employee>
              <page-view-employee name="view-employee"></page-view-employee>
              <page-edit-employee name="edit-employee"></page-edit-employee>
              <page-hire-employee name="hire-employee"></page-hire-employee>

              <page-manage-vendors name="manage-vendors"></page-manage-vendors>
              <page-edit-vendor name="edit-vendor"></page-edit-vendor>

              <page-manage-inventories name="manage-inventories"></page-manage-inventories>
              <page-manage-outlets name="manage-outlets"></page-manage-outlets>
              <page-edit-outlet name="edit-outlet"></page-edit-outlet>
              <page-view-outlet name="view-outlet"></page-view-outlet>
              <page-manage-warehouses name="manage-warehouses"></page-manage-warehouses>
              <page-view-warehouse name="view-warehouse"></page-view-warehouse>
              <page-edit-warehouse name="edit-warehouse"></page-edit-warehouse>

              <page-manage-product-blueprints name="manage-product-blueprints"></page-manage-product-blueprints>
              <page-edit-product-blueprint name="edit-product-blueprint"></page-edit-product-blueprint>
              <page-manage-service-blueprints name="manage-service-blueprints"></page-manage-service-blueprints>
              <page-edit-service-blueprint name="edit-service-blueprint"></page-edit-service-blueprint>
              <page-manage-outlet-services name="manage-outlet-services"></page-manage-outlet-services>
              <page-view-inventory name="view-inventory"></page-view-inventory>
              <page-transfer-products name="transfer-products"></page-transfer-products>
              <page-add-products name="add-products"></page-add-products>
              <page-manage-customers name="manage-customers"></page-manage-customers>
              <page-view-customer name="view-customer"></page-view-customer>
              <page-edit-customer name="edit-customer"></page-edit-customer>
              <page-manage-product-categories name="manage-product-categories"></page-manage-product-categories>
              <page-edit-product-category name="edit-product-category"></page-edit-product-category>
              <page-withdraw-from-change-wallet-balance name="withdraw-from-change-wallet-balance"></page-withdraw-from-change-wallet-balance>
              <page-pos name="pos"></page-pos>
              <page-report-sales name="report-sales"></page-report-sales>
              <page-report-collections name="report-collections"></page-report-collections>
              <page-report-inventories name="report-inventories"></page-report-inventories>
              <page-report-product-sales name="report-product-sales"></page-report-product-sales>
              <page-print-product-transfer name="print-product-transfer"></page-print-product-transfer>
              <page-print-product-acquisition name="print-product-acquisition"></page-print-product-acquisition>

              <page-manage-product-transfers name="manage-product-transfers"></page-manage-product-transfers>
              <page-view-product-transfer name="view-product-transfer"></page-view-product-transfer>
              <page-manage-product-acquisitions name="manage-product-acquisitions"></page-manage-product-acquisitions>
              <page-view-product-acquisition name="view-product-acquisition"></page-view-product-acquisition>

              <page-report-select-inventories name="report-select-inventories"></page-report-select-inventories>
              <page-pos-select-products name="pos-select-products"></page-pos-select-products>
              <page-pos-select-services name="pos-select-services"></page-pos-select-services>
              <page-pos-assign-employee-service name="pos-assign-employee-service"></page-pos-assign-employee-service>
              <page-pos-assign-assisted-by-employee name="pos-assign-assisted-by-employee"></page-pos-assign-assisted-by-employee>
              <page-manage-sales name="manage-sales"></page-manage-sales>
              <page-view-sales name="view-sales"></page-view-sales>
              <page-manage-sales-return name="manage-sales-return"></page-manage-sales-return>
              <page-edit-sales-return name="edit-sales-return"></page-edit-sales-return>
              <page-manage-service-membership name="manage-service-membership"></page-manage-service-membership>
              <page-view-sales-return name="view-sales-return"></page-view-sales-return>
              <page-print-sales-receipt name="print-sales-receipt"></page-print-sales-receipt>
              <page-bulk-import-product-blueprints name="bulk-import-product-blueprints"></page-bulk-import-product-blueprints>
              <page-select-geolocation name="select-geolocation"></page-select-geolocation>
              <page-scan-identifier-code name="scan-identifier-code"></page-scan-identifier-code>
              <page-manage-discount-presets name="manage-discount-presets"></page-manage-discount-presets>
              <page-edit-discount-preset name="edit-discount-preset"></page-edit-discount-preset>
              <page-manage-payment-methods name="manage-payment-methods"></page-manage-payment-methods>
              <page-edit-payment-method name="edit-payment-method"></page-edit-payment-method>
              <page-report-select-product-blueprints name="report-select-product-blueprints"></page-report-select-product-blueprints>
              <page-report-select-product-categories name="report-select-product-categories"></page-report-select-product-categories>
              <page-graph-sales name="graph-sales"></page-graph-sales>

              <page-manage-transactions name="manage-transactions"></page-manage-transactions>
              <page-accounting-reports name="accounting-reports"></page-accounting-reports>
              <page-manage-monetary-accounts name="manage-monetary-accounts"></page-manage-monetary-accounts>
              <page-manage-accounts name="manage-accounts"></page-manage-accounts>
              <page-edit-account name="edit-account"></page-edit-account>
              <page-edit-manual-transaction name="edit-manual-transaction"></page-edit-manual-transaction>
              <page-edit-usual-transaction name="edit-usual-transaction"></page-edit-usual-transaction>
              <page-view-transaction-list name="view-transaction-list"></page-view-transaction-list>
              <page-view-account-ledger name="view-account-ledger"></page-view-account-ledger>
              <page-report-income-statement name="report-income-statement"></page-report-income-statement>
              <page-report-balance-sheet name="report-balance-sheet"></page-report-balance-sheet>
              <page-report-trial-balance name="report-trial-balance"></page-report-trial-balance>
              <page-report-chart-of-accounts name="report-chart-of-accounts"></page-report-chart-of-accounts>
            </iron-pages>

            <div class$="footer footer-[[pageName]]">
              <div class="language-area horizontal layout center-center">
                <div class="language-block" data-key="en-us" on-tap="languageIconTapped">
                  <img src="../images/icons/en-us.png" data-key="en-us" class$="language-icon [[$getLanguageClass(selectedLanguageIdentifier, 'en-us')]]">
                  <div class="language-name" data-key="en-us" style="font-size: 13px !important;">EN</div>
                </div>
                <div class="language-block" data-key="bn-bd" on-tap="languageIconTapped">
                  <img src="../images/icons/bn-bd.png" data-key="bn-bd" class$="language-icon [[$getLanguageClass(selectedLanguageIdentifier, 'bn-bd')]]">
                  <div class="language-name" data-key="bn-bd">বাং</div>
                </div>
              </div>
              <br>
              <br>
              <div>&#xA9; 2017
                <a style="color: var(--app-primary-color-dark);" href="[[authorWebsite]]">[[authorName]]</a>
              </div>
              <div style="margin-top: 12px">[[verses.root.rightsReserved]]</div>
              <div>
                <span class="extra-small" on-click="buildNumberTapped">ver [[appVersion]]</span>
                <paper-icon-button icon="[[websocketConnectivityIndicatorIconName]]" on-tap="websocketConnectivityIndicatorIconTapped"></paper-icon-button>
                <span class="extra-small" on-click="buildNumberTapped">build
                  <span id="build-number">[[__deploy.build]]</span>
                </span>
              </div>
            </div>

          </div>
        </div>
        <!-- 
        <paper-dialog id="geolocation-dialog" modal style="z-index: -999999">
          <h2>[[verses.root.geolocationTitle]]</h2>

          <div>[[verses.root.geolocationLine1]]</div>

          <div>[[verses.root.geolocationLine2]]</div>

          <img class="geolocation-image" src="../images/location-prompt.jpg">

          <div class="buttons" style="margin: 14px;">
            <paper-button raised class="primary" on-click="geolocationDialogOkayTapped">[[verses.general.okay]]</paper-button>
          </div>
        </paper-dialog> -->

        <paper-dialog id="inventory-container-dialog" modal style="z-index: -999999">
          <template is="dom-if" if="[[_outletList.length]]">
            <h2>[[verses.general.outlets]]</h2>
            <div class="popup-list">
              <template is="dom-repeat" items="[[_outletList]]" as="outlet">
                <div class="item" on-click="inventoryContainerDialogSelectOutletTapped" style="min-width: 200px;">
                  [[outlet.name]]
                </div>
              </template>
            </div>
          </template>
          <template is="dom-if" if="[[_warehouseList.length]]">
            <h2 style="margin-top: 20px;">[[verses.general.warehouses]]</h2>
            <div class="popup-list">
              <template is="dom-repeat" items="[[_warehouseList]]" as="warehouse" style="min-width: 200px;">
                <div class="item" on-click="inventoryContainerDialogSelectWarehouseTapped">
                  [[warehouse.name]]
                </div>
              </template>
            </div>
          </template>
          <div class="buttons" style="margin: 14px;">
            <paper-button raised class="danger" on-click="inventoryContainerDialogCancelTapped">[[verses.general.cancel]]</paper-button>
          </div>
        </paper-dialog>

        <paper-dialog id="category-dialog" modal style="z-index: -999999">
          <h2>[[verses.productCategoryPicker.pickerTitle]]</h2>
          <paper-dialog-scrollable>
            <div style="overflow: auto; max-height: 300px !important; min-width: 200px; padding-left: 20px; padding-right: 20px;">
              <template is="dom-repeat" items="[[_productCategoryList]]" as="productCategory">
                <div on-click="categoryDialogSelectTapped" class="product-category-pillet" style$="background-color: #{{productCategory.colorCode}}; color: #{{$guessCategoryFontColorCode(productCategory.colorCode)}}; margin: 4px; border: none;">
                  [[productCategory.name]]
                </div>
              </template>
            </div>
          </paper-dialog-scrollable>
          <div class="buttons">
            <paper-button raised class="danger" on-click="categoryDialogCancelTapped">[[verses.general.cancel]]</paper-button>
          </div>
        </paper-dialog>

        <paper-dialog id="network-dialog" modal style="z-index: -999999">
          <h2>[[verses.root.networkErrorTitle]]</h2>
          <paper-dialog-scrollable>
            <div class="dialog-text">[[verses.root.networkErrorContent]]</div>
          </paper-dialog-scrollable>
          <div class="buttons">
            <template is="dom-if" if="[[!isInOfflineMode]]">
              <paper-button class="neutral" on-click="networkErrorGoToOfflineModeTapped">[[verses.root.networkErrorGoOffline]]</paper-button>
            </template>
            <paper-button class="secondary" on-click="networkErrorRetryTapped" autofocus>[[verses.root.networkErrorRetry]]</paper-button>
          </div>
        </paper-dialog>

        <paper-dialog id="receipt-dialog" modal style="z-index: -999999">
          <h2>[[verses.receipt.dialogTitle]]</h2>

          <iron-icon style="position: absolute; right: -12px; top: -10px;" icon="clear" on-click="receiptDialogCloseTapped"></iron-icon>

          <paper-dialog-scrollable>
            <div class="vertical layout">
              <template is="dom-if" if="[[_receiptDialogCanHaveEmailReceipt]]">
                <paper-button raised class="primary receipt-dialog-button" on-click="receiptDialogEmailReceiptTapped">[[verses.receipt.emailReceipt]]</paper-button>
              </template>
              <template is="dom-if" if="[[_receiptDialogCanHaveSmsReceipt]]">
                <paper-button raised class="primary receipt-dialog-button" on-click="receiptDialogSmsReceiptTapped">[[verses.receipt.smsReceipt]]</paper-button>
              </template>
              <paper-button raised class="primary receipt-dialog-button" on-click="receiptDialogPrintReceiptTapped">[[verses.receipt.printReceipt]]</paper-button>
              <paper-button raised class="danger receipt-dialog-button" on-click="receiptDialogNoReceiptTapped">[[verses.receipt.noReceipt]]</paper-button>
            </div>
          </paper-dialog-scrollable>

        </paper-dialog>

      </app-header-layout>
    </app-drawer-layout>
    <paper-toast id="generic-toast" text="Done"></paper-toast>
    <div class="super-class-insertion-point"></div>
  </template>

  <script>
    let localDocument = document.currentScript.ownerDocument;
    const backgroundSyncInitialDelay = 20 * 1000;
    const backgroundSyncInterval = 5 * 60 * 1000;

    class TorqueApp extends FxApp.mixin(FxCommonBehavior, FxPageManagerBehavior, FxDialogBehavior, TorqueDbBehavior, TorqueHttpBehavior, TorqueLanguageBehavior, TorqueCommonBehavior) {

      static get is() {
        return 'torque-app';
      }

      static get properties() {
        return {
          __deploy: {
            type: Object,
            value: () => {
              '%__deploy-start'
              return JSON.parse('{"build":362,"datetimeStamp":1595411542457}');
              '%__deploy-end'
            }
          },
          appVersion: {
            type: String,
            value: '1.0.0'
          },
          definitionRevisionVersion: {
            type: Number,
            value: 1
          },
          brandName: {
            type: String,
            value: 'Lipi'
          },
          authorName: {
            type: String,
            value: 'Anvil Global Dynamics Ltd.'
          },
          authorWebsite: {
            type: String,
            value: 'https://anvil.live'
          },
          currentPageIsModal: {
            type: Boolean,
            value: false
          },
          currentPageAllowsBackButton: {
            type: Boolean,
            value: true
          },
          activeServiceCount: {
            type: Number,
            value: 0
          },
          topSpinnerEnabled: {
            type: Boolean,
            value: true
          },
          shouldShowPrintButton: {
            type: Boolean,
            value: false
          },
          websocketConnectivityIndicatorIconName: {
            type: String,
            value: 'cloud-queue'
          },
          tocVersionUpdatedDatetimeStamp: {
            type: Number,
            value: 1542184791941
          },
          networkErrorDialog: {
            type: Object,
            value: () => ({
              title: 'No Title',
              label: 'No message'
            })
          },
          shouldAttempBackgroundSync: {
            type: Boolean,
            value: false
          },
          isInOfflineMode: {
            type: Boolean,
            value: false
          },
          isFloatingAppDrawerExpanded: {
            type: Boolean,
            value: false
          },
          pageNameForNavigationMenu: {
            type: String,
            value: '',
            notify: true
          },
          expansionStatus: {
            type: Object,
            value: () => {
              let expansionStatus = localStorage.getItem('last-expansion-status');
              if (expansionStatus) {
                return JSON.parse(expansionStatus);
              } else {
                return {
                  people: false,
                  presets: false,
                  reportsAndGraphs: false,
                  records: false,
                  accounting: false
                };
              }
            }
          }
        };
      }

      static get template() {
        this.insertExternalTemplate(FxApp.template, '.super-class-insertion-point');
        this.insertExternalTemplate(FxDialogBehavior.template, '.super-class-insertion-point');
        return this.getOwnTemplate();
      }

      static get observers() {
        return [
          'selectedLanguageIdentifierChanged(selectedLanguageIdentifier)'
        ]
      }

      selectedLanguageIdentifierChanged(selectedLanguageIdentifier) {
        if (!selectedLanguageIdentifier) return;
        // PATCH-START for PolymerFx#FxDialogBehavior
        this.delay(0, () => {
          if (selectedLanguageIdentifier === 'bn-bd') {
            this.elem('#generic-modal-input [dialog-dismiss]').innerHTML = "বাতিল";
            this.elem('#generic-modal-input [dialog-confirm]').innerHTML = "ঠিক আছে";
            this.elem('#generic-modal-dialog [dialog-confirm]').innerHTML = "ঠিক আছে";
            this.elem('#generic-modal-confirmation [dialog-dismiss]').innerHTML = "বাতিল";
            this.elem('#generic-modal-confirmation [dialog-confirm]').innerHTML = "ঠিক আছে";
          } else {
            this.elem('#generic-modal-input [dialog-dismiss]').innerHTML = "Cancel";
            this.elem('#generic-modal-input [dialog-confirm]').innerHTML = "Okay";
            this.elem('#generic-modal-dialog [dialog-confirm]').innerHTML = "Okay";
            this.elem('#generic-modal-confirmation [dialog-dismiss]').innerHTML = "Cancel";
            this.elem('#generic-modal-confirmation [dialog-confirm]').innerHTML = "Okay";
          }
        });
        // PATCH-END
      }

      constructor() {
        super();
        this._initializeDatabase();
        this._fillDatabase();
        this._setUpDatabaseObservers();
        this._intializeServiceManager();
        this._manageProductionVariables();
        this.useLanguageServices();
        this.initiateLanguageServices();
        window.addEventListener('resize', () => this.updateInnerWidth());
        this.updateInnerWidth()
        this._notifyResizeHack();
        window.setTimeout(() => this._reportUrlHit(), 1000);
        window.setTimeout(() => this._initiateBackgroundSync(), backgroundSyncInitialDelay);
        // this.delay(5000, () => this._assertApiKey());
        this.delay(0, () => this.setDefaultExpansionIcons());
      }

      _assertApiKey() {
        if ('user' in this && this.user && 'apiKey' in this.user) {
          this.callUserAssertApiKeyApi({}, (err, response) => {
            if (err) return;
            if (response.hasError) return this.logoutTapped();
            let {
              apiKey,
              warning,
              sessionId,
              user
            } = response;
            Object.assign(user, {
              apiKey,
              warning,
              sessionId
            });
            this.saveUser(user);
          });
        }
        this.delay(30000, () => this._assertApiKey());
      }

      _notifyResizeHack() {
        // TODO: Find a better way of handling this issue.
        // [0, 100, 250, 500, 1000].forEach(timeout => {
        //   this.delay(timeout, () => this.elem('app-header-layout').notifyResize());
        // });
        let timeoutList = [0, 100, 250, 500, 1000];
        let counter = 10;
        const fn = () => {
          try {
            this.elem('app-header-layout').notifyResize();
          } catch (ex) {
            'pass';
          }
          if (!(counter--)) return; // Comment out in case the back button issue persists.
          let timeout = (timeoutList.length > 1) ? timeoutList.shift() : timeoutList[0];
          this.delay(timeout, fn);
        }
        fn();
      }

      _manageProductionVariables() {
        if (mode === 'production') {
          this.serverHost = 'https://single-server.lipi.live'
          this.jsonPostApiPathPrefix = 'https://single-server.lipi.live/api/';
          this.websocketHost = 'wss://single-server.lipi.live';
        } else {
          this.serverHost = 'http://localhost:8540'
          this.jsonPostApiPathPrefix = 'http://localhost:8540/api/';
          this.websocketHost = 'ws://localhost:8540';
        }
      }

      _initializeDatabase() {
        this.db = new atomicdb.Atomicdb({
          name: 'torqueMain',
          storageEngine: localStorage,
          serializationEngine: JSON,
          uniqueKey: 'idOnClient'
        });
        this.db.initializeDatabase();
        this.db.defineCollection({
          name: 'settings'
        });
        this.db.defineCollection({
          name: 'user'
        });
        this.db.defineCollection({
          name: 'organization'
        });
        this.db.defineCollection({
          name: 'offline-data'
        });
        this.db.defineCollection({
          name: 'previous-user'
        });
        this.db.defineCollection({
          name: 'previous-organization'
        });
      }

      _fillDatabase() {
        this.db.upsert('settings', (({
          which
        }) => which === 'only'), (doc => doc), {
          which: 'only',
          shouldUseWebsockets: true,
          monetaryUnit: 'BDT',
          defaultOutletMetaMap: {},
          defaultPrinterFormat: 'a4',
          ui: {}
        });

        this.db.upsert('offline-data', (({
          which
        }) => which === 'only'), (doc => doc), {
          which: 'only',
          offlineModeInitiatedDatetimeStamp: null,
          lastFetchedDatetimeStamp: null,
          cache: {
            getOutlet: null,
            getAggregatedInventoryDetails: null,
            getActiveServiceList: null,
            getUserDisplayInformation: null,
            getPaymentMethodList: null
          },
          data: {
            unsyncedSalesIdSeed: 0,
            unsyncedSalesList: []
          }
        });
      }

      _setUpDatabaseObservers() {
        this.db.observe('user', (...args) => this.onUserChange(...args));
        this.db.observe('organization', (...args) => this.onOrganizationChange(...args));
        this.db.observe('settings', (...args) => this.onSettingsChange(...args));
        this.db.observe('offline-data', (...args) => this.onOfflineDataChange(...args));
        this.onUserChange();
        this.onOrganizationChange();
        this.onSettingsChange();
        this.onOfflineDataChange();
      }

      networkErrorRetryTapped() {
        this.$['network-dialog'].close();

        // NOTE: We could use this.refreshCurrentPage
        // however, following is a safer bet since error
        // may occur during page load.
        // Regardless, user would have to reload the page
        // anyway.
        window.location.reload();
      }

      networkErrorGoToOfflineModeTapped() {
        this.$['network-dialog'].close();
        this.toggleOfflineMode();
      }

      increaseActiveServiceCount() {
        this.activeServiceCount += 1;
      }

      decreaseActiveServiceCount() {
        this.activeServiceCount = Math.max(this.activeServiceCount - 1, 0);
      }

      _intializeServiceManager() {
        this.serviceManager.on('service-change', (event) => {
          // NOTE: Previously event.detail.activeCount was used to show loading indicator.
        });
        this.serviceManager.on('error', (event) => {
          let shouldPromptForOfflineMode = true;
          try {
            if (event.path[0].url.indexOf('user-assert-api-key') > -1) {
              shouldPromptForOfflineMode = false;
            }
          } catch (ex) {
            'pass'
          }
          if (shouldPromptForOfflineMode) {
            this._patchForPolymerModalDialogIssue();
            this.$['network-dialog'].open();
          }
        });
        this.serviceManager.on('success', (event) => {
          'pass'
        });
        (window.torqueWebsocketIndicatorStatusReceivedFn = (status) => {
          if (!window.torqueMasterOptions.allowWebsockets || !this.settings.shouldUseWebsockets) {
            this.websocketConnectivityIndicatorIconName = 'http';
            return;
          }
          if (status === 'connected') {
            this.websocketConnectivityIndicatorIconName = 'cloud';
          } else if (status === 'error') {
            this.websocketConnectivityIndicatorIconName = 'error';
          } else if (status === 'closed') {
            this.websocketConnectivityIndicatorIconName = 'cloud-queue';
          } else if (status === 'success') {
            this.websocketConnectivityIndicatorIconName = 'cloud-done';
          } else if (status === 'failure') {
            this.websocketConnectivityIndicatorIconName = 'cloud-off';
          } else {
            this.websocketConnectivityIndicatorIconName = 'gif';
          }
        })('closed');
      }

      showToast(message, cbfn) {
        let el = this.elem('#generic-toast');
        el.text = message;
        el.open();
        this.delay(0, cbfn);
      }

      // ====================== geolocation dialog =============================

      displayGeolocationDialog(cbfn) {
        this._geolocationDialogCbfn = cbfn;
        this._patchForPolymerModalDialogIssue();
        this.elem('#geolocation-dialog').open();
      }

      geolocationDialogOkayTapped(e) {
        this.elem('#geolocation-dialog').close();
        this._geolocationDialogCbfn();
        this._geolocationDialogCbfn = null;
      }

      // ====================== navigation =============================

      _preparePageNameForNavigationMenu() {
        if (this.pageName === 'view-account-ledger') {
          if (window.location.href.indexOf('ACCOUNTS_PAYABLE') > -1) {
            this.pageNameForNavigationMenu = 'accounts-payable';
          } else if (window.location.href.indexOf('ACCOUNTS_RECEIVABLE') > -1) {
            this.pageNameForNavigationMenu = 'accounts-receivable';
          } else {
            this.pageNameForNavigationMenu = this.pageName;
          }
        } else {
          this.pageNameForNavigationMenu = this.pageName;
        }
      }

      _scrollCurrentPageToTop() {
        // Scroll to top on every page load
        let mainWrapper = this.elem('.main-iron-pages-wrapper');
        if (mainWrapper) mainWrapper.scrollTop = 0;
      }

      // Override default hash processing in polymer - start
      _onHashChange() {
        let hash = window.location.hash;

        this.hashQuery = {};
        if (hash.indexOf('?') > -1) {
          let parts = hash.split('?');
          hash = parts.shift();

          try {
            var vars = parts.join('?').split('&');
            for (var i = 0; i < vars.length; i++) {
              var pair = vars[i].split('=');
              this.hashQuery[String(pair[0])] = String(pair[1]);
            }
          } catch (ex) {
            'pass'
          }
        }

        if (hash.length < 2 || hash.indexOf('#/') !== 0) {
          window.location.hash = '#/';
          return;
        }

        hash = hash.replace('#/', '');
        let [pageName, ...rest] = hash.split('/')
        if (!pageName) {
          pageName = this.defaultPageName;
        }
        this.paramString = rest.join('/')
        baselib.delay(0, _ => {
          this._routePageChanged(pageName);
        });
      }
      // Override default hash processing in polymer - end

      _pageNameChanged() {
        this._scrollCurrentPageToTop();
        this.isFloatingAppDrawerExpanded = false;
        this._preparePageNameForNavigationMenu();
        this.initiateAppDrawerControls();
        if (this.isInOfflineMode) {
          const allowedPageNameList = [
            'login',
            'pos',
            'error404',
            'pos-select-products',
            'pos-select-services',
            'print-sales-receipt'
          ];
          if (allowedPageNameList.indexOf(this.pageName) === -1) {
            this.app = this;
            try {
              let settings = this._getNormalizedSettings();
              let defaultOutletMeta = settings.defaultOutletMetaMap[this.app.organization.id];
              let defaultOutletId = defaultOutletMeta.outletId;
              if (defaultOutletId) {
                this.navigateTo(`/pos/outlet:${defaultOutletId}`);
                return
              }
            } catch (ex) {
              // Organization is not loaded yet but somehow isInOfflineMode is true
              'pass'
            }
          }
        }
        let qualifiedName = 'page-' + this.pageName + '.html';
        let matchingEl = Array.from(localDocument.querySelectorAll('link[rel="lazy-import"]')).find(el => {
          return el.href.indexOf(qualifiedName) > -1;
        });
        // if (matchingEl) {
        //   qualifiedName = matchingEl.href;
        // }
        var resolvedPageUrl = this.resolveUrl(qualifiedName);
        const successFn = (...args) => {
          'pass'
        }
        const failureFn = (...args) => {
          if (mode === 'development') {
            console.log(`STATIC_ERROR/url=${resolvedPageUrl}`);
          }
          this.pageName = 'error404';
          // NOTE: At this point, there is no guarantee that any language *.json file has been loaded.
          // So, translation has to be manual.
          if (this.selectedLanguageIdentifier === 'bn-bd') {
            this.showAlertMessage("নেটওয়ার্ক নেই", "আপনার ইন্টারনেট সংযোগ বিচ্ছিন্ন হয়ে আছে।");
          } else {
            this.showAlertMessage("No Network", "Unable to connect to the internet.");
          }
        }
        this.highlightSelectedItemInLeftSidebar();
        Polymer.importHref(resolvedPageUrl, successFn, failureFn, true);
      }

      mainIronPagesIronSelected(e, details) {
        if (e.target.nodeName !== 'IRON-PAGES') return;
        if (!details.item) return;
        this._notifyPageSelect(details.item);
      }

      refreshCurrentPage() {
        this.activePageElement.onNavigateOut();
        this.activePageElement.onNavigateIn();
      }

      navigateToUrlWithoutHistory(url) {
        history.replaceState({}, "", '#' + url);
        this._onHashChange();
      }

      // ======================  events =============================

      toggleOfflineMode() {
        if (!this.offlineData || !this.offlineData.lastFetchedDatetimeStamp) {
          this.showAlertMessage(this.verses.general.errorMessageTitle, this.verses.root.unableToGoOffline);
          return;
        }
        let date = (this.isInOfflineMode ? null : Date.now())
        this.db.update('offline-data', (({ which }) => which === 'only'), data => {
          data.offlineModeInitiatedDatetimeStamp = date;
          return data;
        });

        // Try to reset any pending sales
        try {
          this.elem('page-pos')._resetSales();
        } catch (ex) { }

        // TODO: Refactor
        this.app = this;
        let settings = this._getNormalizedSettings();
        let defaultOutletMeta = settings.defaultOutletMetaMap[this.app.organization.id];
        let defaultOutletId = defaultOutletMeta.outletId;
        if (defaultOutletId) {
          this.navigateTo(`/pos/outlet:${defaultOutletId}`);
          return
        }
        this.navigateTo(`/home`);
      }

      websocketConnectivityIndicatorIconTapped(e = null) {
        this.settings.shouldUseWebsockets = !this.settings.shouldUseWebsockets;
        this.db.update('settings', ({
          which
        }) => which === 'only', (doc) => {
          doc.shouldUseWebsockets = this.settings.shouldUseWebsockets;
          return doc;
        });
        window.torqueWebsocketIndicatorStatusReceivedFn('closed');
      }

      logoutTapped(e = null) {
        this.callUserLogoutApi({}, (err, response) => {
          this.removeUser();
          this.removePreviousOrganization();
          window.sessionStorage.clear();
          this.navigateTo('/login');
          window.location.reload();
        });
      }

      languageIconTapped(e) {
        let languageIdentifier = e.target.getAttribute('data-key');
        this.delay(0, () => {
          if (this.getLastLoadedLanguage() === languageIdentifier) return;
          this.initiateLanguageServices(languageIdentifier);
        });
      }

      // ====================== delegated events =============================

      backButtonOnTopBarPressed(e) {
        if (this._proxyToActivePage('backButtonOnTopBarPressed', e)) return;
        this.navigateToPreviousUrl('/home');
      }

      saveButtonOnTopBarPressed(e) {
        this._proxyToActivePage('saveButtonOnTopBarPressed', e);
      }

      printButtonOnTopBarPressed(e) {
        this._proxyToActivePage('printButtonOnTopBarPressed', e);
      }

      // ====================== delegated callbacks =============================

      onFundamentalComponentChange() {
        let allComponentsReady = this.user && this.settings && this.organization;
        if (allComponentsReady) {
          this.shouldAttempBackgroundSync = true;
        } else {
          this.shouldAttempBackgroundSync = false;
        }
        this._proxyToActivePage('onFundamentalComponentChange', allComponentsReady);
      }

      onUserChange() {
        this.user = this.loadUser();
        this.onFundamentalComponentChange();
        this._proxyToActivePage('onUserChange', this.user);
      }

      onSettingsChange() {
        this.settings = this.loadSettings();
        this.onFundamentalComponentChange();
        this._proxyToActivePage('onSettingsChange', this.settings);
      }

      onOrganizationChange() {
        this.organization = this.loadOrganization();
        this.onFundamentalComponentChange();
        this._proxyToActivePage('onOrganizationChange', this.organization);
      }

      onOfflineDataChange() {
        this.offlineData = this.loadOfflineData();
        if (this.offlineData.offlineModeInitiatedDatetimeStamp) {
          this.isInOfflineMode = true;
        } else {
          this.isInOfflineMode = false;
        }
        this._proxyToActivePage('onOfflineDataChange', this.offlineData);

        // model = {
        //   which: 'only',
        //   offlineModeInitiatedDatetimeStamp: null,
        //   lastFetchedDatetimeStamp: null,
        //   cache: {
        //     getOutlet: null,
        //     getAggregatedInventoryDetails: null,
        //     getActiveServiceList: null,
        //     getUserDisplayInformation: null,
        //     getPaymentMethodList: null
        //   },
        //   data: {
        //     unsyncedSalesIdSeed: 0
        //     unsyncedSalesList: []
        //   }
        // }
      }

      // ====================== inventory container dialog =============================

      displayInventoryContainerDialog({ outletList, warehouseList }, cbfn) {
        if (outletList.length === 0 && warehouseList.length === 0) {
          return cbfn(null);
        } else if (outletList.length === 1 && warehouseList.length === 0) {
          return cbfn({ inventoryContainer: outletList[0], type: 'outlet' });
        } else if (outletList.length === 0 && warehouseList.length === 1) {
          return cbfn({ inventoryContainer: warehouseList[0], type: 'warehouse' });
        }

        this._inventoryContainerDialogCbfn = cbfn;
        this._outletList = outletList;
        this._warehouseList = warehouseList;

        this._patchForPolymerModalDialogIssue();
        this.elem('#inventory-container-dialog').open();
      }

      __callInventoryContainerCbfn(data) {
        this._inventoryContainerDialogCbfn(data);
        this._inventoryContainerDialogCbfn = null;
      }

      inventoryContainerDialogCancelTapped(e = null) {
        this.elem('#inventory-container-dialog').close();
        this.__callInventoryContainerCbfn(null);
      }

      inventoryContainerDialogSelectOutletTapped(e) {
        this.elem('#inventory-container-dialog').close();
        let { outlet } = e.model;
        this.__callInventoryContainerCbfn({ inventoryContainer: outlet, type: 'outlet' });
      }

      inventoryContainerDialogSelectWarehouseTapped(e) {
        this.elem('#inventory-container-dialog').close();
        let { warehouse } = e.model;
        this.__callInventoryContainerCbfn({ inventoryContainer: warehouse, type: 'warehouse' });
      }

      // ====================== product category dialog =============================

      displayCategoryDialog(categoryList, cbfn) {
        this._categoryDialogCbfn = cbfn;
        this._productCategoryList = categoryList;
        this._patchForPolymerModalDialogIssue();
        this.elem('#category-dialog').open();
      }

      categoryDialogCancelTapped(e = null) {
        this.elem('#category-dialog').close();
        this._categoryDialogCbfn(null);
        this._categoryDialogCbfn = null;
      }

      categoryDialogSelectTapped(e) {
        this.elem('#category-dialog').close();
        let { productCategory } = e.model;
        this._categoryDialogCbfn(productCategory);
        this._categoryDialogCbfn = null;
      }

      // ====================== receipt dialog =============================

      displayReceiptDialog({ canHaveEmailReceipt, canHaveSmsReceipt }, cbfn) {
        this._receiptDialogCanHaveEmailReceipt = canHaveEmailReceipt;

        this._receiptDialogCanHaveSmsReceipt = canHaveSmsReceipt;
        let isDesktop = this.isRunningOnDesktop();
        if (isDesktop) {
          this._receiptDialogCanHaveSmsReceipt = false;
        }

        this._receiptDialogCbfn = cbfn;
        this._patchForPolymerModalDialogIssue();
        this.elem('#receipt-dialog').open();
      }

      receiptDialogSmsReceiptTapped(e = null) {
        this.elem('#receipt-dialog').close();
        this._receiptDialogCbfn({ receiptType: 'sms-receipt' });
        this._receiptDialogCbfn = null;
      }

      receiptDialogEmailReceiptTapped(e = null) {
        this.elem('#receipt-dialog').close();
        this._receiptDialogCbfn({ receiptType: 'email-receipt' });
        this._receiptDialogCbfn = null;
      }

      receiptDialogPrintReceiptTapped(e = null) {
        this.elem('#receipt-dialog').close();
        this._receiptDialogCbfn({ receiptType: 'print-receipt' });
        this._receiptDialogCbfn = null;
      }

      receiptDialogNoReceiptTapped(e) {
        this.elem('#receipt-dialog').close();
        this._receiptDialogCbfn({ receiptType: 'no-receipt' });
        this._receiptDialogCbfn = null;
      }

      receiptDialogCloseTapped(e) {
        this.elem('#receipt-dialog').close();
        this._receiptDialogCbfn({ receiptType: 'close' });
        this._receiptDialogCbfn = null;
      }

      // ====================== shortcuts =============================

      homeTapped(e = null) {
        this.navigateTo('/home');
      }

      profileTapped(e = null) {
        this.navigateTo('/edit-profile');
      }

      settingsTapped(e = null) {
        this.navigateTo('/settings');
      }

      reloadTapped(e = null) {
        window.location.reload();
      }

      switchOrganizationTapped(e = null) {
        this.navigateTo('/manage-organizations/mode:switch')
      }

      // ====================== cacheStorage =============================

      storeInCache(key, value) {
        key = 'torque-cache--' + key;
        window.localStorage.setItem(key, JSON.stringify(value));
      }

      getFromCache(key) {
        key = 'torque-cache--' + key;
        let value = window.localStorage.getItem(key);
        return JSON.parse(value);
      }

      extractFromCache(key) {
        key = 'torque-cache--' + key;
        let value = window.localStorage.getItem(key);
        if (value) {
          window.localStorage.removeItem(key);
        }
        return JSON.parse(value);
      }

      // ====================== sessionStorage =============================

      storeInSession(key, value) {
        window.sessionStorage.setItem(key, JSON.stringify(value));
      }

      getFromSession(key) {
        let value = window.sessionStorage.getItem(key);
        return JSON.parse(value);
      }

      extractFromSession(key) {
        let value = window.sessionStorage.getItem(key);
        if (value) {
          window.sessionStorage.removeItem(key);
        }
        return JSON.parse(value);
      }

      // ====================== background Sync =============================

      _processBackgroundSync(cbfn) {
        if (!this.shouldAttempBackgroundSync) return cbfn(false);
        if (this.isInOfflineMode) return cbfn(false);
        this.app = this;
        let settings = this._getNormalizedSettings();
        let defaultOutletMeta = settings.defaultOutletMetaMap[this.app.organization.id];
        let defaultOutletId = defaultOutletMeta.outletId;
        if (this.$notSelected(defaultOutletId)) return cbfn(false);
        if (!defaultOutletMeta.allowBackgroundSync) return cbfn(false);

        const onApiError = (error) => {
          return cbfn(false);
        }

        const _backgroundSyncGetUserDisplayInformation = (cbfn) => {
          let data = {
            organizationId: this.organization.id,
            userId: this.user.id
          };
          data.shouldBlockUi = false;
          this.app.callGetUserDisplayInformationApi(data, (err, response) => {
            if (err) return;
            if (response.hasError) return onApiError(response.error);
            return cbfn(response);
          });
        }

        const _backgroundSyncGetOutlet = (outletId, cbfn) => {
          let data = { outletId };
          data.shouldBlockUi = false;
          this.app.callGetOutletApi(data, (err, response) => {
            if (err) return;
            if (response.hasError) return onApiError(response.error);
            return cbfn(response);
          });
        }

        const _backgroundSyncGetAggregatedInventoryDetailsApi = (inventoryId, cbfn) => {
          if (!this.hasModule('MOD_PRODUCT')) return cbfn(null);
          let data = { inventoryId, includeZeroCountProducts: false };
          data.shouldBlockUi = false;
          this.app.callGetAggregatedInventoryDetailsApi(data, (err, response) => {
            if (err) return;
            if (response.hasError) return onApiError(response.error);
            return cbfn(response);
          });
        }

        const _backgroundSyncGetActiveServiceListApi = (outletId, cbfn) => {
          if (!this.hasModule('MOD_SERVICE')) return cbfn(null);
          let data = { outletId };
          data.shouldBlockUi = false;
          this.app.callGetActiveServiceListApi(data, (err, response) => {
            if (err) return;
            if (response.hasError) return onApiError(response.error);
            return cbfn(response);
          });
        }

        const _backgroundSyncGetPaymentMethodListApi = (outletId, cbfn) => {
          let data = {
            organizationId: this.organization.id
          };
          data.shouldBlockUi = false;
          this.app.callGetPaymentMethodListApi(data, (err, response) => {
            if (err) return;
            if (response.hasError) return onApiError(response.error);
            return cbfn(response);
          });
        }

        _backgroundSyncGetOutlet(defaultOutletId, (getOutletResponse) => {
          let inventoryId = getOutletResponse.defaultInventory.id;
          _backgroundSyncGetAggregatedInventoryDetailsApi(inventoryId, (getAggregatedInventoryDetailsResponse) => {

            _backgroundSyncGetPaymentMethodListApi(defaultOutletId, (getPaymentMethodListResponse) => {
              _backgroundSyncGetActiveServiceListApi(defaultOutletId, (getActiveServiceListResponse) => {
                _backgroundSyncGetUserDisplayInformation((getUserDisplayInformationResponse) => {

                  this.db.update('offline-data', (({ which }) => which === 'only'), data => {
                    data.lastFetchedDatetimeStamp = Date.now();
                    data.cache.getOutlet = getOutletResponse;
                    data.cache.getAggregatedInventoryDetails = getAggregatedInventoryDetailsResponse;
                    data.cache.getActiveServiceList = getActiveServiceListResponse;
                    data.cache.getPaymentMethodListResponse = getPaymentMethodListResponse;

                    data.cache.getUserDisplayInformation = getUserDisplayInformationResponse;
                    return data;
                  });
                  return cbfn(true);

                });
              });
            });
          });
        });

      }

      _reportUrlHit() {
        let name = null;
        if (window.location.href.indexOf('app.lipi.live') > -1) {
          if (window.hasOwnProperty("cordova")) {
            name = 'app.lipi.live android';
          } else if (this.pageName === 'register') {
            let ref = null;
            if ('ref' in this.hashQuery) {
              ref = this.hashQuery['ref'];
            }

            if (ref === 'fb') {
              name = 'app.lipi.live/register?ref=fb';
            } else if (ref === 'ln') {
              name = 'app.lipi.live/register?ref=ln';
            } else if (ref === 'mail') {
              name = 'app.lipi.live/register?ref=mail';
            } else if (ref === 'lipi') {
              name = 'app.lipi.live/register?ref=lipi';
            } else {
              name = 'app.lipi.live/register';
            }

          } else {
            name = 'app.lipi.live';
          }
        }

        if (!name) return;
        try {
          this.callAnalyticsReportUrlHitApi({ name }, (err, response) => { 'pass' });
        } catch (ex) {
          'pass'
        }
      }

      _initiateBackgroundSync() {
        this._processBackgroundSync((wasDone) => {
          window.setTimeout(() => this._initiateBackgroundSync(), backgroundSyncInterval);
        });
      }

      // ====================== app drawer =============================

      initiateAppDrawerControls() {
        // NOTE: below is necessary to maintain compatibility
        // with polymer.
        this.$.drawer = {
          close() { },
          persistent: true
        }
      }

      customAppDrawerStyle(user, organization, isFloatingAppDrawerExpanded, innerWidth, isInOfflineMode) {
        let str = 'display: ';
        if (!user) {
          str += 'none';
        } else if (!organization) {
          str += 'none';
        } else if (isInOfflineMode) {
          str += 'none';
        } else if (innerWidth < 960 && !isFloatingAppDrawerExpanded) {
          str += 'none';
        } else {
          str = 'block';
        }
        str += ';';
        return str;
      }

      customAppDrawerWrapperTapped(e) {
        this.isFloatingAppDrawerExpanded = false;
      }

      customAppDrawerTapped(e) {
        e.stopPropagation();
      }

      topNavHamburgerTapped(e) {
        this.isFloatingAppDrawerExpanded = !this.isFloatingAppDrawerExpanded
      }

      // ====================== utilities =============================

      updateInnerWidth() {
        this.innerWidth = window.innerWidth;
      }

      showAlertMessage(...args) {
        this.showModalDialog.apply(this, args);
      }

      $invisibleUnless(condition) {
        if (!condition) {
          return 'visibility:hidden; '
        } else {
          return '';
        }
      }

      _proxyToActivePage(methodName, ...args) {
        if (this.activePageElement && (methodName in this.activePageElement)) {
          this.activePageElement[methodName](...args);
          return true;
        }
        return false;
      }

      $getLanguageClass(selectedLanguageIdentifier, languageIdentifier) {
        if (selectedLanguageIdentifier === languageIdentifier) {
          return 'language-active';
        }
        return '';
      }

      buildNumberTapped(e = null) {
        this.showAlertMessage("Build Details", "Released on: " + new Date(this.__deploy.datetimeStamp));
      }

      $computePageTitleFontSize(length) {
        let title = this.$getPageTitle(length) || "Lipi";
        let size = 18;
        let windowWidth = window.document.body.clientWidth;
        if (windowWidth <= 496) {
          if (title.length < 20) size = 18;
          else if (title.length < 30) size = 16;
          else size = 12;
        }
        return `font-size: ${size}px`;
      }

      $hasEitherPrivilege(priv1, priv2, organization) {
        try {
          return this.hasPrivilege(priv1, organization) || this.hasPrivilege(priv2, organization);
        } catch (ex) { }
      }

      // NOTE: We had to duplicate it since this.app is not defined in
      // torque-app.
      hasPrivilege(privilege) {
        if (!(this.organization && this.organization.employment)) {
          return false;
        }

        if (!(privilege in this.organization.employment.privileges)) {
          throw new Error(`No such privilege "${privilege}".`);
        }
        return this.organization.employment.privileges[privilege];
      }

      accountsReceivableTapped() {
        this.navigateTo('/view-account-ledger/codeName:ACCOUNTS_RECEIVABLE');
        if (this.pageName === 'view-account-ledger') {
          this._preparePageNameForNavigationMenu();
          setTimeout(() => {
            this.refreshCurrentPage();
            this._scrollCurrentPageToTop();
            this.highlightSelectedItemInLeftSidebar();
          }, 1);
        }
      }

      accountsPayableTapped() {
        this.navigateTo('/view-account-ledger/codeName:ACCOUNTS_PAYABLE');
        if (this.pageName === 'view-account-ledger') {
          this._preparePageNameForNavigationMenu();
          setTimeout(() => {
            this.refreshCurrentPage();
            this._scrollCurrentPageToTop();
            this.highlightSelectedItemInLeftSidebar();
          }, 1);
        }
      }

      // =================================

      highlightSelectedItemInLeftSidebar() {
        this.elemAll('.custom-app-drawer a').forEach(el => {
          try {
            el.classList.remove('iron-selected');
          } catch (ex) { }
        });

        try {
          let el = this.elem(`.custom-app-drawer a[name="${this.pageNameForNavigationMenu}"]`);
          el.classList.add('iron-selected');
        } catch (ex) { }
      }

      setDefaultExpansionIcons() {
        let list = this.elemAll('.expansion-title').forEach(el => {
          let key = el.getAttribute('data-key');

          el.querySelector('iron-icon').classList.remove('rotate-f');
          el.querySelector('iron-icon').classList.remove('rotate-b');
          if (this.expansionStatus[key]) {
            el.querySelector('iron-icon').classList.add('rotate-f');
          } else {
            el.querySelector('iron-icon').classList.add('rotate-b');
          }
        });
      }

      expansionTitleTapped(e) {
        let el = e.target;
        if (el.nodeName === 'IRON-ICON') {
          el = el.parentNode;
        }

        let key = el.getAttribute('data-key');
        this.set(`expansionStatus.${key}`, !this.expansionStatus[key]);

        localStorage.setItem('last-expansion-status', JSON.stringify(this.expansionStatus));

        el.querySelector('iron-icon').classList.remove('rotate-f');
        el.querySelector('iron-icon').classList.remove('rotate-b');
        if (this.expansionStatus[key]) {
          el.querySelector('iron-icon').classList.add('rotate-f');
        } else {
          el.querySelector('iron-icon').classList.add('rotate-b');
        }
      }

      $getExpansionContentClass(key) {
        if (key) {
          return '';
        } else {
          return ' expansion-content-collapsed';
        }
      }

    }

    window.customElements.define(TorqueApp.is, TorqueApp);
  </script>
</dom-module>
