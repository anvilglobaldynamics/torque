<script>

  (function () {
    if (window.TorqueCommonBehavior) return;
    /* @polymerMixin */
    TorqueCommonBehavior = (SuperClass) => class extends SuperClass {

      constructor(...args) {
        super(...args);
      }

      genericEmbeddedFormSubmitionKeypress(e) {
        if (e.which !== 13) return;
        if (e.target.nodeName !== 'PAPER-INPUT') return;
        let el = e.target;
        while (el && el.parentNode) {
          el = el.parentNode;
        }
        el = el.host;
        while (el && el.nodeName !== 'IRON-FORM') {
          el = el.parentNode;
        }
        if (!el) return;
        el.querySelectorAll(`.${el.id}--submit`).forEach(submitEl => {
          if (submitEl) {
            if (submitEl.className.indexOf("hidden") > -1) return;
            submitEl.click();
          }
        });
      }

      $join(list, by) {
        return list.join(by);
      }

      $if(condition, thenValue, elseValue) {
        if (condition) return thenValue;
        return elseValue;
      }

      delay(ms, fn, ...args) {
        window.setTimeout(fn, ms, ...args);
      }

      $json(obj) {
        return (JSON.stringify(obj));
      }

      $round(number) {
        const epsilon = 0.0000000000000001;
        number = (number || 0) + epsilon;
        return (Math.round(number * 100) / 100);
      }

      /** $mkDate()
       * Converts a date to a user friendly string
       * See http://arshaw.com/xdate/ for formatting instruction
       * @param {Date|timestamp} date
       * @param {string} format 
       * @returns 
       */
      $mkDate(date, format = 'MMM d, yyyy') {
        if (date) {
          try {
            return (new XDate(date)).toString(format);
          } catch (ex) {
            console.error(ex);
            return 'INVALID DATE';
          }
        }
      }

      $inc(number) {
        return number + 1;
      }

      enforceMinMaxOnPaperInput(e) {
        try {
          let el = e.target;

          if (typeof (el.value) === 'undefined' || el.value === '') {
            el.value = String(el.min);
          }

          if (typeof (el.max) !== 'undefined') {
            if (parseFloat(el.value) > parseFloat(el.max)) {
              el.value = String(el.max);
            }
          }

          if (typeof (el.min) !== 'undefined') {
            if (parseFloat(el.value) < parseFloat(el.min)) {
              el.value = String(el.min);
            }
          }

        } catch (err) {
          console.error(err);
        }
      }

      ensureModule(...moduleCodeClauseList) {
        let organization, showModalDialog;
        try {
          organization = this.organization || this.app.organization || this.page.app.organization;
          showModalDialog = this.showModalDialog || this.app.showModalDialog || this.page.app.showModalDialog;
        } catch (ex) {
          'pass'
        }
        if (!organization) {
          console.warn(new Error("DEV_ERROR unable to locate organization object"))
          return true;
          // return false;
        }
        if (!('activeModuleCodeList' in organization)) {
          // TRANSLATE
          showModalDialog("Your organization has no modules activated. Please contact support.");
          return false;
        }

        let err = null;
        const didAnyPass = moduleCodeClauseList.some(moduleCodeClause => {
          let innerErr = null;
          moduleCodeClause.split('+').forEach(moduleCode => {
            const isModuleActivated = (organization.activeModuleCodeList.includes(moduleCode));
            if (!isModuleActivated) {
              // This message is not shown to client.
              innerErr = new Error(`This feature requires "${moduleCode}" module which is not activated for this organization.`);
              innerErr.code = 'UNMET_MODULE';
              innerErr.module = moduleCode;
              innerErr.moduleCodeClause = moduleCodeClause;
            }
          });
          if (innerErr) {
            err = innerErr;
            return false;
          }
          return true;
        });

        if (!didAnyPass) {
          if (!err) {
            err = new Error("Invalid arguments for ensureModule().");
          }
          throw err;
        }

        return true;
      }

      hasModule(...moduleCodeClauseList) {
        try {
          return this.ensureModule(...moduleCodeClauseList);
        } catch (ex) {
          if (ex.code === 'UNMET_MODULE') {
            return false;
          }
          throw ex;
        }
      }

      hasModuleWithOrganization(organization, ...moduleCodeClauseList) {
        try {
          return this.ensureModule(...moduleCodeClauseList);
        } catch (ex) {
          if (ex.code === 'UNMET_MODULE') {
            return false;
          }
          throw ex;
        }
      }

      _getNormalizedSettings() {
        let settings = this.app.db.find('settings', (({
          which
        }) => which === 'only'))[0];

        if (!settings.defaultPrinterFormat) {
          settings.defaultPrinterFormat = 'a4';
        }

        if (!settings.defaultOutletMetaMap) {
          settings.defaultOutletMetaMap = {};
        }
        if (!this.app.organization) {
          throw new Error("Organization is not loaded!");
        }
        if (!(this.app.organization.id in settings.defaultOutletMetaMap)) {
          settings.defaultOutletMetaMap[this.app.organization.id] = {
            outletId: null,
            allowBackgroundSync: false,
            bypassHomepage: false
          };
        }
        return settings;
      }

      $notSelected(val) {
        return (typeof (val) === 'undefined' || val === null || val < 0);
      }

      $subtract(a, b) { return a - b }

      _paginateOfflineData(list) {
        let { limit, offset } = this.paginate;
        let totalCount = list.length;

        list = list.slice(offset, (offset + limit));

        return [list, {
          offset,
          limit: list.length,
          totalCount
        }];
      }

    }
  })();

</script>